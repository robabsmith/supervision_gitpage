
```{r sfc-fi-fl-setup}
danish_model_data_path <- "./Data/sfc-fi-fl/Danish_Model/model_output_data"
danish_model_lists_path <- "./Data/sfc-fi-fl/Danish_Model/variable_lists"
data_path <- "./Data/sfc-fi-fl/Raw_data"
data_tables_path <- "./Data/sfc-fi-fl/Tables"

# Import Transactions flow matrix
sfc_fi_fl_TFM_data <- as.matrix(read_delim(file.path(data_tables_path,"sfc_fi_fl_TFM.csv"), delim = ";",col_names = FALSE))
colnames(sfc_fi_fl_TFM_data) <- NULL

# Import Balance sheet matrix
sfc_fi_fl_BS_data <- as.matrix(read_csv(file.path(data_tables_path,"sfc_fi_fl_BS.csv"), col_names=FALSE))
colnames(sfc_fi_fl_BS_data) <- NULL

# Import Revaluations matrix
sfc_fi_fl_BS_reval_data <- read_delim(file.path(data_tables_path,"sfc_fi_fl_BS_reval.csv"), delim = ";")

# Import aggregations table
eurostat_aggregation <- as.matrix(read_csv(file.path(data_tables_path,"eurostat_aggregation.csv"), col_names=FALSE))
colnames(eurostat_aggregation) <- NULL

##################################################################################
# Read data
##################################################################################

model_data_raw <- data.table(read_csv(file.path(danish_model_data_path,"scenario - 2 pct.csv")))
names(model_data_raw)[1] <- "Date"

model_data_raw_num <- model_data_raw %>%
  replace(is.na(.), 0)

model_data_diff_raw <- model_data_raw %>%
    mutate_at(vars(-Date), function(x) 
        x - lag(x))

model_data_roc_raw <- model_data_raw %>%
    mutate_at(vars(-Date), function(x) 
        (x - lag(x))/lag(x))

variable_descriptions <- data.table(read_csv(file.path(danish_model_lists_path,"variable_descriptions.csv")))

variable_list <- data.table(read_delim(file.path(danish_model_lists_path,"variable_list.csv"), delim = ";"))

sector_patterns = c("_H", "_F", "_NF", "_G","_ROW", "_DK", "_EU")
scenario_patterns = c("_0", "_1", "_2", "_3", "_4")
price_type_patterns = c("_K")
transaction_patterns = c("_RV", "_TR")
interest_patterns = c("_FI", "_FL")

List_of_variables_to_print <- read_excel(file.path(data_path, "variablestoprint.xlsx"))


###################################################################################
# Quarterly Danish house price index
###################################################################################

# DK House Price Index.dbf
HPI <- read.dbf(file.path(data_path,"DK House Price Index.dbf"), as.is = TRUE)
HPI <- data.table(HPI)
colnames(HPI) <-c("Trans_type", "Urbanisation", "time","value")

HPI <- mutate_if(HPI, is.character, str_replace_all, pattern="Q1", replacement = "-01-01")
HPI <- mutate_if(HPI, is.character, str_replace_all, pattern="Q2", replacement = "-04-01")
HPI <- mutate_if(HPI, is.character, str_replace_all, pattern="Q3", replacement = "-07-01")
HPI <- mutate_if(HPI, is.character, str_replace_all, pattern="Q4", replacement = "-10-01")

HPI$time <- as.Date(HPI$time)


# Regional and National prices

property_prices_regional_quarterly_raw <- read.dbf(file.path(data_path,"DK property prices quarterly - Regions.dbf"), as.is = TRUE)
colnames(property_prices_regional_quarterly_raw) <-c("Data_type", "Prop_type", "Region",
                                                     format(as.Date(c(seq(as.Date("1992-01-01"), 
                                                                              by="quarter", 
                                                                              length.out = 109)), 
                                                                origin = "1992-01-01")))

property_prices_regional_quarterly_raw <- melt(property_prices_regional_quarterly_raw, id.vars = c("Data_type", "Prop_type", "Region"))


colnames(property_prices_regional_quarterly_raw) <- c("Data_type", "Prop_type", "Region", "Date", "Price")

property_prices_regional_quarterly_raw$Date <- as.Date(property_prices_regional_quarterly_raw$Date)

Reg_RZ_name_q <- property_prices_regional_quarterly_raw %>%
    filter(Region!="All Denmark",
           Region!="Region Syddanmark",
           Region!="Region Midtjylland",
           Region!="Region Nordjylland",
           Region!="Region Hovedstaden") %>%
    distinct(Region)
Reg_RZ_name_q <- as.character(Reg_RZ_name_q)

Region_e <- c("All Denmark",
              "Region Zealand", 
              "South Denmark Region", 
              "Central Denmark Region",
              "North Denmark Region", 
              "Capital Region")
Region <- c("All Denmark",
            Reg_RZ_name_q, 
            "Region Syddanmark",
            "Region Midtjylland",
            "Region Nordjylland",
            "Region Hovedstaden")

region_table <- data.frame(Region, Region_e)

property_prices_regional_quarterly <- property_prices_regional_quarterly_raw %>%
    full_join(., region_table, by = "Region") %>%
    mutate(Region = Region_e) %>%
    select(-Region_e)

##################################################################################
# Source data from Danmarks Statistik
##################################################################################
    
Benefits <- sdk_retrieve_data("ESSPROS1")
Benefits <- Benefits %>%
    mutate(FORANSTALT = str_replace_all(FORANSTALT, pattern = "\\. ", " ")) %>%
    mutate(FORANSTALT = str_replace_all(FORANSTALT, pattern = " n.e.c.", "")) %>%
    mutate(FORANSTALT = str_replace_all(FORANSTALT, pattern = " ", "_")) %>%
    mutate(FORANSTALT = str_replace_all(FORANSTALT, pattern = "/", "_")) %>%
    mutate(FORANSTALT = str_replace_all(FORANSTALT, pattern = "\\.", "-")) %>%
    mutate(FORANSTALT = paste0("Cat_", FORANSTALT),
           INDHOLD = as.numeric(INDHOLD))

# Create lists of unique components of each of the id variables
FORANSTALT <- data.table(unique(Benefits$FORANSTALT))
YDELSESTYPE <- data.table(unique(Benefits$YDELSESTYPE))
TID <- data.table(unique(Benefits$TID))

Totals <- data.table(c(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_1_")], 
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_2_")],
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_3_")],
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_4_")],
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_5_")],
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_6_")],
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_7_")],
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_8_")],
                     FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_Sch")]))

# These are the underlying subcomponent groups, same as above
FORANSTALT_SICKNESS_HEALTH_CARE <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_1")])
FORANSTALT_DISABILITY <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_2")])
FORANSTALT_OLD_AGE <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_3")])
FORANSTALT_SURVIVORS <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_4")])
FORANSTALT_FAMILY_CHILDREN <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_5")])
FORANSTALT_UNEMPLOYMENT <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_6")])
FORANSTALT_HOUSING <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_7")])
FORANSTALT_SOCIALE_EXCLUSION <- data.table(FORANSTALT$V1[str_detect(FORANSTALT$V1, pattern = "^Cat_8")])


##################################################################################
# Read historical data
##################################################################################
country_codes <- read_excel(file.path(data_path,"Country codes 2 letter 3 letter.xlsx"))

National_bank_rates <-read_excel(file.path(data_path,"Danish official interest rates.xlsx"))
National_bank_rates <- National_bank_rates %>%
  mutate(Date = as.Date(Date,format='%d/%m/%Y')) %>%
  gather(-c(Date), key = Rate, value = Values)
  

# historical_data_raw <- read_excel(file.path(data_path,"JSTdatasetR4.xlsx"), sheet = "Data")
# historical_data_raw <- historical_data_raw %>%
#     left_join(., country_codes, by = "iso")
# 
# # Source Non-financial transactions data
# nf_tr <- get_eurostat(id = "nasa_10_nf_tr",  time_format = "num")
# gdp_esa_95 <- get_eurostat(id = "namq_gdp_k",  time_format = "num")
# 
# Yd_h_data <- nf_tr %>%
#     filter(unit == "CP_MNAC",
#            na_item == "B6G", 
#            direct == "RECV",
#            values != 0,
#            sector == "S14") %>%
#     arrange(geo, sector, time) %>%
#     mutate(Yd_hh = values,
#            year = time,
#            geo = as.character(geo)) %>%
#     select(-unit, -values, -na_item, -direct, -time, -sector)
# 
# 
# 
# historical_data <- historical_data_raw %>%
#     select(-country, -iso) %>%
#     left_join(., Yd_h_data, by = c("geo", "year"))
# 
# 
# 
# write.csv2(historical_data, file.path(data_path,"historical_data_yd.csv"))
historical_data <- read.csv2(file.path(data_path,"historical_data_yd.csv"))
historical_data <- historical_data[,-1]
# Problems: 
# =========
# P_KCG
# LOG(...)
# CHECK_TRA_...
# CHECK_IBTR

##################################################################################
# OECD house prices
##################################################################################
# 
# # Step 1: Search for a phrase in the OECD database that might match the table or description of the table you are looking for
# 
# # search_dataset("house price", data = get_datasets(), ignore.case = TRUE)
# 
# # This search returns just one table, id = "HOUSE_PRICES" title = "Analytical house prices indicators"
# 
# # OECD_house_price_raw <- get_dataset("HOUSE_PRICES")
# 
# # Check the structure of the data that you have just downloaded, and what each of the unique values are for each column (except the values column, there will be thousands of unique values there.)
# 
# # str(OECD_house_price_direct)
# 
# # unique(OECD_house_price_direct$COU)
# # unique(OECD_house_price_direct$IND)
# # unique(OECD_house_price_direct$TIME_FORMAT)
# # unique(OECD_house_price_direct$UNIT)
# # unique(OECD_house_price_direct$POWERCODE)
# # unique(OECD_house_price_direct$obsTime)
# 
# OECD_house_prices_data <- OECD_house_price_raw %>%
#     filter(
#         IND == "RPI",         # for "real house price index"
#         TIME_FORMAT == "P1Y", # for annual based data
#         UNIT == "IDX",        # for a indexed values
#         !nchar(obsTime,) > 4,
#         COU != "TUR"
#     ) %>%
#     mutate(iso = COU) %>%
#     select(iso, obsTime, obsValue) # remove all the unnecessary columns that you have just filtered to just one type
# 
# OECD_rebase <- OECD_house_prices_data %>%
#     filter(obsTime == 2000) %>%
#     mutate(rebase = obsValue) %>%
#     select(iso, rebase)
# 
# 
# 
# 
# OECD_house_prices <- OECD_house_prices_data %>%
#     left_join(., OECD_rebase, by = "iso") %>%
#     mutate(Values = (obsValue / rebase) * 100) %>%
#     select(-rebase, -obsValue) %>%
#     left_join(., country_codes, by = "iso") %>%
#     mutate(Country = COUNTRY) %>%
#     select(-iso, -COUNTRY) %>%
#     filter(!is.na(Values),
#            !is.na(geo))

# write.csv(OECD_house_prices, file.path(data_path,"OECD_house_price_data.csv"))

OECD_house_prices <- read_csv(file.path(data_path, "OECD_house_price_data.csv"))
OECD_house_prices <- OECD_house_prices[,-1]


OECD_proportion_shift <- OECD_house_prices %>%
    filter(obsTime == 2000 | obsTime == 2007 | obsTime == 2009 | obsTime == 2018) %>%
    spread(key = obsTime, value = Values) %>%
    mutate("2000 to 2007" = ((.[[4]] - .[[3]])/.[[3]])/6,
           "2007 to 2009" = ((.[[5]] - .[[4]])/.[[4]])/2,
           "2009 to 2018" = ((.[[6]] - .[[5]])/.[[5]])/10) %>%
    select(-c("2000", "2007", "2009", "2018")) %>%
    mutate(Growth = ifelse(.[[5]] > 0.015, "High growth (over 1.5\\%)","Low growth (below 1.5\\%)")) %>%
    gather(-c(Country, geo, Growth), key = obsTime, value = Values)
    
variable_list = data.table(colnames(model_data_raw)) %>%
  distinct() %>%
  mutate(Variable_name = (str_to_upper(.[[1]]))) %>%
  select(Variable_name) %>%
  filter(Variable_name != "DATE")
  
##################################################################################
# Prepare variable key
##################################################################################
variable_key <- variable_list %>%
    distinct() %>%
    mutate(Interest_type = ifelse(str_detect(Variable_name,pattern = "_FI")==TRUE, "Fixed",
                                     ifelse(str_detect(Variable_name,pattern = "_FL")==TRUE, "Flexible",
                                            ""))) %>%
    mutate(Variable = str_remove_all(Variable_name, 
                                     regex(str_c(interest_patterns, 
                                                 collapse = '|'), 
                                           ignore_case = T))) %>%
    mutate(Sector = ifelse(str_detect(Variable,pattern = "_F_H")==TRUE, "FC",
                           ifelse(str_detect(Variable,pattern = "_H")==TRUE, "HH",
                                  ifelse(str_detect(Variable,pattern = "_F")==TRUE, "FC",
                                         ifelse(str_detect(Variable,pattern = "_NF")==TRUE, "NFC",
                                                ifelse(str_detect(Variable,pattern = "_G")==TRUE, "GOV",
                                                       ifelse(str_detect(Variable,pattern = "_ROW")==TRUE, "ROW",
                                                              ifelse(str_detect(Variable,pattern = "_DK")==TRUE, "DK",
                                                                     ifelse(str_detect(Variable,pattern = "_EU")==TRUE, "EU",
                                                              ""))))))))) %>%
    mutate(Dependent_sector = ifelse(str_detect(Variable,pattern = "_F_H")==TRUE, "HH","")) %>%
    mutate(Variable = str_remove_all(Variable, 
                                          regex(str_c(sector_patterns, 
                                                      collapse = '|'), 
                                                ignore_case = T))) %>%
    mutate(Scenario = ifelse(str_detect(Variable,pattern = "_0")==TRUE, "Baseline",
                           ifelse(str_detect(Variable,pattern = "_1")==TRUE, "Scenario 1",
                                  ifelse(str_detect(Variable,pattern = "_2")==TRUE, "Scenario 2",
                                         ifelse(str_detect(Variable,pattern = "_3")==TRUE, "Scenario 3",
                                                ifelse(str_detect(Variable,pattern = "_4")==TRUE, "Scenario 4",
                                                       ifelse(str_detect(Variable,pattern = "_5")==TRUE, "Scenario 5",
                                                              ifelse(str_detect(Variable,pattern = "_6")==TRUE, "Scenario 6",
                                         "")))))))) %>%
    mutate(Variable = str_remove_all(Variable, 
                                          regex(str_c(scenario_patterns, 
                                                      "\\b",
                                                      collapse = '|'), 
                                                ignore_case = T))) %>%
    mutate(Price_type = ifelse(str_detect(Variable,pattern = "_K")==TRUE, "Real prices",
                               "")) %>%
    mutate(Variable = str_remove_all(Variable, 
                                          regex(str_c(price_type_patterns, 
                                                      collapse = '|'), 
                                                ignore_case = T))) %>%
    mutate(Transaction_type = ifelse(str_detect(Variable,pattern = "_RV")==TRUE, "Revaluations",
                             ifelse(str_detect(Variable,pattern = "_TR")==TRUE, "Transactions",
                                    ""))) %>%
    mutate(Variable = str_remove_all(Variable, 
                                     regex(str_c(transaction_patterns, 
                                                 "\\b",
                                                 collapse = '|'), 
                                           ignore_case = T)))%>%
    arrange(Variable) %>%
    mutate(Variable = str_to_upper(Variable))%>%
    mutate(Variable_name = str_to_upper(Variable_name)) %>%
    left_join(., variable_descriptions, by = "Variable") %>%
    mutate(Type = ifelse(Transaction_type == "", yes = Type, no = "Flow")) %>%
    mutate(Type = case_when(is.na(Type) ~ "", TRUE ~ as.character(Type)))
           
    write_csv(variable_key,(file.path(danish_model_lists_path, "variable_list_detailed.csv")))
     
##################################################################################
# Prepare model data
##################################################################################

model_data <- model_data_raw %>%
    gather(-Date, key = Variable_name, value = Value) %>%
    mutate(Variable_name = str_to_upper(Variable_name)) %>%
    full_join(., variable_key, by = "Variable_name") %>%
    mutate(Variable = str_replace_all(Variable, pattern ="_", "-"),
           Price_type = case_when(is.na(Price_type) ~ "", 
                                  TRUE ~ as.character(Price_type)),
           Transaction_type = case_when(is.na(Transaction_type) ~ "", 
                                        TRUE ~ as.character(Transaction_type)),
           Sector = case_when(is.na(Sector) ~ "", TRUE ~ as.character(Sector)),
           Value = case_when(is.na(Value) ~ 0, TRUE ~ as.numeric(Value)))

model_data_yoy_diff <- model_data_diff_raw %>%
    gather(-Date, key = Variable_name, value = Value) %>%
    mutate(Variable_name = str_to_upper(Variable_name)) %>%
    full_join(., variable_key, by = "Variable_name") %>%
    mutate(Variable = str_replace_all(Variable, pattern ="_", "-"),
           Price_type = case_when(is.na(Price_type) ~ "", 
                                  TRUE ~ as.character(Price_type)),
           Transaction_type = case_when(is.na(Transaction_type) ~ "", 
                                        TRUE ~ as.character(Transaction_type)),
           Sector = case_when(is.na(Sector) ~ "", TRUE ~ as.character(Sector)),
           Value = case_when(is.na(Value) ~ 0, TRUE ~ as.numeric(Value)))

model_data_yoy_roc <- model_data_roc_raw %>%
    gather(-Date, key = Variable_name, value = Value) %>%
    mutate(Variable_name = str_to_upper(Variable_name)) %>%
    full_join(., variable_key, by = "Variable_name") %>%
    mutate(Variable = str_replace_all(Variable, pattern ="_", "-"),
           Price_type = case_when(is.na(Price_type) ~ "", 
                                  TRUE ~ as.character(Price_type)),
           Transaction_type = case_when(is.na(Transaction_type) ~ "", 
                                        TRUE ~ as.character(Transaction_type)),
           Sector = case_when(is.na(Sector) ~ "", TRUE ~ as.character(Sector)),
           Value = case_when(is.na(Value) ~ 0, TRUE ~ as.numeric(Value)))

# Calculate raw data with difference from Baseline


model_data_baseline_diff_raw <- model_data %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario ", replacement = "Scenario_")) %>%
    mutate_at(vars(Scenario), na_if,"") %>%
    mutate(Scenario = case_when(is.na(Scenario) ~ "Actual_initial", TRUE ~ as.character(Scenario))) %>%
    select(-Variable_name) %>%
    spread(., value = Value,  key = Scenario) %>%
    mutate(Baseline = case_when(is.na(Baseline) ~ Actual_initial,
                                  Baseline == 0 ~ Actual_initial, 
                                  TRUE ~ as.numeric(Baseline)),
           Scenario_1 = case_when(is.na(Scenario_1) ~ Baseline,
                                  Scenario_1 == 0 ~ Baseline, 
                                  TRUE ~ as.numeric(Scenario_1)),
           Scenario_2 = case_when(is.na(Scenario_2) ~ Baseline, 
                                  Scenario_2 == 0 ~ Baseline, 
                                  TRUE ~ as.numeric(Scenario_2)),
           Scenario_3 = case_when(is.na(Scenario_3) ~ Baseline,
                                  Scenario_3 == 0 ~ Baseline, 
                                  TRUE ~ as.numeric(Scenario_3)),
           Scenario_4 = case_when(is.na(Scenario_4) ~ Baseline,
                                  Scenario_4 == 0 ~ Baseline, 
                                  TRUE ~ as.numeric(Scenario_4))) %>%
  
    mutate(Scenario_1_diff = Scenario_1 - Baseline) %>%
    mutate(Scenario_2_diff = Scenario_2 - Baseline) %>%
    mutate(Scenario_3_diff = Scenario_3 - Baseline) %>%
    mutate(Scenario_4_diff = Scenario_4 - Baseline) %>%
  
    mutate(Scenario_1_diff_perc = case_when(is.na(Baseline) ~ 0,
                                            Baseline == 0 ~ 0,
                                            Baseline != 0 ~ (Scenario_1 - Baseline)/abs(Baseline),
                                            TRUE ~ 0)) %>%
    mutate(Scenario_2_diff_perc = case_when(is.na(Baseline) ~ 0,
                                            Baseline == 0 ~ 0,
                                            Baseline != 0 ~ (Scenario_2 - Baseline)/abs(Baseline),
                                            TRUE ~ 0)) %>%
    mutate(Scenario_3_diff_perc = case_when(is.na(Baseline) ~ 0,
                                            Baseline == 0 ~ 0,
                                            Baseline != 0 ~ (Scenario_3 - Baseline)/abs(Baseline),
                                            TRUE ~ 0)) %>%
    mutate(Scenario_4_diff_perc = case_when(is.na(Baseline) ~ 0,
                                            Baseline == 0 ~ 0,
                                            Baseline != 0 ~ (Scenario_4 - Baseline)/abs(Baseline),
                                            TRUE ~ 0)) %>%
    filter(!is.na(Baseline))
    #select(-Actual_initial)
# is.na(model_data_baseline_diff_raw) <- sapply(model_data_baseline_diff_raw, is.infinite)
# model_data_baseline_diff_raw <- model_data_baseline_diff_raw %>% replace(is.na(.), 0)


# Create model dataset with actual values for each variable
##################################################################################
# Spread across all permutations of Baseline, Scenario 1 ... Scenario 6

model_data_actuals <- model_data_baseline_diff_raw %>%
    select(-Scenario_1_diff, 
           -Scenario_2_diff, 
           -Scenario_3_diff, 
           -Scenario_4_diff, 
           -Scenario_1_diff_perc, 
           -Scenario_2_diff_perc, 
           -Scenario_3_diff_perc,
           -Scenario_4_diff_perc) %>%
    gather(-c("Date", "Interest_type", 
              "Variable", "Sector", 
              "Dependent_sector", "Price_type", 
              "Transaction_type", "Description", "Type"), 
           key = "Scenario", 
           value = Value) %>%
    mutate(Scenario = str_replace_all(Scenario, "_", replacement = " ")) %>%
    filter(!(Sector == "FC" & Dependent_sector == "" & Variable %in% c("IBL", "IBA")))
# model_data_actuals[model_data_actuals == 0] <- NA

# Create model dataset with difference in actural values from baseline 
# for each variable
##################################################################################
# Spread across all permutations of Baseline, Scenario 1 ... Scenario 6

model_data_scenario_diff <- model_data_baseline_diff_raw %>%
    select(-Actual_initial,
           -Baseline, 
           -Scenario_1, 
           -Scenario_2, 
           -Scenario_3, 
           -Scenario_4, 
           -Scenario_1_diff_perc, 
           -Scenario_2_diff_perc, 
           -Scenario_3_diff_perc,
           -Scenario_4_diff_perc) %>%
    gather(-c("Date", "Interest_type", 
              "Variable", "Sector", 
              "Dependent_sector", "Price_type", 
              "Transaction_type", "Description", "Type"), 
           key = "Scenario", 
           value = Value) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_1_diff", replacement = "Scenario_1")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_2_diff", replacement = "Scenario_2")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_3_diff", replacement = "Scenario_3")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_4_diff", replacement = "Scenario_4")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_5_diff", replacement = "Scenario_5")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_6_diff", replacement = "Scenario_6")) %>%
    mutate(Scenario = str_replace_all(Scenario, "_", replacement = " ")) %>%
    filter(!(Sector == "FC" & Dependent_sector == "" & Variable %in% c("IBL", "IBA")))


# Create model dataset with percentage difference in values from baseline 
# for each variable
##################################################################################
# Spread across all permutations of Baseline, Scenario 1 ... Scenario 6

model_data_scenario_diff_perc <- model_data_baseline_diff_raw %>%
    mutate(Baseline = 0) %>%
    select(-Actual_initial,
           -Scenario_1, 
           -Scenario_2, 
           -Scenario_3, 
           -Scenario_4, 
           -Scenario_1_diff, 
           -Scenario_2_diff, 
           -Scenario_3_diff,
           -Scenario_4_diff) %>%
    gather(-c("Date", "Interest_type", 
              "Variable", "Sector", 
              "Dependent_sector", "Price_type", 
              "Transaction_type", "Description", "Type"), 
           key = "Scenario", 
           value = Value) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_1_diff_perc", replacement = "Scenario_1")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_2_diff_perc", replacement = "Scenario_2")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_3_diff_perc", replacement = "Scenario_3")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_4_diff_perc", replacement = "Scenario_4")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_5_diff_perc", replacement = "Scenario_5")) %>%
    mutate(Scenario = str_replace_all(Scenario, "Scenario_6_diff_perc", replacement = "Scenario_6")) %>%
    mutate(Scenario = str_replace_all(Scenario, "_", replacement = " ")) %>%
    filter(!(Sector == "FC" & Dependent_sector == "" & Variable %in% c("IBL", "IBA")))

# Remove redundant datasets
rm(model_data_raw, 
   model_data_diff_raw, 
   model_data_roc_raw,
   model_data_baseline_diff_raw)

# Set colour palettes

    blackpalette <- c("0, 0, 0",
                      "125, 125, 125",
                      "75, 75, 75",
                      "225, 30, 0")
    bluepalette <- c("0, 50, 130",
                     "0, 170, 255",
                     "0, 200, 255",
                     "0, 55, 255")
    redpalette <- c("255, 45, 0",
                    "255, 200, 0",
                    "255, 155, 0",
                    "255, 100, 0")
    
    blackpalette_five <- c("0, 0, 0",
                      "185, 190, 200",
                      "115, 115, 115",
                      "75, 75, 75",
                      "225, 30, 0")
    bluepalette_five <- c("0, 50, 130",
                     "0, 150, 255",
                     "0, 175, 255",
                     "0, 200, 255",
                     "0, 55, 255")
    redpalette_five <- c("255, 45, 0",
                    "255, 200, 0",
                    "255, 175, 0",
                    "255, 145, 0",
                    "255, 100, 0")
    
    blackpalette_six <- c("0, 50, 130",
                          "0, 0, 0",
                          "185, 190, 200",
                          "115, 115, 115",
                          "75, 75, 75",
                          "225, 30, 0")
    bluepalette_six <- c("0, 50, 130",
                     "0, 100, 255",
                     "0, 130, 255",
                     "0, 165, 255",
                     "0, 200, 255",
                     "0, 55, 255")
    redpalette_six <- c("255, 45, 0",
                    "255, 240, 0",
                    "255, 210, 0",
                    "255, 180, 0",
                    "255, 155, 0",
                    "255, 100, 0")

    
    bluepalette <- c("0, 50, 130",
                     "0, 170, 255",
                     "0, 200, 255",
                     "0, 55, 255")
    redpalette <- c("255, 45, 0",
                    "255, 200, 0",
                    "255, 155, 0",
                    "255, 100, 0")
    
    randompalette <- c("91, 163, 111",
                       "84, 135, 158",
                       "76, 99, 143",
                       "204, 157, 2",
                       "156, 0, 0",
                       "110, 99, 194",
                       "11, 132, 176",
                       "237, 133, 28",
                       "23, 87, 11",
                       "49, 163, 79")

    blackpalette <- sapply(strsplit(blackpalette, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    bluepalette <- sapply(strsplit(bluepalette, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    redpalette <- sapply(strsplit(redpalette, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    
    blackpalette_five <- sapply(strsplit(blackpalette_five, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    bluepalette_five <- sapply(strsplit(bluepalette_five, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    redpalette_five <- sapply(strsplit(redpalette_five, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
        
    blackpalette_six <- sapply(strsplit(blackpalette_six, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    bluepalette_six <- sapply(strsplit(bluepalette_six, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    redpalette_six <- sapply(strsplit(redpalette_six, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))
    
    randompalette <- sapply(strsplit(randompalette, ", "), function(x)
        rgb(x[1], x[2], x[3], maxColorValue=255))

    
#########################################################################
# Define random colours for plots and theme settings
#########################################################################

random_srv_palette <- c("91, 163, 111",
                   "84, 135, 158",
                   "156, 0, 0",
                   "204, 157, 2",
                   "110, 99, 194",
                   "11, 132, 176",
                   "76, 99, 143",
                   "237, 133, 28",
                   "23, 87, 11",
                   "11, 132, 176",
                   "49, 163, 79")
random_srv_palette <- sapply(strsplit(random_srv_palette, ", "), function(x)
  rgb(x[1], x[2], x[3], maxColorValue = 255))

#########################################################################
# Read server debt data
#########################################################################

server_data_path <- "./Data/sfc-fi-fl/Raw_data/Serverdata"

file_list <- list.files(path = server_data_path, 
                        pattern = '*.xlsx', 
                        full.names = T)

file_names_list <- data.frame(as.character(list.files(path = server_data_path, pattern = '*.xlsx')))
colnames(file_names_list) <- c("V1")

file_names <- file_names_list %>%
    separate(V1, into = c("name", "extension"), sep = "\\(") %>%
    select(name)

Debt_data_micro <- lapply(file_list, read_excel)
names(Debt_data_micro) <- file_names$name

rm(file_names, file_names_list, file_list)



#########################################################################
# Combine outstanding debt and interest calculations
#########################################################################

# For more granular data
debt_interest_term_fix_data <- Debt_data_micro$Debt_interest_fix_term_data %>%
  filter(!is.na(Year)) %>%
  select(-Type, -Page, -Table) %>%
  inner_join(., Debt_data_micro$Interest_paid_term_fix_data %>%
               filter(!is.na(Year)) %>%
               select(-Type, -Page, -Table), 
             by = c("Year", "Interest_fixation", "Term", "Count")) %>%
  mutate(pct_interest =  Interest_paid / Cash_balance)

# For aggregate data
debt_interest_term_totals_data <- Debt_data_micro$Debt_term_data  %>%
  select(-Type, -Page, -Table,  -Cash_balance_pct) %>%
  inner_join(., Debt_data_micro$Interest_paid_term_data %>%
               select(-Type, -Page, -Table, -Interest_paid_pct), 
             by = c("Year", "Term", "Count")) %>%
  mutate(pct_interest = Interest_paid / Cash_balance)

# For more granular data
debt_interest_term_fix_data_det <- Debt_data_micro$Debt_interest_fix_term_data_det %>%
  filter(!is.na(Year)) %>%
  select(-Type, -Page, -Table) %>%
  inner_join(., Debt_data_micro$Interest_paid_term_fix_data_det %>%
               filter(!is.na(Year)) %>%
               select(-Type, -Page, -Table), 
             by = c("Year", "Interest_fixation", "Term", "Count")) %>%
  mutate(pct_interest =  Interest_paid / Cash_balance)

# For aggregate data
debt_interest_term_totals_data_det <- Debt_data_micro$Debt_term_data_det  %>%
  select(-Type, -Page, -Table,  -Cash_balance_pct) %>%
  inner_join(., Debt_data_micro$Interest_paid_term_data_det %>%
               select(-Type, -Page, -Table, -Interest_paid_pct), 
             by = c("Year", "Term", "Count")) %>%
  mutate(pct_interest = Interest_paid / Cash_balance)

##################################################################
# Capital investment ratio: Scenario_0
##################################################################
k_0 <-    (model_data_raw_num$k_f_0+
           model_data_raw_num$k_g_0+
           model_data_raw_num$k_h_0+
           model_data_raw_num$k_nf_0)
i_0 <-    (model_data_raw_num$inv_f+
           model_data_raw_num$inv_g+
           model_data_raw_num$inv_h_0+
           model_data_raw_num$inv_nf_0)


I_K_ratio_0 <- data.table(i_0/k_0, model_data_raw_num$Date)
is.na(I_K_ratio_0) <- sapply(I_K_ratio_0, is.infinite)
I_K_ratio_0 <- I_K_ratio_0 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Baseline" = V1) %>%
    select(Date, "Baseline")

rm(k_0, i_0)

##################################################################
# Capital investment ratio: Scenario_1
##################################################################
k_1 <-    (model_data_raw_num$k_f_1+
               model_data_raw_num$k_g_1+
               model_data_raw_num$k_h_1+
               model_data_raw_num$k_nf_1)
i_1 <-    (model_data_raw_num$inv_f+
               model_data_raw_num$inv_g+
               model_data_raw_num$inv_h_1+
               model_data_raw_num$inv_nf_1)


I_K_ratio_1 <- data.table(i_1/k_1, model_data_raw_num$Date)
is.na(I_K_ratio_1) <- sapply(I_K_ratio_1, is.infinite)
I_K_ratio_1 <- I_K_ratio_1 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 1" = V1) %>%
    select(Date, "Scenario 1")

rm(k_1, i_1)

##################################################################
# Capital investment ratio: Scenario_2
##################################################################
k_2 <-    (model_data_raw_num$k_f_2+
               model_data_raw_num$k_g_2+
               model_data_raw_num$k_h_2+
               model_data_raw_num$k_nf_2)
i_2 <-    (model_data_raw_num$inv_f+
               model_data_raw_num$inv_g+
               model_data_raw_num$inv_h_2+
               model_data_raw_num$inv_nf_2)

I_K_ratio_2 <- data.table(i_2/k_2, model_data_raw_num$Date)
is.na(I_K_ratio_2) <- sapply(I_K_ratio_2, is.infinite)
I_K_ratio_2 <- I_K_ratio_2 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 2" = V1) %>%
    select(Date, "Scenario 2")

rm(k_2, i_2)

##################################################################
# Capital investment ratio: Scenario_3
##################################################################
k_3 <-    (model_data_raw_num$k_f_3+
               model_data_raw_num$k_g_3+
               model_data_raw_num$k_h_3+
               model_data_raw_num$k_nf_3)
i_3 <-    (model_data_raw_num$inv_f+
               model_data_raw_num$inv_g+
               model_data_raw_num$inv_h_3+
               model_data_raw_num$inv_nf_3)

I_K_ratio_3 <- data.table(i_3/k_3, model_data_raw_num$Date)
is.na(I_K_ratio_3) <- sapply(I_K_ratio_3, is.infinite)
I_K_ratio_3 <- I_K_ratio_3 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 3" = V1) %>%
    select(Date, "Scenario 3")

rm(k_3, i_3)

##################################################################
# Capital investment ratio: Scenario_4
##################################################################
k_4 <-    (model_data_raw_num$k_f_4+
               model_data_raw_num$k_g_4+
               model_data_raw_num$k_h_4+
               model_data_raw_num$k_nf_4)
i_4 <-    (model_data_raw_num$inv_f+
               model_data_raw_num$inv_g+
               model_data_raw_num$inv_h_4+
               model_data_raw_num$inv_nf_4)

I_K_ratio_4 <- data.table(i_4/k_4, model_data_raw_num$Date)
is.na(I_K_ratio_4) <- sapply(I_K_ratio_4, is.infinite)
I_K_ratio_4 <- I_K_ratio_4 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 4" = V1) %>%
    select(Date, "Scenario 4")

rm(k_4, i_4)

##################################################################
##################################################################

I_K <- I_K_ratio_0 %>%
    left_join(., I_K_ratio_1, by = "Date") %>%
    left_join(., I_K_ratio_2, by = "Date") %>%
    left_join(., I_K_ratio_3, by = "Date") %>%
    left_join(., I_K_ratio_4, by = "Date") %>%
    gather(-Date, key = Scenario, value = Value)

rm(I_K_ratio_0, I_K_ratio_1, I_K_ratio_2, I_K_ratio_3, I_K_ratio_4)

##################################################################
# Capital savings ratio: Scenario_0
##################################################################
k_0 <-    (model_data_raw_num$k_f_0+
           model_data_raw_num$k_g_0+
           model_data_raw_num$k_h_0+
           model_data_raw_num$k_nf_0)
s_0 <-    (model_data_raw_num$s_f_0+
           model_data_raw_num$s_g_0+
           model_data_raw_num$s_h_0+
           model_data_raw_num$s_nf_0+
           model_data_raw_num$s_row_0)


S_K_ratio_0 <- data.table(s_0/k_0, model_data_raw_num$Date)
is.na(S_K_ratio_0) <- sapply(S_K_ratio_0, is.infinite)
S_K_ratio_0 <- S_K_ratio_0 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Baseline" = V1) %>%
    select(Date, "Baseline")

rm(k_0, s_0)

##################################################################
# Capital savings ratio: Scenario_1
##################################################################
k_1 <-    (model_data_raw_num$k_f_1+
               model_data_raw_num$k_g_1+
               model_data_raw_num$k_h_1+
               model_data_raw_num$k_nf_1)
s_1 <-    (model_data_raw_num$s_f_1+
               model_data_raw_num$s_g_1+
               model_data_raw_num$s_h_1+
               model_data_raw_num$s_nf_1+
               model_data_raw_num$s_row_1)


S_K_ratio_1 <- data.table(s_1/k_1, model_data_raw_num$Date)
is.na(S_K_ratio_1) <- sapply(S_K_ratio_1, is.infinite)
S_K_ratio_1 <- S_K_ratio_1 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 1" = V1) %>%
    select(Date, "Scenario 1")

rm(k_1, s_1)

##################################################################
# Capital savings ratio: Scenario_2
##################################################################
k_2 <-    (model_data_raw_num$k_f_2+
               model_data_raw_num$k_g_2+
               model_data_raw_num$k_h_2+
               model_data_raw_num$k_nf_2)
s_2 <-    (model_data_raw_num$s_f_2+
               model_data_raw_num$s_g_2+
               model_data_raw_num$s_h_2+
               model_data_raw_num$s_nf_2+
               model_data_raw_num$s_row_2)

S_K_ratio_2 <- data.table(s_2/k_2, model_data_raw_num$Date)
is.na(S_K_ratio_2) <- sapply(S_K_ratio_2, is.infinite)
S_K_ratio_2 <- S_K_ratio_2 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 2" = V1) %>%
    select(Date, "Scenario 2")

rm(k_2, s_2)

##################################################################
# Capital savings ratio: Scenario_3
##################################################################
k_3 <-    (model_data_raw_num$k_f_3+
               model_data_raw_num$k_g_3+
               model_data_raw_num$k_h_3+
               model_data_raw_num$k_nf_3)
s_3 <-    (model_data_raw_num$s_f_3+
               model_data_raw_num$s_g_3+
               model_data_raw_num$s_h_3+
               model_data_raw_num$s_nf_3+
               model_data_raw_num$s_row_3)

S_K_ratio_3 <- data.table(s_3/k_3, model_data_raw_num$Date)
is.na(S_K_ratio_3) <- sapply(S_K_ratio_3, is.infinite)
S_K_ratio_3 <- S_K_ratio_3 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 3" = V1) %>%
    select(Date, "Scenario 3")

rm(k_3, s_3)

##################################################################
# Capital savings ratio: Scenario_4
##################################################################
k_4 <-    (model_data_raw_num$k_f_4+
               model_data_raw_num$k_g_4+
               model_data_raw_num$k_h_4+
               model_data_raw_num$k_nf_4)
s_4 <-    (model_data_raw_num$s_f_4+
               model_data_raw_num$s_g_4+
               model_data_raw_num$s_h_4+
               model_data_raw_num$s_nf_4+
               model_data_raw_num$s_row_4)

S_K_ratio_4 <- data.table(s_4/k_4, model_data_raw_num$Date)
is.na(S_K_ratio_4) <- sapply(S_K_ratio_4, is.infinite)
S_K_ratio_4 <- S_K_ratio_4 %>%
    replace(is.na(.), 0) %>%
    mutate(Date = V2,
           "Scenario 4" = V1) %>%
    select(Date, "Scenario 4")

rm(k_4, s_4)


##################################################################
##################################################################

S_K <- S_K_ratio_0 %>%
    left_join(., S_K_ratio_1, by = "Date") %>%
    left_join(., S_K_ratio_2, by = "Date") %>%
    left_join(., S_K_ratio_3, by = "Date") %>%
    left_join(., S_K_ratio_4, by = "Date") %>%
    gather(-Date, key = Scenario, value = Value)

rm(S_K_ratio_0, S_K_ratio_1, S_K_ratio_2, S_K_ratio_3, S_K_ratio_4)


###########################################################################
    # OECD Share prices
    ###########################################################################

    OECD_shareprice_url <- "http://stats.oecd.org/restsdmx/sdmx.ashx/GetData/MEI/AUT+BEL+CZE+DNK+EST+FIN+FRA+DEU+GRC+HUN+IRL+ITA+LVA+LUX+NLD+NOR+POL+PRT+SVK+SVN+ESP+SWE+CHE+TUR+GBR+EA19+EU28+A5M.SPASTT01+SPINTT01.ST+STSA+IXOB+IXOBSA+NCCU+NCCUSA+CXCU+CXCUSA.A/all?startTime=2010&endTime=2018"
    
    OECD_shareprice <- as.data.frame(readSDMX(OECD_shareprice_url))
    OECD_SP_all <- OECD_shareprice %>%
      filter(SUBJECT=="SPASTT01") %>%
      mutate(iso = LOCATION) %>%
      select(iso, obsValue, obsTime)
      
    
    OECD_rebase <- OECD_SP_all %>%
        filter(obsTime == 2010) %>%
        mutate(rebase = obsValue) %>%
        select(iso, rebase)

    OECD_SP_all_long <- OECD_SP_all %>%
        left_join(., OECD_rebase, by = "iso") %>%
        mutate(Values = (obsValue / rebase) * 100) %>%
        select(-rebase, -obsValue) %>%
        left_join(., country_codes, by = "iso") %>%
        mutate(Country = COUNTRY) %>%
        select(-iso, -COUNTRY) %>%
        filter(!is.na(Values),
               !is.na(geo)) %>%
      arrange(geo)

    OECD_SP_all <- OECD_SP_all %>%
        left_join(., OECD_rebase, by = "iso") %>%
        mutate(Values = (obsValue / rebase) * 100) %>%
        select(-rebase, -obsValue) %>%
        left_join(., country_codes, by = "iso") %>%
        mutate(Country = COUNTRY) %>%
        select(-iso, -COUNTRY, -Country) %>%
        filter(!is.na(Values),
               !is.na(geo)) %>%
      arrange(geo) %>%
      spread(key = geo, value = Values)
    
    OECD_share_prices_ts <- ts(OECD_SP_all[, -c(1)], start = 2010, end = 2018, freq=1)
    
    # OECD_share_prices_ts <- read.csv2("./Data/Descriptive/OECD_share_prices_ts.csv", stringsAsFactors=FALSE)
    # OECD_share_prices_ts <- OECD_share_prices_ts[, -c(1)]
    # OECD_share_prices_ts <- ts(OECD_share_prices_ts, start = 2010, end = 2018, freq = 1)
                                               
```

```{r dst-debt-and-rates}

dst_mortgage_debt <- read_excel(file.path(data_path,"fixed-flex mortgages DK 1993 - 2019.xlsx")) %>%
  mutate(Date = paste0(Year, "-", Month, "-", "01")) %>%
  mutate(Date = as.Date(Date,format='%Y-%m-%d')) %>%
  select(-Year, -Month) %>%
  gather(-Date, key = Interest_fixation, value = Value)

dk_mortgage_interest_raw_data <- data.table(sdk_retrieve_data(table_id = "DNRNURI", 
                                                       DATA = paste0(c("AL51EFFR", "AL51BIDS"),collapse = ","),
                                                       INDSEK = paste0(c("1400"),collapse = ","),
                                                       VALUTA = "z01", 
                                                       LØBETID1 = "ALLE",
                                                       RENTFIX = paste0(c("1A", "2A", "3A", "5A", "10A", "S10A"),collapse = ","),
                                                       LAANSTR = "ALLE",
                                                       Tid = "*")) %>%
      select(-c(VALUTA, LØBETID1, LAANSTR, INDSEK)) %>%
      #mutate(Value = str_replace_all(INDHOLD, pattern = "..", "")) %>%
      mutate(Value = as.double(INDHOLD, na.rm = TRUE)/100,
             RENTFIX = str_replace_all(RENTFIX, pattern = " - - ", "")) %>%
      mutate(RENTFIX = str_replace_all(RENTFIX, pattern = " - ", "")) %>%
  mutate(RENTFIX = str_replace_all(RENTFIX, pattern = "- ", "")) %>%
      mutate(RENTFIX = str_replace_all(RENTFIX, pattern = "Over 6 months and up to and including 1 year", "01 year")) %>%
      mutate(RENTFIX = str_replace_all(RENTFIX, pattern = "Over 1 year and up to and including 2 years", "02 year")) %>%
      mutate(RENTFIX = str_replace_all(RENTFIX, pattern = "Over 2 years and up to and including 3 years", "03 year")) %>%
      mutate(RENTFIX = str_replace_all(RENTFIX, pattern = "Over 3 years and up to and including 5 years", "05 year")) %>%
      mutate(RENTFIX = str_replace_all(RENTFIX, pattern = "Over 5 years and up to and including 10 years", "10 year")) %>%
      mutate(Interest_Fixation = str_replace_all(RENTFIX, pattern = "Over 10 years", "Fixed")) %>%
      mutate(Date = str_replace_all(TID, pattern = "M", "")) %>%
      mutate(Date = paste0(Date, "01")) %>%
      mutate(Date = as.Date(Date,format='%Y%m%d'))  %>%
      mutate(Interest_Fixation = factor(Interest_Fixation, order = TRUE, 
                                        levels = c("01 year",
                                                   "02 year",
                                                   "03 year", 
                                                   "05 year",
                                                   "10 year",
                                                   "Fixed"))) %>%
      select(-INDHOLD, -RENTFIX, -TID) %>%
      filter(!is.na(Value))

    DK_yield_curves_admin <- dk_mortgage_interest_raw_data %>%
      filter(DATA == "Administration rate (per cent) (not indexed)",
             !is.na(Value)) %>%
      select(-DATA)
    
    DK_yield_curves_rates <- dk_mortgage_interest_raw_data %>%
      filter(DATA != "Administration rate (per cent) (not indexed)",
             !is.na(Value)) %>%
      select(-DATA)
    
    

    
```

```{r fl-fi-sfc-plot-data, as.is = TRUE, echo = FALSE}

max_date = "2025-12-31"
max_year = year(as.Date(max_date))

min_date = "2017-01-01"
min_year = year(as.Date(min_date))

shock_1_date = "2020-01-01"
shock_1_year = year(as.Date(shock_1_date))

shock_2_date = "2022-01-01"
shock_2_year = year(as.Date(shock_2_date))


plot_line_width = 0.85

indicator_dataset_Y = model_data_scenario_diff_perc %>%
                filter(Variable %in% c("NL"),
                        Price_type == "",
                        Scenario == "Scenario 1",
                        Sector != "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)

indicator_dataset_variable_check <- model_data_scenario_diff_perc %>%
                filter(Price_type == "",
                       Scenario == "Scenario 1",
                       Date > "1999-01-01" & Date <"2001-01-01") %>%
                       group_by(Date)

shock_1_colours <-  geom_rect(data=data.frame(xmin = shock_1_year, xmax = max_year, ymin = -Inf, ymax = Inf),
                      aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax, fill="Interest rate"), colour = NA, alpha=0.1)
shock_1_legend <- scale_fill_manual('Model shock',
                      values = "#0a97f0",
                      guide = guide_legend(override.aes = list(alpha = 0.1),nrow = 2))

shock_2_colours <-  geom_rect(data=data.frame(xmin = shock_2_year, xmax = max_year, ymin = -Inf, ymax = Inf),
                      aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax, fill="Property price"), colour = NA, alpha=0.5)
shock_2_legend <- scale_fill_manual('Model shock',
                    values = c("#0a97f0", "#f7f177"),
                    guide = guide_legend(override.aes = list(alpha = 0.3),nrow = 2))

legend_bottom_right_inside <- theme(legend.spacing = unit(0.02, "cm"),
                                  legend.background = element_rect(colour = "white", size = 0.1),
                                  legend.key.size = unit(0.5, 'lines'),
                                  legend.justification=c(1,0), 
                                  legend.position=c(1,0))

legend_top_right_inside <- theme(legend.spacing = unit(0.02, "cm"),
                                  legend.background = element_rect(colour = "white", size = 0.1),
                                  legend.key.size = unit(0.5, 'lines'),
                                  legend.justification=c(1,1), 
                                  legend.position=c(1,1))

legend_top_left_inside <- theme(legend.spacing = unit(0.02, "cm"),
                                  legend.background = element_rect(colour = "white", size = 0.1),
                                  legend.key.size = unit(0.5, 'lines'),
                                  legend.justification=c(0,1), 
                                  legend.position=c(0,1))

legend_bottom_left_inside <- theme(legend.spacing = unit(0.02, "cm"),
                                  legend.background = element_rect(colour = "white", size = 0.1),
                                  legend.key.size = unit(0.5, 'lines'),
                                  legend.justification=c(0,0), 
                                  legend.position=c(0,0))

#########################################################################
# Create percentage number format settings object for plots
#########################################################################
pct_scale_settings <- scales::percent_format(accuracy = NULL,
                                       scale = 100, 
                                       prefix = "", 
                                       suffix = "\\%",
                                       big.mark = " ", 
                                       decimal.mark = ".", 
                                       trim = TRUE)


#########################################################################
# Define dash types for plots
#########################################################################
#  0 = blank, 1 = solid, 2 = dashed, 3 = dotted, 4 = dotdash, 5 = longdash, 6 = twodash

plt_line_types_5 <- c("solid", "dashed", "dashed", "2222", "2222")
plt_line_types_6 <- c("solid", "dotdash", "dashed", "dashed", "2222", "2222")

#########################################################################
# Define additional plotting theme settings for server data
#########################################################################

theme_srv_extra <- theme_minimal() +
  theme(text = element_text(size=8))+
  theme(axis.text.x = element_text(angle=90, vjust=0.5))
```

```{r most-affected-variables}

model_data_scenario_diff_perc_tables <- model_data_scenario_diff_perc %>%
  mutate(Variables = paste0(Variable, "-", Sector, "-", Dependent_sector, "-", Interest_type, "-",Price_type, "-", Transaction_type)) %>%
  mutate(Variables = str_replace_all(Variables, pattern = "----", replacement =  "-")) %>%
  mutate(Variables = str_replace_all(Variables, pattern = "---", replacement =  "-")) %>%
  mutate(Variables = str_replace_all(Variables, pattern = "--", replacement =  "-")) %>%
  mutate(Variables = str_replace_all(Variables, pattern = "-$", replacement =  ""))

intext_values <- function (df) {
  df <- df %>%
  mutate(Value = round(Value*100, digits = 2)) %>%
  mutate(Variables = str_replace_all(Variables, pattern = "-", "_")) %>%
  select(Value, Variables) %>%
  spread(., key = Variables, value = Value)
  return(df)
}

prep_tables <- function (scenario, sector, start_date, end_date) {
  df = model_data_scenario_diff_perc_tables %>%
         filter(Scenario %in% scenario,
                Sector %in% sector,
                Date > start_date & Date < end_date) %>%
  spread(., key = Scenario, value = Value) %>%
  mutate(Value = .[[11]]) %>%
  mutate(Type = case_when(is.na(Type) ~ "", TRUE ~ Type), Value = case_when(is.na(Value) ~ 0, TRUE ~ Value)) %>%
  arrange(desc(abs(Value))) %>% arrange(Type) %>%
  filter(Value != 0) %>%
  select(Variables, Type, Description, Value)
  return(df)
}

Scenario_1_perc_2021_baseline_economic <- prep_tables(c("Scenario 1"), sector = c(""), "2020-01-01", "2022-01-01")
Scenario_1_perc_2021_baseline_HH <- prep_tables(c("Scenario 1"), sector = c("HH"), "2020-01-01", "2022-01-01")
Scenario_1_perc_2021_baseline_NFC <- prep_tables(c("Scenario 1"), sector = c("NFC"), "2020-01-01", "2022-01-01")
Scenario_1_perc_2021_baseline_FC <- prep_tables(c("Scenario 1"), sector = c("FC"), "2020-01-01", "2022-01-01")
Scenario_1_perc_2021_baseline_GOV <- prep_tables(c("Scenario 1"), sector = c("GOV"), "2020-01-01", "2022-01-01")
Scenario_1_perc_2021_baseline_ROW <- prep_tables(c("Scenario 1"), sector = c("ROW"), "2020-01-01", "2022-01-01")

Scenario_1_perc_2023_baseline_economic <- prep_tables(c("Scenario 1"), sector = c(""), "2022-01-01", "2024-01-01")
Scenario_1_perc_2023_baseline_HH <- prep_tables(c("Scenario 1"), sector = c("HH"), "2022-01-01", "2024-01-01")
Scenario_1_perc_2023_baseline_NFC <- prep_tables(c("Scenario 1"), sector = c("NFC"), "2022-01-01", "2024-01-01")
Scenario_1_perc_2023_baseline_FC <- prep_tables(c("Scenario 1"), sector = c("FC"), "2022-01-01", "2024-01-01")
Scenario_1_perc_2023_baseline_GOV <- prep_tables(c("Scenario 1"), sector = c("GOV"), "2022-01-01", "2024-01-01")
Scenario_1_perc_2023_baseline_ROW <- prep_tables(c("Scenario 1"), sector = c("ROW"), "2022-01-01", "2024-01-01")

Scenario_2_perc_2022_baseline_economic <- prep_tables(c("Scenario 2"), sector = c(""), "2021-01-01", "2023-01-01")
Scenario_2_perc_2022_baseline_HH <- prep_tables(c("Scenario 2"), sector = c("HH"), "2021-01-01", "2023-01-01")
Scenario_2_perc_2022_baseline_NFC <- prep_tables(c("Scenario 2"), sector = c("NFC"), "2021-01-01", "2023-01-01")
Scenario_2_perc_2022_baseline_FC <- prep_tables(c("Scenario 2"), sector = c("FC"), "2021-01-01", "2023-01-01")
Scenario_2_perc_2022_baseline_GOV <- prep_tables(c("Scenario 2"), sector = c("GOV"), "2021-01-01", "2023-01-01")
Scenario_2_perc_2022_baseline_ROW <- prep_tables(c("Scenario 2"), sector = c("ROW"), "2021-01-01", "2023-01-01")

Scenario_2_perc_2025_baseline_economic <- prep_tables(c("Scenario 2"), sector = c(""), "2024-01-01", "2026-01-01")
Scenario_2_perc_2025_baseline_HH <- prep_tables(c("Scenario 2"), sector = c("HH"), "2024-01-01", "2026-01-01")
Scenario_2_perc_2025_baseline_NFC <- prep_tables(c("Scenario 2"), sector = c("NFC"), "2024-01-01", "2026-01-01")
Scenario_2_perc_2025_baseline_FC <- prep_tables(c("Scenario 2"), sector = c("FC"), "2024-01-01", "2026-01-01")
Scenario_2_perc_2025_baseline_GOV <- prep_tables(c("Scenario 2"), sector = c("GOV"), "2024-01-01", "2026-01-01")
Scenario_2_perc_2025_baseline_ROW <- prep_tables(c("Scenario 2"), sector = c("ROW"), "2024-01-01", "2026-01-01")

Scenario_3_perc_2021_baseline_economic <- prep_tables(c("Scenario 3"), sector = c(""), "2020-01-01", "2022-01-01")
Scenario_3_perc_2021_baseline_HH <- prep_tables(c("Scenario 3"), sector = c("HH"), "2020-01-01", "2022-01-01")
Scenario_3_perc_2021_baseline_NFC <- prep_tables(c("Scenario 3"), sector = c("NFC"), "2020-01-01", "2022-01-01")
Scenario_3_perc_2021_baseline_FC <- prep_tables(c("Scenario 3"), sector = c("FC"), "2020-01-01", "2022-01-01")
Scenario_3_perc_2021_baseline_GOV <- prep_tables(c("Scenario 3"), sector = c("GOV"), "2020-01-01", "2022-01-01")
Scenario_3_perc_2021_baseline_ROW <- prep_tables(c("Scenario 3"), sector = c("ROW"), "2020-01-01", "2022-01-01")

Scenario_3_perc_2025_baseline_economic <- prep_tables(c("Scenario 3"), sector = c(""), "2024-01-01", "2026-01-01")
Scenario_3_perc_2025_baseline_HH <- prep_tables(c("Scenario 3"), sector = c("HH"), "2024-01-01", "2026-01-01")
Scenario_3_perc_2025_baseline_NFC <- prep_tables(c("Scenario 3"), sector = c("NFC"), "2024-01-01", "2026-01-01")
Scenario_3_perc_2025_baseline_FC <- prep_tables(c("Scenario 3"), sector = c("FC"), "2024-01-01", "2026-01-01")
Scenario_3_perc_2025_baseline_GOV <- prep_tables(c("Scenario 3"), sector = c("GOV"), "2024-01-01", "2026-01-01")
Scenario_3_perc_2025_baseline_ROW <- prep_tables(c("Scenario 3"), sector = c("ROW"), "2024-01-01", "2026-01-01")

Scenario_4_perc_2021_baseline_economic <- prep_tables(c("Scenario 4"), sector = c(""), "2020-01-01", "2022-01-01")
Scenario_4_perc_2021_baseline_HH <- prep_tables(c("Scenario 4"), sector = c("HH"), "2020-01-01", "2022-01-01")
Scenario_4_perc_2021_baseline_NFC <- prep_tables(c("Scenario 4"), sector = c("NFC"), "2020-01-01", "2022-01-01")
Scenario_4_perc_2021_baseline_FC <- prep_tables(c("Scenario 4"), sector = c("FC"), "2020-01-01", "2022-01-01")
Scenario_4_perc_2021_baseline_GOV <- prep_tables(c("Scenario 4"), sector = c("GOV"), "2020-01-01", "2022-01-01")
Scenario_4_perc_2021_baseline_ROW <- prep_tables(c("Scenario 4"), sector = c("ROW"), "2020-01-01", "2022-01-01")

Scenario_4_perc_2025_baseline_economic <- prep_tables(c("Scenario 4"), sector = c(""), "2024-01-01", "2026-01-01")
Scenario_4_perc_2025_baseline_HH <- prep_tables(c("Scenario 4"), sector = c("HH"), "2024-01-01", "2026-01-01")
Scenario_4_perc_2025_baseline_NFC <- prep_tables(c("Scenario 4"), sector = c("NFC"), "2024-01-01", "2026-01-01")
Scenario_4_perc_2025_baseline_FC <- prep_tables(c("Scenario 4"), sector = c("FC"), "2024-01-01", "2026-01-01")
Scenario_4_perc_2025_baseline_GOV <- prep_tables(c("Scenario 4"), sector = c("GOV"), "2024-01-01", "2026-01-01")
Scenario_4_perc_2025_baseline_ROW <- prep_tables(c("Scenario 4"), sector = c("ROW"), "2024-01-01", "2026-01-01")

Scenario_1_perc_2021_baseline_economic_intext <- intext_values(Scenario_1_perc_2021_baseline_economic)
Scenario_1_perc_2021_baseline_HH_intext <- intext_values(Scenario_1_perc_2021_baseline_HH)
Scenario_1_perc_2021_baseline_NFC_intext <- intext_values(Scenario_1_perc_2021_baseline_NFC)
Scenario_1_perc_2021_baseline_FC_intext <- intext_values(Scenario_1_perc_2021_baseline_FC)
Scenario_1_perc_2021_baseline_GOV_intext <- intext_values(Scenario_1_perc_2021_baseline_GOV)
Scenario_1_perc_2021_baseline_ROW_intext <- intext_values(Scenario_1_perc_2021_baseline_ROW)

Scenario_1_perc_2023_baseline_economic_intext <- intext_values(Scenario_1_perc_2023_baseline_economic)
Scenario_1_perc_2023_baseline_HH_intext <- intext_values(Scenario_1_perc_2023_baseline_HH)
Scenario_1_perc_2023_baseline_NFC_intext <- intext_values(Scenario_1_perc_2023_baseline_NFC)
Scenario_1_perc_2023_baseline_FC_intext <- intext_values(Scenario_1_perc_2023_baseline_FC)
Scenario_1_perc_2023_baseline_GOV_intext <- intext_values(Scenario_1_perc_2023_baseline_GOV)
Scenario_1_perc_2023_baseline_ROW_intext <- intext_values(Scenario_1_perc_2023_baseline_ROW)

Scenario_2_perc_2022_baseline_economic_intext <- intext_values(Scenario_2_perc_2022_baseline_economic)
Scenario_2_perc_2022_baseline_HH_intext <- intext_values(Scenario_2_perc_2022_baseline_HH)
Scenario_2_perc_2022_baseline_NFC_intext <- intext_values(Scenario_2_perc_2022_baseline_NFC)
Scenario_2_perc_2022_baseline_FC_intext <- intext_values(Scenario_2_perc_2022_baseline_FC)
Scenario_2_perc_2022_baseline_GOV_intext <- intext_values(Scenario_2_perc_2022_baseline_GOV)
Scenario_2_perc_2022_baseline_ROW_intext <- intext_values(Scenario_2_perc_2022_baseline_ROW)

Scenario_2_perc_2025_baseline_economic_intext <- intext_values(Scenario_2_perc_2025_baseline_economic)
Scenario_2_perc_2025_baseline_HH_intext <- intext_values(Scenario_2_perc_2025_baseline_HH)
Scenario_2_perc_2025_baseline_NFC_intext <- intext_values(Scenario_2_perc_2025_baseline_NFC)
Scenario_2_perc_2025_baseline_FC_intext <- intext_values(Scenario_2_perc_2025_baseline_FC)
Scenario_2_perc_2025_baseline_GOV_intext <- intext_values(Scenario_2_perc_2025_baseline_GOV)
Scenario_2_perc_2025_baseline_ROW_intext <- intext_values(Scenario_2_perc_2025_baseline_ROW)

Scenario_3_perc_2021_baseline_economic_intext <- intext_values(Scenario_3_perc_2021_baseline_economic)
Scenario_3_perc_2021_baseline_HH_intext <- intext_values(Scenario_3_perc_2021_baseline_HH)
Scenario_3_perc_2021_baseline_NFC_intext <- intext_values(Scenario_3_perc_2021_baseline_NFC)
Scenario_3_perc_2021_baseline_FC_intext <- intext_values(Scenario_3_perc_2021_baseline_FC)
Scenario_3_perc_2021_baseline_GOV_intext <- intext_values(Scenario_3_perc_2021_baseline_GOV)
Scenario_3_perc_2021_baseline_ROW_intext <- intext_values(Scenario_3_perc_2021_baseline_ROW)

Scenario_3_perc_2025_baseline_economic_intext <- intext_values(Scenario_3_perc_2025_baseline_economic)
Scenario_3_perc_2025_baseline_HH_intext <- intext_values(Scenario_3_perc_2025_baseline_HH)
Scenario_3_perc_2025_baseline_NFC_intext <- intext_values(Scenario_3_perc_2025_baseline_NFC)
Scenario_3_perc_2025_baseline_FC_intext <- intext_values(Scenario_3_perc_2025_baseline_FC)
Scenario_3_perc_2025_baseline_GOV_intext <- intext_values(Scenario_3_perc_2025_baseline_GOV)
Scenario_3_perc_2025_baseline_ROW_intext <- intext_values(Scenario_3_perc_2025_baseline_ROW)

Scenario_4_perc_2021_baseline_economic_intext <- intext_values(Scenario_4_perc_2021_baseline_economic)
Scenario_4_perc_2021_baseline_HH_intext <- intext_values(Scenario_4_perc_2021_baseline_HH)
Scenario_4_perc_2021_baseline_NFC_intext <- intext_values(Scenario_4_perc_2021_baseline_NFC)
Scenario_4_perc_2021_baseline_FC_intext <- intext_values(Scenario_4_perc_2021_baseline_FC)
Scenario_4_perc_2021_baseline_GOV_intext <- intext_values(Scenario_4_perc_2021_baseline_GOV)
Scenario_4_perc_2021_baseline_ROW_intext <- intext_values(Scenario_4_perc_2021_baseline_ROW)

Scenario_4_perc_2025_baseline_economic_intext <- intext_values(Scenario_4_perc_2025_baseline_economic)
Scenario_4_perc_2025_baseline_HH_intext <- intext_values(Scenario_4_perc_2025_baseline_HH)
Scenario_4_perc_2025_baseline_NFC_intext <- intext_values(Scenario_4_perc_2025_baseline_NFC)
Scenario_4_perc_2025_baseline_FC_intext <- intext_values(Scenario_4_perc_2025_baseline_FC)
Scenario_4_perc_2025_baseline_GOV_intext <- intext_values(Scenario_4_perc_2025_baseline_GOV)
Scenario_4_perc_2025_baseline_ROW_intext <- intext_values(Scenario_4_perc_2025_baseline_ROW)
```
<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->

# SFC model presentation

Flexible rate mortgage loans: An SFC model of the impact of mortgage credit innovations on Danish balance sheet stability

## Abstract {-}

Innovations in mortgage lending options have expounded in recent decades, resulting primarily in a reduction in the initial monthly costs associated with borrowing, and made home ownership possible for socio-economic groups that were previously excluded from the market. These changes have also drastically changed the composition of household balance sheets, both at a micro and a macro level, and the volume of outstanding debt relative to household income expanded aggressively leading up to the global financial crisis in 2007-8. The innovations unfortunately also simultaneously transferred significant risks to borrowers. This paper investigates the present day macroeconomic consequences of the change in composition from fixed- to adjustable-rate mortgage (ARM) debt that occurred in Denmark between 2003 and 2009. A state-of-the-art Stock-Flow Consistent model is adapted to allow for changes in the composition of debt, and to permit shifts in the proportion of debt between fixed-interest and ARM products. The risks to financial stability are evaluated through the imposition of two plausible shocks to the economy: the first is a two percentage point rise in borrowing costs; and, the second is a 20 per cent decline in property prices. The model allows for a clear observation of the transmission channels, and the stocks and flows most at risk, and the results suggest that the expansion of ARM mortgage credit has increased the instability of the household sector. An interesting observation was that a positive net lending response can be misinterpreted as positive developments in the absence of the broader economic context. The paper is supplemented by a new presentation method for SFC model responses, where a cross-section of proportional responses are ranked, ordered and categorised in tabular form. 

<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->

## Introduction {#sec:fi-fl-sfc-intro}

Private sector debt continues to be a concern in many developed countries, in particular mortgage debt. Debt levels expanded in most developed countries during the period leading up to the financial crisis, in the household sector this was driven primarily by the extension of mortgage credit (as can be seen in Figure \ref{fig:fl-fi-sfc-lt-debt}, Section \ref{sec:fi-fl-sfc-Ap-A-MtoL}). The proportion of mortgage debt to total debt increased in all countries from around 1960, but accelerated dramatically during the 1990s and 2000s [@jorda2017macrofinancial]. That growth was unfortunately not matched by growth in household incomes, and debt-to-income continued to expand for all countries until the great financial crisis in 2007-08 (see Figure \ref{fig:fl-fi-sfc-hh-debt} in Section \ref{sec:fi-fl-sfc-Ap-A-MtoGDP}). In most countries, the supply of credit slowed or even reversed as liquidity in overnight markets dried up during the financial crisis[^relative-measures].

[^relative-measures]: It should also be noted that since GDP fell in 2007-08 in most countries, the peak in debt-to-GDP ratios in 2007-08 does not necessarily represent growth in debt, but partly a fall in GDP.

The growing debt, particularly relative to income, carries several significant risks to financial stability. These include several demand related risks, such as the future need to deleverage and the associated intertemporal substitution of demand [@Justiniano2015; @Raberto2012; @Seppecher2015], deterioration of balance sheets and potential risks to refinancing requirements [@bernanke2007; @scanlon2008; @disyatat2011], and sensitivity of interest payments to rate changes [@sheehy2014]. There are also possible contagion effects across financial markets of default (or non-performance on loans), asset price adjustments and possible deterioration of financial intermediary capital positions [@DanmarksNationalbank2016a]. As seen in credit-default-swap market during the 2007-08 financial crisis, the possible collapse of liquidity in certain markets can also generate global instability. At a sectoral level there is also the general risk of the accumulation of large imbalances, such as government or foreign deficits, that can take many years to unwind.

While there are a number of parallels between various housing finance systems, the stability of each is unique to a variety of in and out of country conditions. The European Network of Housing Research (ENHR) [@lunde2014introduction] found that Political, geographical and institutional factors were not sufficient to explain significant differences in developments across 21 OECD countries since 1989. They [@lunde2014introduction, pp. 4] noted that "housing finance systems are very specific to each country, reflecting different histories, legal systems, institutions, economic conditions, policies and politics." It is therefore necessary to explore the particular dynamics that are at play in each country.

This paper focuses on the Danish system, which makes an excellent country for a number of reasons. Firstly, the Danish housing finance system has been no stranger to innovation, with a number of legislative and product changes introduced since 2003. It is also a relatively small and open economy with strong international trade ties and close ties with the European Union. Thus, a number of parallels can be drawn between the Danish system and several other countries with advanced mortgage financing systems. Denmark is also one of the very few countries that has reliable data for institutional sector balance sheets in granular detail from 1995, and sub-sector level data from 2003. This data allows one to study the problem from comprehensive empirical data. It also allows one to construct a model that integrates the complex interactions and feedback mechanisms of the five institutional sectors that is founded on observable empirical relationships[^micro_data].

[^micro_data]: In addition, administrative registers make it possible to explore the trajectory of various product ranges in far greater detail, although these are only available after 2009 for mortgage bond debt.

In this paper I modify an existing empirical stock flow consistent (SFC) model for the Danish economy first presented by @byrialsenraza2019empirical. As explained by @godleylavoie2012, these models maintain strict stock and flow consistency, in the sense that all flows are accounted for in a complete system of accumulations in the stocks of all five major institutional sectors. It attempts to capture the aggregate drivers of macroeconomic interactions as they happen in real time, although it uses *ex post* aggregate accounting values to estimate these relationships. 

The completeness of the model requires that some of the variables in the model are passive to changes in others. The choice of the active variables over the passive (residual) variables is determined by a combination of accounting identities and economic theory, in this case, Post Keynesian theory. The grounds for this decision are discussed in Section \ref{sec:fi-fl-sfc-lit}.

Since the household sector is at the core of the analysis in the model, most sectors are passive to changes in the household sector, and it combines the attractive features of econometrics (structural econometric models, SEMs) with path dependency and Post Keynesian behaviours. In the strict sense the model does not demonstrate causality. Rather, it estimates the expected co-movement of certain economic aggregates based on historical evidence and theoretical expectations. These estimates inform several parameters in a medium sized system of equations[^numberofequations].

[^numberofequations]: This model has 131 equations, there are thus 131 endogenous variables  (including checks) and 78 exogenous. There are in also several equations included as checks and balances, but which do not impact the functioning of the model.

The core focus of the investigation in this version of the model is the Danish mortgage system, and the expected macroeconomic consequences of innovations in the mortgage product range offered to Danish borrowers. The model in @byrialsenraza2019empirical is the most advanced empirical SFC model available for Denmark, and thus provides the best possible point of departure. The model is under continuous development, and there are some limitations imposed by the largely exogenous nature of rates of return (including interest rates) and asset prices. A secondary goal is to identify any potential improvements to the existing model with respect to mortgage credit markets.

The original structure is modified to include a split in household debt between fixed and flexible rate products. This allows for the evaluation of the effects of proportional shifts in credit composition. In particular, to investigate the short-term implications for the accumulation of stocks in the household sector of a shift in the proportion of debt from flexible-interest-rate debt to fixed-interest-rate debt, and vice versa[^multiplepossibilities]. The exogenous nature of rates of return and financial asset prices is both an advantage and disadvantage. On the one hand they allow for specific channels in the model to be highlighted, free of disturbance of from inter-connected markets. On the other hand, it implies that market rates and price fluctuations are not propagated automatically. This makes the overall model results less realistic.

[^multiplepossibilities]: By making a simple split in the proportion of debt in flexible and fixed rate instruments, and adjusting the rate of interest on each separately, it offers a relatively simple means by which to incorporate a wide variety of credit market and macro-prudential policy tools into an empirical SFC model - many of which can be achieved via a weighted proportional adjustment of the interest rate on each of the debt types.

One of the major benefits of the SFC framework is that it allows for path dependent accumulation of imbalances. Although there are some limitations (as discussed below), it is thus possible to fully account for feedback effects from accumulations in selected asset classes, albeit within a simple structure. The analysis that follows may also be of value in the assessment of mortgage financing structures in a macroeconomic framework, and contributes to the growing literature on empirical SFC models.

The remainder of the paper is structured as follows,
Section \ref{sec:fi-fl-sfc-lit} presents a review of the literature, and 
Section \ref{sec:fi-fl-rk-dk} provides context for the Danish mortgage market.
Section \ref{sec:fi-fl-sfc-model-features} describes the model, and explains some of the key innovations made in this paper, and 
Section \ref{sec:fi-fl-sfc-scenarios} explains the scenarios for shocks applied to the model.
In Section \ref{sec:fi-fl-sfc-simulations} the effects of the shocks are described for each of the scenarios, taken from the perspective of each of the main institutional sectors.
Section \ref{sec:fi-fl-sfc-discussion} contains a discussion of the main observations from the model, and 
Section \ref{sec:fi-fl-sfc-conclusion} concludes. The first appendix,
Section \ref{sec:Appendix}, contains a number of additional charts and figures, and the second appendix,
Section \ref{sec:fi-fl-sfc-full-model}, provides a full exposition of the model employed, together with explanations for the major innovations.

<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->

## Literature and theory  {#sec:fi-fl-sfc-lit}

### Stock flow consistent models

Stock flow consistent (SFC) models are a relatively new branch of macroeconomic model, and as mentioned above, are characterised by strict adherence to double entry accounting rules. They resemble structural econometric models, but the expected behaviours that are modelled are typically informed by Post Keynesian theory. @godleylavoie2007[^oldGL] is widely regarded as the catalyst for the recent growth in research using the SFC framework, and since 2007 the number of models has grown rapidly.

[^oldGL]: The original work has been revised and re-published as @godleylavoie2012.

As noted by @nikiforoszezza2017 [pp. 3], "accounting consistency is just one side of the SFC approach, with a demand-led economy and an explicit treatment of the financial side being the other." @dossantos2006, @caverzasi2013, @caverzasigodin2015 and @nikiforoszezza2017 provide surveys of the literature, each progressively covering the most recent publications. These studies provide a comprehensive review of both the topic and methodological coverage of SFC research. SFC models can be separated into three broad categories; theoretical models, which are typically much simpler and are used for the exploration of theoretical propositions; simulated calibrated models, which are larger models that are constructed to have similar features to real economies, but where the underlying data is constructed for illustrative purposes; and, empirical models, where the entire model is based on real-world data. While each form presents challenges, empirical models face additional challenges with regards availability and reliability of data. Where data is available, the researcher is faced with the challenge of appropriate aggregation.

There are relatively few fully empirical SFC models in the literature, and the number of models for which comprehensive data was available is even lower. The model presented below is an empirical model, based on the one constructed by @byrialsenraza2019empirical. Unlike many other empirical SFC models, it is constructed from the ground up, rather than adapted from one of the more broadly used @godleylavoie2012 models. This approach mirrors that suggested by @zezza2019design, where the full complexity of national accounts data is used as the point of departure. The explicit treatment of the financial side entails significant simplification of the wide variety of financial instruments that are available.

Much like many other modelling forms, the complexity of an SFC model has implications for how easily the results can be interpreted. The greater the number of interdependent features, the lower the transparency of transmission mechanisms. In summary of a central banker forum, @Pill2001 [pp. 25] noted that some participants argued that large "eclectic" macroeconomic models often "lack the simplicity, internal consistency and intuitive appeal which are prerequisites for providing good policy advice". In contrast, others "suggested that preparing policy guidance in the context of a single model allowed a holistic and rich picture of the economic situation to be obtained." This conflict between holistic context and intuitive simplicity was a key part of the decision to keep rates of return exogenous in the present model. It also provides some explanation of the aggregation process. A careful investigation of the size and relative importance of various stocks and flows was conducted to render the model to workable size. Further details regarding the actual aggregation of different categories financial and real flows are provided in Section \ref{sec:fi-fl-sfc-model-features}.

This process requires detailed data, particularly in terms of the balance sheets and flow-of-funds between the institutional sectors. This data is available for very few countries for a long enough time-period to be able to estimate statistical relationships, and Denmark is one of those countries.  The model is based on annual data from 1995 to 2017, and there are thus a maximum of twenty two observations in any estimation and the extent to which the model effectively follows the data is comprehensively illustrated in @byrialsenraza2019empirical.

### Post Keynesian theoretical foundations

The theoretical basis of the model informs the behaviours in and ordering of equations. Since the publication of @godleylavoie2012's first edition in 2007, the number of SFC models developed globally has grown exponentially, and due to the Post Keynesian roots of the framework, the bulk of these models could be referred to as Post Keynesian Stock Flow Consistent models (PK-SFC models), PK will henceforth be used refer to the "Post Keynesian" school of thought. PK theory is typically juxtaposed with the New Neo-Classical synthesis, or New Keynesianism in order to highlight the points of difference. Such a discussion is beyond the scope of this paper[^pk-comparison], and a brief summary of the key characteristics of PK systems will need to suffice here, with a special focus on those parts used to inform the model below.

[^pk-comparison]: For a full discussion of these comparisons the reader is referred to @dow1985, @dow2001pkm, @chickdow2001flr and @chick2003.

In terms of the trajectory of the economy, PKs typically reject the notion of a long run equilibrium in favour of path dependency, and argue that present decisions and institutional structures materially change the nature of the economy in the future. For the present model, this is reflected in the focus on short to medium term (typically the first period or two after a shock, but up to approximately 5 years). They argue also that the economy is significantly more complex than the sum of its parts [@chick2003], and sometimes liken it to an organic entity, or the complex interactions of an ecosystem. Economic trajectories can therefore be altered by active intervention and long term historical averages are therefore not predictive of future events. This is reflected in the model below by a lack of long-run mean reversion or stabilising elements in the model. The most significant omission relative to mainstream literature is the inter-temporal optimisation of household consumption. There are no utility functions, and there is no long-run or inter-temporal optimisation of behaviour.

For economic policy concerns, the implication is that financial and social imbalances cannot self-correct (at least not without significant social, political or economic consequences), and market mechanisms are not able to manage these issues automatically. To the contrary, unchecked imbalances that are perpetuated by market structures are problematic. Just as the accumulation of poor quality private debt prior to the 2007-08 GFC proved to be.

PKs often refer to @keynes1937, who stated that the future is fundamentally uncertain. It is therefore crucial to understand the economy as it presently stands, and to have some idea of what future economic conditions are desirable. It should thereafter be possible to actively plan for and develop a desirable future economic landscape, without the need for projections of the distant future, or acceptance of any long-run equilibria or natural rates. From a modelling perspective it is therefore not necessary that a model be stationary in order to be useful, it is more important that it should be representative of the present reality.

In terms of the sequence of events inside PK models, they emphasise the importance of demand (or rather effective demand[^effective_demand]) in the economy, and are predominantly demand driven rather than supply driven - although, more recent works have put more emphasis on supply side constrains [@skott2008supplyside]. Keynes's animal spirits and short term expectations drive investors to either increase or decrease investment. This is also related to the PK theory of an endogenous demand and supply of money in the economy. The demands of possible borrowers are tested against credit worthiness and all viable demand for credit is (or can be) accommodated by the banking sector. New lending creates new money, and therefore the demand for investment funding drives the growth in money. In this model, this analogy is applied to the household sector in that the demand for new housing investment drives the demand for mortgage credit.

[^effective_demand]: Intended here to include both consumption and investment, as explained by @keynes1937. A slightly broader definition than @Smith1776[pp. 73]'s effectual demand, which refers to commodity purchase, but with a very similar line of reasoning, where in Smith's commodity markets buyers with the capacity to pay for a good "may be called the effectual demanders, and their demand the effectual demand; since it may be sufficient to effectuate the bringing of the commodity to market. It is different from the absolute demand. A very poor man may be said in some sense to have a demand for a coach and six; he might like to have it; but his demand is not an effectual demand, as the commodity can never be brought to market in order to satisfy it."

There are several estimated equations in the model, and the motivations for each are discussed in a full presentation of the model in Section \ref{sec:fi-fl-sfc-full-model}, in the appendix. The structure of the estimated equations are informed by PK and country specific literature, and refined to reflect the reality of the data. 

### Credit markets and global financial conditions

From a broader international perspective, the period leading up to the crisis has been called "the great moderation" (as noted by, @Buttiglione2014 [pp. 28]) and was an extended period of unprecedented economic growth and apparent stability of financial markets. As noted by @englund1999, this was accompanied by the relaxation of lending requirements and credit worthiness checks, and as @scanlon2008 identified, rising property prices and expectations of capital gains. There was a gradual reduction of interest rates, and the cost of borrowing (the long-run cost of capital falling steadily from the 1970s). According to @scanlon2008, a simultaneous development on a global scale was an increased belief in the market mechanism, extensive privatisation and deregulation of financial markets[^equity-extraction]. The onset of the global financial crisis (GFC) later revealed significant flaws and systemically risky interdependencies between markets.  Even though the initial effects were felt by all countries, the effects, both in terms of intensity and real economic and financial trajectories, differed greatly. [@lunde2014introduction]

[^equity-extraction]: One such development in Denmark was the 1993 relaxation of home equity extraction laws [@Andersen2019].

In the post-crisis period, there have been significant changes to the regulatory landscape, and the extent of mortgage lending has slowed or reversed in many countries. At the height of the crisis, liquidity in key financial instruments, particularly credit default swaps, dried up almost instantly [@danmarksnationalbank2008]. Ultimately this triggered quantitative easing (QE) policies in both the USA and Europe, with the Fed and the ECB buying immense quantities of financial assets and market-making with the assistance of larger banks. On the regulatory front, banking prudential and capital adequacy requirements were tightened significantly. The period from 2009 to 2018, while not as extreme as the period preceding the crisis, has however, continued to show strong growth in property prices, with more than half of the OECD countries in the sample showing year-on-year growth rates of over 2\%, as can be seen in \ref{tab:oecd-house-price-table}.

US and European QE policies also led to excess liquidity in global financial markets. The low short-term rates have gradually resulted in record low long-term rates of return, placing added pressure on fund management and investment companies to search for yield in unconventional investments[^performance-guarantees]. These policies and other commitments by European central banks and the ECB have contributed significantly to persistent low interest rates in market based mortgage lending systems. While the rate of growth in the level of debt relative to income appears to stabilised in many countries, the magnitude of household debt continues to expand. The risks associated with this debt depend not only on the magnitude of the debt, but also very strongly on its composition.

[^performance-guarantees]:Where performance guarantees have been provided, such as for defined benefit pension schemes, some institutions face negative spreads and the risk that they might not be able to foot the bill at the end of the day. Now in 2019, eleven years after the financial crisis, @ECB2019 announced, on 12 September 2019, a further reduction of ECB deposit facility rates to $-0.5\%$, and the marginal lending facility to remain at $0.25\%$. In addition, net purchases of financial assets will begin again in the "asset purchase programme (APP) at a monthly pace of €20 billion as from 1 November".

A correlated development has been the expansion of the product range offered by mortgage lenders. Leading up to 2007, innovations were made to almost every aspect of mortgage lending, and the vast majority of these changes have contributed to a reduction in the initial payments on mortgages for the borrower. According to @scanlon2008, while the innovations were different according to each specific country, some broader characteristics were similar across developed nations. Two key aspects to these innovations were that they made initial payments on mortgages cheaper, and secondly, they increased the flexibility and range of options available, and thus transferred significant elements of risk to the borrower. @andre2016household also explains that house price bubbles are often related to periods of financial de-regulation, and highlights the introduction of interest-only (periods without capital repayments) loans in Denmark in 2003 as an example.

These international developments were not applied uniformly to all countries, or even in specific geographical areas. @lunde2014introduction found, rather surprisingly, that in contrast to a geo-political grouping, for example with other Scandinavian countries, Denmark was closer to Finland, Poland and Russia in terms of real economic and housing financing conditions after the 2007-08 financial crisis. An additional point was that the introduction of adjustable rate mortgage (ARM) products introduced a small but significant possibility of systemic risk to the Danish mortgage system[^dkliquidityrisk]. ARMs were first introduced in 1996, but and are just one of several innovations that were introduced to the Danish market.

[^dkliquidityrisk]: In particular, they referred to potential for market failure through liquidity risks for products with 30 year loan guarantees but with interest reset each year. @lunde2014introduction

Affordability of housing also became a prominent issue and tax incentives for interest payments on mortgages were common. According to @scanlon2011, real house prices in Denmark fell 14.9\% from the peak in 2007 to Q4 2008. House prices rose in all OECD countries from 2000 to 2007[^house-price-table], with Slovakia (22.41\% year-on-year (yoy)), Ireland (16.65\% yoy), Estonia (15.89\% yoy), Hungary (13.52\% yoy) and Latvia (11.22\% yoy) as the most extreme examples, while Denmark rose at 3.11\% yoy. From 2007 to 2009, house prices stabilised in most countries, and collapsed in a few with Estonia (-17.06\% yoy) and Ireland (-12.57\% yoy) showing the largest collapses. As noted above, Danish house prices reached a trough in Q4 2008 at -14.9\%.

The asset and property price bubbles and collapses of recent years appear therefore to be closely related to developments in credit markets, and as is briefly explained below, the over-extension of private balance sheets and the risk of significant declines in property prices (the bursting of a bubble) could have serious consequences for both individual borrowers and the broader economy. Some of the key credit market innovations that occurred are discussed in the next section, together with some of their main advantages and disadvantages.

[^house-price-table]: Data for OECD countries for the periods 2000 - 2007, 2007 - 2008, and 2008 - 2018 can be seen in Table \ref{tab:oecd-house-price-table}, in Section \ref{sec:fi-fl-sfc-Ap-A-OECD-house-prices}.

### Key innovations and developments in product scope

Amongst the most common innovations noted by @scanlon2008 included the following. The introduction of flexible-interest rates, and a variety of length of interest rate fixation periods. The introduction of interest-only periods, where repayment of capital or principal are postponed temporarily. Full term interest-only loans, with the principal payable on maturity - these are sometimes linked to investment vehicles designed to accumulate greater capital than the amount contributed (i.e. with an expected positive spread above the rate of interest). Longer terms of debt, some up to 50 years. Reduced up-front cash (or own) contribution requirements. Increased percentages allowed to be allocated to bond financing, typically at a significantly lower interest rate than would otherwise be available from a bank. Exceptionally low interest rate levels have also seen some innovations in terms of price. Zero-interest 20 year fixed-rate loans as well as negative interest rate flexible-rate (ARM) bonds are at the time of writing available in the Danish market. 

Some of the key drivers of these innovations were, as noted by @Alpanda2017, the availability of new technology, which permitted significantly more complex products to be managed effectively. Government deregulation, and the associated greater market orientation. Rising asset prices and problems with housing affordability. In the post-crisis period, innovations have been driven by some additional factors, including record low interest rates and quantitative easing. Interest rates in developed economies, particularly northern Europe, have been set to record low levels. This has had the dual impact of reducing the cost of borrowing and significantly reducing lender revenues.

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

#### Advantages of innovations

The advantages of these innovations have been felt most by borrowers, particularly those groups of borrowers that were previously unable to afford initial payments on home loans [@scanlon2008]. As mentioned above, mortgage repayments are in many countries now more affordable in the short term. The flexibility of repayment options has made it possible for borrowers to structure their mortgages according to their expected cash flow requirements, this is especially helpful for borrowers with irregular incomes.

The introduction of interest-only periods, allow borrowers that have limited capacity to change their income levels, particularly the elderly, to maintain a stable standard of living [@scanlon2008] - in effect consuming part of their home equity without the need to liquidate the asset. Interest-only periods also allow younger families to absorb temporary increases in living costs, without necessitating the sale of the family home. For example the cost of children, education, or other foreseeable and unforeseeable expenses. 

The lengthening of the term of mortgage debts also reduces payments for the full term of the debt, making housing more accessible to groups that would otherwise not have been able to afford it. More sophisticated investors also have the opportunity to benefit from the innovations, where in very low interest environments, they might be able to borrow and invest at higher rates of return than the cost of borrowing. Unfortunately these advantages come with a cost.

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

#### Disadvantages of innovations

The disadvantages described below are considered as compared with a standard fixed-rate annuity mortgage. In general, the innovations in mortgages place significantly greater onus on the borrower to fully understand the product that they choose to take. Several of the benefits described above are also only true for the initial stages of the debt contract, as principal repayment is often built into later stages. These products also introduce additional risk in several forms, including interest rate risk, credit risk, market risk and significant potential opportunity costs - each will be discussed briefly below.

*Interest rate risk*\newline
Perhaps the simplest and most direct effect, which would not be felt by a fix interest rate borrower, is that flexibility of interest rates expose the borrower to future increases in interest expenses, and therefore negative effects to disposable income if interest rates rise.

*Credit risk*\newline
Interest-only periods may reduce monthly outlays, but they also prevent the accumulation of equity by the borrower. This means that there is less of a buffer, making them more sensitive to negative shocks. Negative shocks may include an increase interest rates, the loss of income, illness of self or family members, breakdown of relationships (possibly divorce) or a fall in property prices.

*Market risk*\newline
Borrower solvency is determined on the basis of outstanding debt relative to the value of the property held as collateral, or loan-to-value (LTV) ratio. In the case of property price declines, traditional borrowers would have built a buffer to absorb a decline in collateral value. By contrast, the lack of equity accumulation for interest-only borrowers means that the outstanding debt would not have fallen relative to collateral. Any borrowers with LTVs close to the limit would risk falling into negative equity, and possibly insolvency. @scanlon2011 found that the groups that were most likely to be negatively affected in a crisis were those who had withdrawn equity (potentially via refinancing), or those who had bought close to the top of the market - resulting in high loan-to-value ratios and increased probability of falling into negative equity. 

*Opportunity cost*\newline
Taking Denmark as an example, the borrower is endowed with several rights, one of which is that any mortgage bond is callable at any time, and at which time, the borrow can choose to either pay the remaining par value of debt, or to repurchase the same (or similar) bond sold at time of borrowing. What this means is that if interest rates rise after the date of borrowing, there is an opportunity for mortgage borrowers to settle their debt at a significantly reduced capital value. This reduction of debt can also be accomplished by refinancing at a later stage if interest rates were to rise sufficiently to outweigh the costs of refinancing. Borrowers with flexible rate mortgages lose this opportunity, since interest rates on flexible rate bonds are reset more frequently basis, and thus price adjustments are negligible.

In summary, the increased complexity introduced by innovations requires the borrower to have a more sophisticated knowledge of financial matters and to take on more responsibility for the security of collateral and repayment of capital. As has been reported by @scanlon2008, it is doubtful whether most borrowers are sufficiently equipped to deal with these challenges. Where they do not have sufficient knowledge or skill, households become dependent on financial advisers and service providers to ensure that they have the most appropriate products.

*The credit-asset-price virtuous cycle*\newline
The self-reinforcing cycle of ease in credit markets and growth in asset prices is well documented. @Bernanke1999a and @disyatat2011 explained this in the context of the financial accelerator, rising property, and asset prices more generally, incentivise borrowing via balance sheet improvements and positive sentiment. In some cases borrowing is speculative, in order to benefit from the rising tide. Low interest rates and greater ease of access to mortgage debt simultaneously increase the pool of participants that demand assets, driving prices progressively higher. This virtuous cycle is mirrored by a similar decline in property prices and availability of credit on the way down. Conditions in credit markets and asset prices are thus difficult to separate.

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->


<!-- ### Possible policy responses to high levels of household debt -->

<!-- While no definitive answer exists on whether household debt is problematic, -->
<!-- @Alpanda2017 has noted several potential policy measures have been advanced  -->
<!-- that could be used in different circumstances to reduce household debt. -->

<!-- *Monetary policy* is traditionally limited to interest rate changes, but more recently -->
<!-- some extraordinary measures have been employed. One possibility suggested by Bützer (2019)[^buetzer] -->
<!-- could be outright transfers from the central bank to citizens. *Housing related fiscal policies* include changes to interest tax deduction allowances, or property tax structures or rates. These can be adjusted to change the net rate of return on property ownership. *Macro-prudential regulations* include adjustment to credit worthiness or  affordability tests for borrowers, changes to minimum initial contributions to qualify for mortgage financing (or bonds), an increase in minimum loan-to-value ratios, or changes to capital requirements of financial institutions. The effectiveness of these policies will depend on the initial housing financing landscape to which they are applied. -->

<!-- [^buetzer]: Forthcoming paper from the IMF. -->




<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

<!-- ### Review of models {#sec:fi-fl-other-models} -->

<!-- Nothing in this section -->
<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

## Mortgage credit in Denmark {#sec:fi-fl-rk-dk}

As mentioned above, the Danish mortgage lending market has also experienced a number
of the innovations, and is a particularly interesting case due 
to a relatively unique approach to mortgage lending. 
The system is characterised by what is called the balance principle, which @laustsen2009 
describes as a traditional fund matching principle for mortgage lending. Denmark is 
unique in that this traditional principle has been respected for over 200 years. As 
noted by @laustsen2009 [pp. 1], it results in "Transparent pricing in the form of a direct 
transfer of market-based prices to the individual borrower and market-based prepayment 
terms. And to the issuer: Limited and transparent risks."[^risklist] As noted by 
@haldrup2017 [pp. 2], a mortgage deed in Denmark is a "money-creating debt contract", but in 
Denmark, this is financed from the existing money stock[^composition].

[^risklist]: The mitigation of risk includes differences in term structure of assets 
and liabilities, refinancing risk, option risk across variations of bond type, 
liquidity risk, foreign exchange risk, and interest rate risk. The instruments issued 
include SDOs (særligt dækkede obligationer, covered bonds), SDROs (særligt dækkede 
realkreditobligationer, covered mortgage bonds) or ROs (traditionelle realkreditobligationer, 
traditional mortgage bonds). [@laustsen2009]

[^composition]: Another important consideration is that mortgage bond financing is only 
available for a portion of the debt, depending on the nature of the property, and the 
nature of the purchase. See @danske2017danish and @nykredit2018 for a detailed description 
of the covered bond and covered mortgage bond market in Denmark. Further information is 
available on similar Nordic products in @danske2017nordic.

These stable mortgage lending and covered bond markets have, since 1996, experienced 
a number of product[^productinnovations], operational[^operationinnovations] and 
legislative[^legislativeinnovations] innovations. The IMF [@sheehy2014] conducted an 
assessment of the risk related to the structure of mortgage debt in Denmark in 2014, 
and found that there was a strong shift after 2003 towards flexible rate mortgages. This 
strong shift was warned against, and the financial supervisory authority, in collaboration
with banks, began to reduce the exposure of HH to flexible rate products. While the problem
was recognised, the level of flexible rate mortgage bond exposure remains high, with roughly 70\%
of outstanding mortgage debt to be repriced within the next five years. As in most other countries,
the rights and protections of the borrower have been enhanced by several additional legislative 
changes[^Additionallegislation], several of which have been implemented in order to keep up with
the rapid innovations in mortgage markets described above.

[^productinnovations]: 2003, loans with interest-only (IO) periods. 2004, loans with interest 
rate caps and adjustable rate mortgages (ARMs, or floating-to-fixed rate options).  2007, ratchet coupons.

[^operationinnovations]: 2006 additional auctions in March and September. 2014, additional 
auction in June.

[^legislativeinnovations]: English translations of financial regulation acts are available 
from https://www.dfsa.dk/en/Rules-and-Practice/Translated_regulations/Acts, however, there 
have been additional alterations since then. Legislation permitting multiple purpose use 
of mortgage debt against fixed property was introduced as early 1993.

[^Additionallegislation]: As noted by @laustsen2009 [pp. 12], these include 1.) EU Capital Requirements 
Directive (CRD) and the UCITS Directive together set out the EU's 
definition of covered bonds. EU Directive 2006/48/EC of 14 June 2006 relating to the taking 
up and pursuit of the business of credit institutions, and EU Directive 2006/49/EC of 14 June 2006 
on the capital adequacy of investment firms and credit institutions (dubbed the Capital 
Requirement Directive – CRD).
2.) Executive Order no 718 of 21 June 2007 – Executive Order on bond issuance, balance 
principle and risk management.
3.) The par rule, applied from the final report of the committee on business and commerce of 
the Danish parliament prior to the adoption of the act in May 2007. Prepayment of loans funded 
by SDO issuance must "... take place on reasonable terms and according to a practice that does 
not deviate from the terms applicable to housing loans today. this means that prepayment may 
take place by way of a buyback of the underlying bonds or at a price that does not deviate 
significantly from par, in part out of consideration for ARMs-like products. If a loan is not 
linked to listed bonds, prepayment may take place at par." 
4.) Act no 577 of 6 June 2007 – Act amending the Financial Business Act and various other acts 
(SDOs) – and pertaining explanatory notes and final report. 

#### Composition of Danish mortgage debt

The composition of Danish real estate debt is rather complex to measure in its entirety, 
as there is a strong possibility that first-time
home buyers will take an additional bank loan against their physical property for
approximately 15\% of the market value. In the data below, this portion of the debt
is not included, and thus, the total debt outstanding represents a somewhat lower total
than that official measures of total household debt used in the model that follows[^modeldata].

[^modeldata]: The data used for the model is aggregate data sourced from Eurostat, and does not provide the level of granularity presented here. It does, however, separate long- and short-term debt, and the majority of bank loans for the purpose of property purchase are included in the long term category. These bank loans are also flexible-interest rate products, and could thus be included in the flexible portion of mortgage debts outstanding. Unfortunately we do not have data that makes it possible to identify this debt separately, and thus it is excluded in the present section.

The following data are constructed from administrative registers, which allows for a more granular view
of recent developments than is typically available. The actual data are significantly more detailed
than that presented here, but further disaggregation makes visual comparison difficult due to the relative
(in)significance of some subcategories of debt. The two main dimensions on which we are interested in
splitting mortgage debt are the term remaining on the debt and the length of time for which the interest rate
is fixed (referred to as '*interest fixation*' below). The interest fixation for ARM products shortened dramatically 
leading up to 2007, but has lengthened somewhat since the crisis, Unfortunately, the detailed micro-data is 
only available after 2009, which means that details during the expansion of mortgage debt are not available.

At a national level, the total level of debt split by interest fixation, can be seen in Figure \ref{fig:debt-composition-dk-all-term}. The first thing to note is that the nominal level of mortgage debt, in panel (a), has continued to rise throughout the period from 2009 through 2017.

```{r, out.width="50%", fig.cap="Mortgage debt in Denmark: All term lengths", fig.show='hold'}
# Combo Chart: Nominal debt: Interst fixation period
##################################################################
Nominal_debt_fixation <- ggplot() +
  geom_bar(data = Debt_data_micro$Debt_interest_fix_data_det%>%
             filter(Type == "11",
                    !is.na(Year)), 
           mapping=aes(x = as.factor(Year),
                       y = Cash_balance/1000000,
                       fill = Interest_fixation,
                       group = Interest_fixation),
           position = "stack",
           stat="identity",
           alpha = 0.4) +
  scale_fill_manual(values = randompalette,
                    name = "Interest Fixation") +
  geom_line(data = Debt_data_micro$Debt_interest_fix_data_det%>%
              filter(Type == "11",
                     !is.na(Year))%>%
              select(Year, Interest_fixation, Count, Cash_balance, Cash_balance_pct), 
            aes(x =as.factor(Year), 
                y =Cash_balance/1000000, 
                colour=Interest_fixation, 
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  # facet_grid(~Interest_fixation, scales = "free")+
  scale_y_continuous(labels =  scales::comma_format())+
  labs(x= "Year",
       y="Outstanding (DKK m)",
       title="Levels",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
  guides(fill = guide_legend(nrow = 2))
Nominal_debt_fixation

Percentage_debt_interest_fixation_plot <- ggplot() +
  geom_bar(data = Debt_data_micro$Debt_interest_fix_data_det%>%
             filter(Type == "11",
                    !is.na(Year)), 
           mapping=aes(x = as.factor(Year),
                       y = Cash_balance_pct/100,
                       fill = Interest_fixation,
                       group = Interest_fixation),
           position = "stack",
           stat="identity",
           alpha = 0.4) +
  scale_fill_manual(values = randompalette,
                    name = "Interest Fixation") +
  geom_line(data = Debt_data_micro$Debt_interest_fix_data_det%>%
              filter(Type == "11",
                     !is.na(Year)), 
            aes(x =as.factor(Year), 
                y =Cash_balance_pct/100, 
                colour=Interest_fixation, 
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  # facet_grid(~Interest_fixation, scales = "free")+
  scale_y_continuous(labels =  scales::percent_format())+
  labs(x= "Year",
       y="Per cent outstanding",
       title="Proportion",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
  guides(fill = guide_legend(nrow = 2))
Percentage_debt_interest_fixation_plot
```

This can also be considered in proportional terms, where the percentage of debt outstanding in 
each category is easier to read. As can be seen in Figure \ref{fig:debt-composition-dk-all-term} part (b) above,
the 30-fixed category, which covers all fixed rate products[^fixed-int-data], was still in decline as a proportion of total outstanding mortgage debt from 2009 to 2012.

[^fixed-int-data]: Due to the choice of data categorisation in the real-kredit register from Statistics Denmark, all contracts with fixed-interest are recorded as a 30 year fixation period. 

The most concerning factor, and one raised by @sheehy2014, in an IMF stability report, was the growing proportion of debt that would reprice within relatively short intervals. At the start of 2011, debt with an interest fixation of less than and up to 1 year (the green line) was by far the largest contributor. This was recognised by both domestic and foreign prudential regulators as a risky development, and in collaboration with the banking sector and real estate finance companies a variety of measures were implemented to reverse this trajectory. [@sheehy2014]

These patterns can further be decomposed into a variety of term structures.
As can be seen from Figure \ref{fig:debt-composition-dk-det-term}, the
proportional composition of debt is significantly different for each of the
term groupings[^term_groupings]. We will not explore this too deeply, as the
relative importance of each category varies dramatically.

[^term_groupings]: Debt is separated by term to maturity of between 0 
and 10 years, from 10 to 20 years, from 20 to 25 years and those with a term
greater than 25 years.

```{r debt-composition-dk-det-term, fig.cap="Composition of mortgage debt in Denmark: Split by term"}
#  Chart: Term remaining * interst fixation * percentage debt
##################################################################
Term_sum_Intfix_totals_plot <- ggplot() +
  geom_bar(data = Debt_data_micro$Debt_interest_fix_term_data_det %>%
             filter(Type == "111") %>%
             group_by(Year),
           mapping=aes(x = as.factor(Year),
                       y = Cash_balance_pct/100,
                       fill = Interest_fixation,
                       group = Interest_fixation),
           position = "stack",
           stat="identity",
           alpha = 0.4) +
  scale_fill_manual(values = randompalette,
                    name = "Interest Fixation") +
  geom_line(data = Debt_data_micro$Debt_interest_fix_term_data_det %>%
              filter(Type == "111",
                     !is.na(Year)),
            aes(x =as.factor(Year),
                y =Cash_balance_pct/100,
                colour=Interest_fixation,
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  facet_wrap(~Term, scales = "free")+
  scale_y_continuous(labels =  scales::percent_format())+
  labs(x= "Year",
       y= "Pct of outstanding",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
  guides(fill = guide_legend(nrow = 3, byrow=TRUE))
Term_sum_Intfix_totals_plot
```

Figure \ref{fig:debt-values-dk-det-term} illustrates the total outstanding debt in each of the term categories, it can quite easily be seen that by far the largest portion of debt has a term to maturity of over 25 years. In Denmark, the maximum term for which mortgage debt can be acquired is 30 years, thus all debt in this category in each year was issued under five years prior to the year in question. Roughly only one sixth of all outstanding mortgage debt has a term to maturity of less than 25 years.

Of the debt with greater than 25 years to maturity, it can be seen from Figure \ref{fig:debt-composition-dk-det-term}, that only approximately 30\% of this outstanding debt has an interest fixation period of longer than 5 years. This together with approximately half of the other 15\% results in a total of just over 37\% of all outstanding mortgage bond debt. This means that the remaining 63\% of mortgage debt will adjust together with interest rates. The outstanding mortgage bonds will also adjust in price, which effectively means that in the event of an increase in interest rates, nominal debt outstanding will remain fairly constant for the 63\% that has flexible interest products, and debt service costs will rise commensurate with the rise in rates. The aggregate opportunity cost related to capital adjustments for borrowers in this case is potentially very large.

By 2017, the proportion of debt with an interest fixation period of 1 year or less had fallen to approximately 25\% of all outstanding debt. A significant improvement from just under 50\% for 2010 and 2011.

```{r debt-values-dk-det-term,as.is = TRUE, fig.cap="Levels of mortgage debt in Denmark: Split by term"}
#  Chart: Term remaining * interst fixation * percentage debt
##################################################################
Term_sum_Intfix_totals_pct_plot <- ggplot() +
  geom_bar(data = Debt_data_micro$Debt_interest_fix_term_data_det %>%
             filter(Type == "111") %>%
             group_by(Year),
           mapping=aes(x = as.factor(Year),
                       y = Cash_balance/1000000,
                       fill = Interest_fixation,
                       group = Interest_fixation),
           position = "stack",
           stat="identity",
           alpha = 0.4) +
  scale_fill_manual(values = randompalette,
                    name = "Interest Fixation") +
  geom_line(data = Debt_data_micro$Debt_interest_fix_term_data_det %>%
              filter(Type == "111",
                     !is.na(Year)),
            aes(x =as.factor(Year),
                y =Cash_balance/1000000,
                colour=Interest_fixation,
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  facet_wrap(~Term)+
  scale_y_continuous(labels =  scales::comma_format())+
  labs(x= "Year",
       y= "DKK millions in each category",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
  guides(fill = guide_legend(nrow = 3, byrow=TRUE))
Term_sum_Intfix_totals_pct_plot
```

Based on the distribution that can be seen in Figure \ref{fig:debt-values-dk-det-term} above, the remainder of the paper uses a much simpler term and interest fixation categorisation. In order to capture all long term debt, all outstanding debt with a term longer than 10 years is included in long term debt, while all shorter terms maturity are included in the short term category. Similarly, interest fixation periods of less than 10 years are included in the short fixation period category, of which the overwhelming majority is fixed for less than five years. All interest fixation periods of longer than 10 years are included in the fixed-interest category. Because the level of mortgage debt with a shorter term is so low (largely irrelevant), this additional categorisation is dropped. Any shorter term mortgage debt is also likely to have similar characteristics of longer term debt that has short interest fixation periods. As such, it is assumed that the only fixed interest debt held by HH is held in the form of mortgage debt. It is therefore possible to categorise all debt in terms of the "interest fixation" dimension.

This is supported by Figure \ref{fig:debt-composition-dk-simp}, where the proportion of debt in the shorter term category is essentially negligible in comparison with the longer term outstanding portion.

```{r debt-composition-dk-simp,as.is = TRUE, fig.cap="Composition of mortgage debt in Denmark: Simplified, panels by term"}
#  Chart: Term remaining * interst fixation * nominal debt
##################################################################
Term_sum_Intfix_totals_plot <- ggplot() +
  geom_bar(data = Debt_data_micro$Debt_interest_fix_term_data %>%
             filter(Type == "111") %>%
             group_by(Year),
           mapping=aes(x = as.factor(Year),
                       y = Cash_balance/1000000,
                       fill = Interest_fixation,
                       group = Interest_fixation),
           position = "stack",
           stat="identity",
           alpha = 0.4) +
  scale_fill_manual(values = randompalette,
                    name = "Interest Fixation") +
  geom_line(data = Debt_data_micro$Debt_interest_fix_term_data%>%
              filter(Type == "111",
                     !is.na(Year)),
            aes(x =as.factor(Year),
                y =Cash_balance/1000000,
                colour=Interest_fixation,
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  facet_wrap(~Term)+
  scale_y_continuous(labels =  scales::comma_format())+
  labs(x= "Year",
       y= "Outstanding DKK m",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
  guides(fill = guide_legend(nrow = 2, byrow=TRUE))
Term_sum_Intfix_totals_plot
```

Figure \ref{fig:debt-composition-dk-simp} shows the nominal outstanding amounts in the short and long term to maturity categories. As can noted above, the short-term-to-maturity debt to the left is of negligible interest for the analysis that follows, and so most of the figures below focus purely on the long term-to-maturity (10+ category) to the right.

Figure \ref{fig:debt-composition-dk-simp-term}, part (a), reflects the relative proportions of fixed and flexible-interest fixation periods in each interest fixation category. The debt with interest-fixation periods of less than 10 years will be referred to as adjustable rate mortgages (ARMs) or flexible-rate mortgages below.


```{r debt-composition-dk-simp-term, out.width="95%", fig.cap="Outstanding mortgage debt and interest payments: Term of 10+ years"}
#  Chart: Term remaining * interst fixation * percentage debt
##################################################################
Term_sum_Intfix_totals_plot <- ggplot() +
  geom_bar(data = Debt_data_micro$Debt_interest_fix_term_data %>%
             filter(Type == "111",
                    Term != "00-10") %>%
             group_by(Year),
           mapping=aes(x = as.factor(Year),
                       y = Cash_balance_pct/100,
                       fill = Interest_fixation,
                       group = Interest_fixation),
           position = "stack",
           stat="identity",
           alpha = 0.4) +
  scale_fill_manual(values = randompalette,
                    name = "Interest Fixation") +
  geom_line(data = Debt_data_micro$Debt_interest_fix_term_data %>%
              filter(Type == "111",
                     !is.na(Year),
                    Term != "00-10"),
            aes(x =as.factor(Year),
                y =Cash_balance_pct/100,
                colour=Interest_fixation,
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  facet_wrap(~Term, scales = "free")+
  scale_y_continuous(labels =  scales::percent_format())+
  labs(x= "Year",
       y= "Per cent of debt",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
  guides(fill = guide_legend(nrow = 2, byrow=TRUE))

Term_sum_Intfix_totals_plot
```


```{r debt-composition-dk-simp-term-1, out.width="95%", fig.cap="Interest payments"}
Interest_paid_term_fix_nom_plot <- ggplot() +
  geom_bar(data = Debt_data_micro$Interest_paid_term_fix_data %>%
             filter(Type == "111",
                    Term != "00-10") %>%
             group_by(Year),
           mapping=aes(x = as.factor(Year),
                       y = Interest_paid/1000000,
                       fill = Interest_fixation,
                       group = Interest_fixation),
           position = "stack",
           stat="identity",
           alpha = 0.4) +
  scale_fill_manual(values = randompalette,
                    name = "Interest Fixation") +
  geom_line(data = Debt_data_micro$Interest_paid_term_fix_data%>%
              filter(Type == "111",
                     !is.na(Year),
                    Term != "00-10"),
            aes(x =as.factor(Year),
                y =Interest_paid/1000000,
                colour=Interest_fixation,
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  facet_wrap(~Term)+
  scale_y_continuous(labels =  scales::comma_format())+
  labs(x= "Year",
       y= "Outstanding DKK m",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_right_inside +
  guides(fill = guide_legend(nrow = 2, byrow=TRUE))

Interest_paid_term_fix_nom_plot
```

The cost of the outstanding debt has not followed the same pattern. Figure \ref{fig:debt-composition-dk-simp-term} part (b) above, shows that the total interest expenses paid on shorter ARM debt has declined in nominal terms from roughly equivalent to the fixed-interest debt in 2011 to just a fraction of total interest paid on fixed-interest products by the end of 2017.

This can then be represented as an average rate of interest by calculating the amount paid divided by the total outstanding debt. In Figure \ref{fig:interest-rate-composition-dk-simp}, the short-term-to-maturity characteristics are shown on the left to illustrate the these products follow market rates more closely. Again, however, it is the panel to the right that we are most interested in, where it is possible to see that longer term ARM debt paid an average rate of just under 0.5\%, while fixed rate longer term debt paid on average approximately 2.4\% in 2017. The spread has interestingly remained relatively constant between the two average rates, but the proportional decline in the ARM average rate has been approximately -86\%, while the same for fixed rate products has been approximately -50\%. It appears, from this illustration, that a fall in official interest rates has passed through to mortgage markets at roughly the same speed in fixed and ARM products[^interestingsidenote].

[^interestingsidenote]: Although it is beyond the scope of this study, a useful experiment would be to estimate the total expected effect on household equity positions for an increase in interest rates, taking refinancing opportunities into account. Unfortunately data is not available to simply measure this impact directly, but it could be accomplished with reasonable assumptions. Measuring interest payments relative to debt in isolation unfortunately cannot capture this effect.



```{r interest-rate-composition-dk-simp, as.is = TRUE,fig.asp = 0.4, fig.cap="Interest paid per cent of mortgage debt outstanding: By term"}
#  Chart: Term remaining * interst fixation * percentage debt
##################################################################
interest_rate_composition_dk_simp <- ggplot() +
  geom_line(data = debt_interest_term_fix_data,
            aes(x =as.factor(Year),
                y =pct_interest/100,
                colour=Interest_fixation,
                group=Interest_fixation),
            lwd = plot_line_width) +
  scale_colour_manual(values = randompalette,
                      name = "Interest Fixation") +
  facet_wrap(~Term, scales = "free")+
  scale_y_continuous(labels =  scales::percent_format())+
  geom_hline(yintercept = 0) +
  labs(x= "Year",
       y= "Interest paid per cent outstanding",
       caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
  theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
  guides(fill = guide_legend(nrow = 1, byrow=TRUE))
interest_rate_composition_dk_simp
```

As can be expected, in the Danish environment, as interest rates fall and the option to refinance remains available to households, the rate of interest on fixed-interest securities has followed the flexible rate of interest downwards - with a relatively constant spread of approximately 2\% points. Unfortunately we do not have data on how this spread alters during a rising interest rate period. It can be seen that there was some delay in convergence in shorter terms to maturity. This is expected as the costs associated with refinancing existing contracts are likely to outweigh the benefits of a reduction in interest expense on smaller capital values, or on products with shorter terms to maturity (i.e. fewer interest payments remaining).

In a rising rate environment borrowers again have the incentive to refinance in order to take advantage of falling bond prices, since in Denmark the borrower has the option to either pay back the cash capital value or to repurchase an equivalent bond to the one issued on the date of borrowing (otherwise known as a prepayment or buy-back option). If interest rates rise sufficiently to make it profitable, and if they have accumulated sufficient equity, the borrower has the opportunity to make a substantial reduction in the outstanding capital amount. Thus, unless rates remain unchanged, or only vary marginally, for an extended period of time, the proportion of outstanding debt that has been recently refinanced will typically be quite high[^high_refinancing]. 

[^high_refinancing]: This is indeed the case at present, after interest rates declined gradually, but ultimately to a record low level in 2019. At the time of writing it is possible to borrow at a fixed rate for 30 years (the longest term to maturity available at present) of 0.5\% p.a. against 80\% of the market value of a primary residence. As can be seen from Figure \ref{fig:debt-values-dk-det-term} in the text above, approximately 85\% of mortgage debt outstanding has more than 25 years remaining to maturity. In other words, 85\% of all mortgage contracts in Denmark (by value) were issued inside of the previous 5 years.

#### Affordability of debt

The debt-service ratio (DSR) is shown in Figure \ref{fig:debt-service}, and calculated as the ratio between total outgoing property income payments to annual HH disposable income. In aggregate terms, it is unsurprising that the DSR has fallen continuously for the Danish household sector since the GFC. It is presently at the lowest level since 1995, and according to data collated by @abildgren2017, the lowest level ever. Thus in relative terms, while debt may be at record high levels relative to income, the aggregate cost of servicing that debt is at an all time low.

```{r debt-service, as.is = TRUE, out.width="60%", fig.asp = 0.6, fig.cap="Debt-service ratio: Denmark"}
data_raw <- read_csv(file.path(data_path,"data_raw_DK.csv"))

debt_service_data <- data.frame(seq(as.Date("1995/12/1"), by = "year", length.out = length(data_raw$time)), data_raw$pi_h_P / data_raw$yd_g_h_R)

colnames(debt_service_data) <- c("Date", "Debt_Service_Ratio")

plot_debt_service <- ggplot(data = debt_service_data,
                       mapping = aes(x = year(Date),
                                     y = Debt_Service_Ratio)) +
    labs(x = "Year", 
         y = "Debt-service ratio",
       caption = "Source: Eurostat, own calculations") +
    geom_line(lwd = plot_line_width) +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_right_inside
plot_debt_service

```

This paradox between the level of debt outstanding and the declining DSR
is discussed in analysis in Section \ref{sec:fi-fl-sfc-simulations} The implications for the
economy as a whole and for the household sector depend on the macroeconomic linkages
between the sectors and the drivers of agent decision-making in the model structure.

<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->

## The model {#sec:fi-fl-sfc-model-features}

The model implemented in this section is based on @byrialsenraza2019empirical, which is at the time of writing the most advanced empirical Stock-Flow-Consistent (SFC) macroeconomic model of Denmark. The full model together with an explanation for each equation and the logical connections between each of the sectors, flows and stocks is provided in Section \ref{sec:fi-fl-sfc-full-model}, in the appendix. 

Throughout this section some of the equations and explanations thereof are duplicated for explanatory purposes. It will provide only a brief summary of the core features of the model, and the highlight the main changes made for this analysis.

The model consists of the five main institutional sectors, namely the household sector (HH) non-financial corporate sector (NFC), the financial corporate sector (FC), the general government (G), and the rest of the world (ROW). It was developed between 2017 and 2019 with a focus on the Danish HH. As such, the behaviours of all sectors are significantly simplified, except in so far as they engage directly with HH. The model is fully empirical, in the sense that all variables included in the model are available as a dataset, against which the performance of the model can be tested.

One feature is worth noting up front. As mentioned in the introduction, the full model has 131 endogenous and 78 exogenous variables. Included in the exogenous variables are all rates of return and all financial asset prices. The most important implication is that correlated asset price and market movements are not endogenous in the model, and this limits the analysis to very short-term model responses.

### Data

The data used for the model in this article is sourced from a combination of Eurostat data, OECD data, and AMECO data. The period for which annual data is available in sufficient detail is from 1995 to 2017. This data is then processed in a series of aggregations. The data and the model accounting structures follow the ESA 2010 [@ESA2010] accounting structure, and the contents of the financial balance sheet can be summarised as:

Monetary gold and special drawing rights (F1), Currency and deposits (F2), Debt securities (F3), Loans (F4), Equity and investment fund shares (F5), Insurance, pensions and standardized guarantee schemes (F6), Financial derivatives and employees stock options (F7) and Other accounts (F8). These data are aggregated according to Table \ref{tab:eurostat-aggregation-table}.

```{r eurostat-aggregation-table, as.is=TRUE}

eurostat_aggregation %>%
  kbl(caption = "Aggregation of ESA balance sheet categories") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10) %>%
  add_header_above(c("Assets" = 1,
                     "Eurostat Code (ESA 2010)" = 1))

```

The financial markets are thus highly aggregated in the model with effectively only three asset classes. $IB$ covers all securities that provide a financial return that is analogous to interest, as does $NIB$. The only difference is that for NFC, GOV and ROW, as part of the aggregation process, only the net position in these assets and liabilities are considered.

The other two major asset classes are equities and pension funds. All except HH equities are expressed as net equity assets and liabilities, $NEQ$, and for HH they are expressed as equity assets, $EQA$, as they cannot issue equity liabilities by definition. Pension assets are expressed as $PEN$, and are recorded as net pension assets ($NPEN$) for ROW.

### Major changes

The most significant change in this version of the model is the introduction of a split between fixed and flexible rate mortgage debt. This relatively simple alteration allows one to test the sensitivity of HH balance sheets to a change in debt composition. The drivers of debt remain the same, and the rates of return on all other assets have been left unchanged. 

This is to isolate the channel through which the change in the cost of borrowing affects households in the short term. This makes it possible to identify the transmission channels and magnitude of each shock more clearly. It is one of the advantages of fully exogenous rates of return and asset prices, but comes at the cost of more realistic inter-market ("pass-through") responses.

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

### Balance sheet and transactions flow matrices {#sec:fi-fl-sfc-model-tables}

As with all SFC models, the balance sheet matrix represents the distribution
of ownership of assets ($+$) and liabilities ($-$) in the modelled economy. As can be seen
from Table \ref{tab:sfc-fi-fl-BS}, the sum of all rows, with the exception of fixed capital, are zero. This reflects that each asset (except fixed assets, $K$) is exactly offset by a liability held by another sector.

The financial asset classes mentioned above are assigned to each sector according to assumptions of which sector issues or holds each type of security. FC holds the majority of counterpart financial securities, and in all sectors except HH, financial assets and liabilities are recorded in net terms (assets minus liabilities).

The interest bearing liabilities of HH are, as noted in the previous section, by a vast majority, long term debt. This is separated into fixed-interest ($IBL(FI)^F$) and flexible-interest ($IBL(FL)^F$) (or, ARM) mortgage liabilities.

Horizontal consistency captures the idea that all accounts are recorded as dual entry
accounting records, and the sum of all sector positions in any financial asset class should be zero. Vertical consistency represents the financial position of each sector, where financial net wealth ($FNW$) is the sum of all assets and liabilities and will either be a net positive or negative value. The sum across sectors of the $FNW$ of all sectors is also zero.

```{r sfc-fi-fl-BS, as.is=TRUE}

sfc_fi_fl_BS_data %>% 
  kbl(caption = "Balance sheet matrix: BSM",
      align=c('l', c(rep('c', 8))),
      escape = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10) %>%
    add_header_above(c(" " = 1,
                     " " = 1,
                     "Assets" = 1,
                     "Liabilities" = 1,
                     " " = 1,
                     "Assets" = 1,
                     "Liabilities" = 1,
                     " " = 1,
                     " " = 1)) %>%
    add_header_above(c("Stocks" = 1,
                     "NFC" = 1,
                     "FC" = 2,
                     "GOV" = 1,
                     "HH" = 2,
                     "ROW" = 1,
                     "$\\Sigma$" = 1), escape= F) %>%
    pack_rows("Financial Stocks", 1, 5) %>%
    pack_rows("Fixed Stocks", 7, 7) %>%
  scroll_box(width = "99%", height = "100%")
```

The transactions flow matrix is presented below. This matrix, much like the balance sheet matrix presented above, observes the requirements of horizontal and vertical consistency. In this table, all items that result in a positive flow of funds for the sector in question are marked with a plus sign ($+$), and all those that result in a flow outwards of funds are marked with a minus sign ($-$).

The expenditure approach to GDP is captured in the first five lines of the table, and can be captured as,

\begin{equation}
Y = C + I + G + (X - M)
\label{eq:gdp_intext}
\end{equation}

Where $C$ is consumption, $I$ is investment, $G$ is government expenditure, $X$ is exports and $M$ is imports. All in nominal terms to reflect the actual flows of funds in each period. The income approach to national expenditure is captured in the following six lines in the table up until the row called *Savings*. Each row name reflects the flow that is applicable to each sector. The full detail of how these flows are defined can be found in the full model description in Section \ref{sec:fi-fl-sfc-full-model}, in the appendix.

Capital income ($rK$), transfers ($STR$), capital transfers ($KTR$), acquisitions less disposal of fixed assets ($NP$) and net lending ($NL$) are presented without a particular sign attached to each sector. The reason for which is that each sector both receives and pays social transfers, and although GOV is the primary counterpart for all of these, the size and net sign of these transfers can change over time. The same is true for $KTR$ and $NP$. Net lending ($NL$) is a passive (residual) value and is determined by the balance of funding requirements between the sectors over time, and can therefore also swing between negative or positive as a flow.

```{r sfc-fi-fl-TFM, as.is=TRUE}

sfc_fi_fl_TFM_data %>%
  kbl(caption = "Transactions flow matrix: TFM",
      align=c('l', c(rep('c', 11)))) %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10,
                ) %>%
    add_header_above(c(" ",
                       "Current" = 1,
                       "Capital" = 1,
                       "Current" = 1,
                       "Capital" = 1,
                       "Current" = 1,
                       "Capital" = 1,
                       "Current" = 1,
                       "Capital" = 1,
                       "Current" = 1,
                       "Capital" = 1,
                       " ")) %>%
    add_header_above(c("Flows" = 1,
                     "NFC" = 2,
                     "FC" = 2,
                     "GOV" = 2,
                     "HH" = 2,
                     "ROW" = 2,
                     "$\\Sigma$" = 1), escape= F)%>%
  scroll_box(width = "99%", height = "100%")

```

The three rows after the *Savings* row illustrate adjustments to the level of savings ($S$) as a result of capital transfers ($KTR$), purchase and sale of fixed assets ($NP$) and (from the third row of the table) the level of investment ($I$) of each sector - summed vertically in the *capital* accounts column for each sector. The sum of all of these items is reflected in a net financing requirement for each sector, in the table is called *Net lending*. The sum of all net lending positions in the economy is again necessarily equal to zero, as one sector's surplus is at least one other sector's deficit. The sum of all columns and all rows are thus all equal to zero, and this criterion is respected by the data collected from Eurostat on an annual basis.

Financial and fixed assets in the model are subject to both transactions and revaluations (or capital gains or losses). The accumulation of certain types of assets or liabilities depends in part on the action of the sector in question and in part on the effects of the other sectors. As can be read in the full model description in the appendix, the nominal values that are sourced from the Eurostat database and or AMECO can then be deflated using appropriate price indices. There are 19 different price indices used in the model, some of which are calculated, but the majority of which are sourced either from Statistics Denmark, AMECO or the OECD. The details of the model structure and the performance of the model relative to the data available can be found in @byrialsenraza2019empirical, and the details of the behavioural equations available in Section \ref{sec:fi-fl-sfc-full-model}, in the appendix.

What we are most interested in here, however, is the specific channels through which the scenarios proposed below transmit. As mentioned above, the model contains active behaviours and passive behaviours. In each period, in order to ensure closure in the model, there is one variable in each sector that is passive to the budget constraints of each year.

The passive accumulator flows (or residual, buffer variables) for each sector are as follows:
transactions in net interest bearing securities for NFC ($NIBTR^N_t$), GOV ($NIBTR^G_t$), and ROW ($NIBTR^W_t$);and, transactions in interest bearing assets for HH ($IBATR^H_t$).
While specific behavioural equations determine the holding of all other financial assets, $NIB$ securities act as a catch all category for NFC, GOV and ROW. The sum of those positions is then absorbed by FC. As will be discussed below, the final closure of the model is provided through the indirect provision of equity assets to HH by FC on demand. This is fitting, since HH purchases of mutual funds or unit trusts are likely to be fulfilled by FC, rather than directly by NFC.

<!-- ```{r sfc-fi-fl-BS-reval, as.is=TRUE} -->
<!-- landscape( -->
<!--   kable(sfc_fi_fl_BS_reval_data, -->
<!--       booktabs = TRUE, -->
<!--       caption = "Transactions and revaluations matrix: TRM", -->
<!--       escape = FALSE, -->
<!--       align=c('l', c(rep('c', 7)))) %>% -->
<!--   kable_styling(latex_options = c("striped", "scale_down", "hold_position"), font_size = 10) %>% -->
<!--   pack_rows("Net worth from previous period", 1, 1) %>% -->
<!--   pack_rows("Changes arising from transactions", 2, 14) %>% -->
<!--   pack_rows("Changes arising from revaluations", 15, 15) -->
<!-- ) -->

<!-- ``` -->

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->


<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->

## Scenarios {#sec:fi-fl-sfc-scenarios}

This section briefly explains the four scenarios investigated using the model. Apart from alterations to the structure of household mortgage liabilities, the model operates in the same manner as in @byrialsenraza2019empirical. The shocks presented below are measured as a percentage change from the baseline scenario.
This allows for a simpler comparison between scenarios, and the aggregate nominal
and real values of stocks and flows are illustrated where relevant.

The first shock (and Scenario 1) is an increase in interest rates in 2020, the second shock (and Scenario 2) is a decline in property prices in 2022. Scenario 3 compounds the first two, in that the first shock is kept in the model before the shock to property prices is imposed. The last scenario, Scenario 4, is a reduction in the level of ARMs in 2017. Effectively, the last scenario changes the pre-conditions for the first two shocks, but applies them in exactly the same manner. It is therefore possible to make a direct comparison between Scenario 3 and Scenario 4, given two different starting points.

This ordering allows the answer to a counter-factual question: What if HH had not taken on as much flexible rate mortgage debt? How would this shift in interest rate exposure affect outcomes, both for HH and the broader economy? In essence, what might have been the case if the innovations leading up to 2003 had not impacted borrowing decisions to the same degree? There are however, some limitations to the current model that are relevant for this exercise.

### Limitations for interpretation of results  {#sec:fi-fl-sfc-scenarios-limitations}

*Adjustable Rate Mortgages (ARMs) typically do not adjust immediately*

As noted above, the bulk of ARMs in Denmark adjust fewer than 5 years into the future. This allows households an extended period of time to observe interest rate fluctuations and make a decision regarding refinancing or property sale. It also means that the effects of an interest rate change will only impact HH cash flows after between one and five years.

*A decline in house prices is unlikely to happen in isolation*

A fall in house prices is not expected to occur in isolation. Unlike in the model below, a collapse in property prices is unlikely to be an isolated event. It would more likely accompany broader systemic problems or be triggered by some form of financial or economic crisis.

*The structure of the economy at end 2017 is integrated with the volume and structure of household debt*

For the fourth scenario, it is assumed that we can simply shift the structure of debt and leave the remainder of the economy unchanged. In reality, the total level of debt outstanding would probably be significantly lower if ARM and interest-only products had not been made available. This would have affected a significant array of economic variables, not least of all, domestic demand and house prices. Although this is true, HH have already accumulated significant levels of debt. As such, Scenario 4 is less a question of, what if things had been different, and more a question of how to structure policy in order to best influence future refinancing decisions of HH.

*Interest rate changes would change the composition of debt*

Refinancing in response to interest rate changes in Denmark is extensive. In a rising interest rate environment, the incentive is to repurchase the previously issued bond at a reduced price, settle the older debt, and then refinance at similar monthly instalments, but with a lower capital value outstanding. 

With falling interest rates, the incentive is to refinance at lower monthly instalments, and if possible using a bond with fixed-interest, thus creating the opportunity to refinance if rates rise significantly in the future, and thus reduce the level of debt outstanding. It is therefore unlikely that the structure of debt would remain constant after a shift in rates[^hh_debt_response]. Due to the costs involved in refinancing, a change in interest rates is expected impact debt structures gradually, remaining fairly stable for the first year or two, and adjusting to a greater degree in the medium term (approximately up to 5 years).

[^hh_debt_response]: Micro-level contractual data is presently only available from 2009 onwards, thus at an individual level, there is no data that can be used to model household behaviour in response to an increase in interest rates. If the home owner intends to sell their property inside of 5 years, interest rates must fall dramatically for it to be financially beneficial to refinance due to the costs involved. In a rising interest rate environment, a fixed-interest bond holder that sells their property will always be able to benefit from capital losses on their outstanding bond, but might face difficulties in selling their property as demand is expected to be suppressed due to higher borrowing costs. In the same situation, a fixed rate borrower will again need quite significant changes in the level of interest rates for a prepayment or buy-back operation to be profitable in under 5 years.

### Scenario 1 - An increase in interest rates  {#sec:fi-fl-sfc-scenarios-s1}

The first shock is a simple interest rate change. The point is to illustrate the expected impact on the level of household disposable income and the household balance sheet.

In this shock we consider a 2 percentage point ($2\%$ points) rise in official rates. This is assumed to be passed through perfectly to ARM mortgages (interest rate on flexible-interest-rate mortgage debt, i.e. flexible rate products, with subscript (FL), ($r^H_{L(FL)_{t}}$). The cost of fixed-interest mortgage debt ($r^H_{L(FI)_{t}}$) is increased by a proportionally lower adjustment of point five percentage points ($0.5\%$ points) to reflect lower sensitivity of adjustments of the overall stock of fixedinterest rate products. This is a strong assumption, and is not likely to hold over longer periods of time, fixed-interest rate debt holders are expected to retain their debt at lower interest rates, while the majority of flexible-interest rate holders are expected to participate fully in the rise in interest rates after a period of three years[^illustrativetimeperiods]. 

In the model baseline, the current rate is calculated as interest payments relative to outstanding debts. This gives a weighted average at the end of 2017 of 1.41\% for all debts[^actualvsaveragerates]. After the shock, the adjustment is from this average rate upwards - thus flexible-interest rates are adjusted up to 2.41\% and fixed-interest rates up to 1.91\%. This constitutes a 141.75 per cent increase in flexible rates, and taking into account changes in the level of outstanding debt in 2021, a 136.29\% increase in interest payments. For fixed-interest debt, it constitutes a 35.44 per cent increase in fixed rates, and a 32.38\% increase in interest payments.

[^actualvsaveragerates]: As noted earlier, interest rates are currently at historically low levels. The actual average rates of interest paid on flexible and fixed-interest mortgage products were 0.29\% and 2.29\% per annum at the close of 2017. These values, however exclude a variety of debt types such as bank debt, vehicle finance and consumer credit. The use of the average payment on all debt types is a simplification that is made to suit the aggregation of data, and the reader should be aware that this does not take into account the multitude of behavioural incentives that apply to each underlying debt type.

[^illustrativetimeperiods]: These time periods are purely for illustrative purposes, since, as mentioned just above, the Danish market is expected to have extensive refinancing as rates shift. This is however expected to be somewhat muted by the expectation that the demand for new debt, and therefore the demand for houses are expected to fall - potentially leading to a fall in house prices, or at the very least, slower capital gains. Selling conditions are generally expected to be worse in a higher interest rate environment, where the rise in the cost of house purchase will naturally exclude a large number of potential buyers.

The interest rates in the model include, interest on fixed ($r^H_{L(FI)}$) and flexible rate ($r^H_{L(FL)}$) mortgages, and the counterpart assets ($r^F_{A(FI)}$, $r^F_{A(FL)}$), the general rate of return on net interest bearing assets ($r_{N}$), and the return on interest bearing assets for households ($r^H_{A}$). The other rates of return are the domestic and foreign rate of return on equities ($\chi _t$), and pension assets ($\psi _t$). All rates of return in the model are determined exogenously, which means that any adjustment must be applied manually. As noted above, the change is limited to the cost of borrowing for HH only.

In the case of household debt, it is FC that holds the counter-balance assets. Thus,

$$r^F_{A(FI)_{t}} = r^H_{L(FI)_{t}}$$
and, 
$$r^F_{A(FL)_{t}} = r^H_{L(FL)_{t}}$$

FC receives $r^F_{A(FI)_{t-1}}(IBA^{F\sim H}_{A(FI)_{t-1}})$, and the two interest rates are simply made equivalent. An increase in rates results in an increase in costs for HH and an increase in revenues for FC. 

<!-- The rate on interest -->
<!-- bearing assets ($r^H_{A_{t}}$), and the mean return on financial assets and liabilities ($r^N_{t}$) are assumed to conform to a weighted average of interest income in the financial sector. This is calculated according to the proportional split of mortgage debt between ARM  ($1 - \alpha$) and fixed-interest products ($\alpha$).  -->
<!-- $r^H_{A_{t}}$ and $r^N_{t}$ are then calculated as: -->

<!-- $$r^H_{A_{t}} = (1 -\alpha)(2\%) + \alpha(2\%) = r^N_{t}$$ -->


<!-- ```{r dst-mortgage-debt-yield-curves, as.is = TRUE, fig.width = 3, fig.cap="Yield curves 2014 to 2019"} -->

<!-- DK_yield_curves <- ggplot() + -->
<!--     geom_line(data = DK_yield_curves_rates %>% -->
<!--               mutate(Date = as.numeric(paste0(year(Date), str_pad(sprintf("%.0f", month(Date)), width = 2, pad = 0, side = 'left')))), -->
<!--              mapping = aes(x = Interest_Fixation, -->
<!--                            y = Value, -->
<!--                            group = Date, -->
<!--                            colour = Date), -->
<!--               lwd = 0.5) + -->
<!--     labs(x = "Interest fixation term", y = "Yield curves", -->
<!--     caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") + -->
<!--     scale_colour_gradient(low = "#ffffff", high = "#050f80") + -->
<!--     #facet_wrap(~Growth) + -->
<!--     scale_y_continuous(labels = scales::percent_format()) + -->
<!--     theme_srv_extra + -->
<!--     theme(legend.direction = "vertical", -->
<!--           legend.box = "horizontal") + -->
<!--     legend_top_left_inside + -->
<!--     guides(col = guide_legend(nrow = 6,  -->
<!--                             byrow = FALSE, -->
<!--                             title = "Date of yield curve")) -->

<!-- DK_yield_curves -->

<!-- ``` -->

<!-- ```{r fl-fi-sfc-plot-interest-rates-assets, as.is = TRUE, fig.cap = "Interest rate shock to assets", fig.width = 3, fig.asp = 1} -->
<!-- plot_interest_rates_assets <- ggplot() + -->
<!--     shock_1_colours + -->
<!--     shock_1_legend + -->
<!--     geom_line(data = model_data_actuals %>% -->
<!--                 mutate(Interest = paste0(Variable, "-", Scenario)) %>% -->
<!--                 filter(Variable %in% c("R-IBA"), -->
<!--                         Price_type == "", -->
<!--                         Sector == "HH", -->
<!--                         Scenario %in% c("Baseline", "Scenario 1"), -->
<!--                         Date > min_date & Date < max_date), -->
<!--               mapping = aes(x = year(Date), -->
<!--                                      y = Value, -->
<!--                                      group = Interest, -->
<!--                                      colour = Interest), -->
<!--               lwd = plot_line_width) + -->
<!--     labs(x = "Year", y = "Pct from baseline", -->
<!--         caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") + -->
<!--     scale_colour_manual(values = randompalette) + -->
<!--     scale_y_continuous(labels = scales::percent_format()) + -->
<!--     theme_srv_extra + -->
<!--     theme(legend.direction = "vertical", -->
<!--           legend.box = "vertical") + -->
<!--     legend_top_right_inside + -->
<!--     guides(col = guide_legend(nrow = 5,  -->
<!--                               byrow = FALSE, -->
<!--                               title = "Interest rate")) -->
<!-- plot_interest_rates_assets -->

<!-- ``` -->

Figure \ref{fig:dst-mortgage-debt-interest} illustrates, in part (a) the actual monthly interest rates available for new debt on Danish mortgage markets since 2013 (separated by term of interest fixation). Part (b) shows the progression of official interest rates in Denmark since 2000, where the "Mortgage bond" rate is the dark-red line, and is comparable with *Fixed* mortgage bonds in panel (a), the purple line, from 2013 onwards. Part (c) illustrates the impact of the shock to interest rates in the model in 2020.


```{r dst-mortgage-debt-interest, out.width="33%", fig.cap="Interest rates in Denmark", fig.show='hold'}

DK_rate_curves <- ggplot() +
    geom_line(data = DK_yield_curves_rates,
             mapping = aes(x = Date,
                           y = Value,
                           group = Interest_Fixation,
                           colour = Interest_Fixation),
              lwd = 0.5) +
    labs(x = "Interest fixation term", y = "Rate of interest",title="Interest rates by maturity",
    caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
    scale_colour_manual(values = randompalette) +
    #scale_colour_gradient(low = "#ffffff", high = "#050f80") +
    #facet_wrap(~Growth) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "horizontal") +
    legend_top_right_inside +
  guides(col = guide_legend(nrow = 3, 
                            byrow = FALSE,
                            title = "Interest fixation"))
DK_rate_curves

DK_natbank_rate_curves <- ggplot() +
    geom_line(data = National_bank_rates %>%
                filter(Date > "2000-01-01" & Date < "2019-01-01"),
             mapping = aes(x = Date,
                           y = Values/100,
                           group = Rate,
                           colour = Rate),
              lwd = 0.5) +
    labs(x = "Year", y = "Rate of interest", title="National bank rates",
    caption = "Source: Statistics Denmark (Danmarks Statistik)") +
    scale_colour_manual(values = randompalette) +
    #scale_colour_gradient(low = "#ffffff", high = "#050f80") +
    #facet_wrap(~Growth) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_right_inside +
    guides(col = guide_legend(nrow = 5, 
                            byrow = FALSE,
                            title = "Interest rate"))
DK_natbank_rate_curves

  plot_interest_rates_shocks <- ggplot() +
    shock_1_colours +
    shock_1_legend +
    geom_line(data = model_data_actuals %>%
                mutate(Interest = paste0(Variable, "-", Interest_type, "-", Scenario)) %>%
                filter(Variable %in% c("R-IBL"),
                        Price_type == "",
                        Scenario %in% c("Baseline", "Scenario 1"),
                        Interest_type %in% c("Fixed", "Flexible"),
                        Date > min_date & Date < max_date),
              mapping = aes(x = year(Date),
                                     y = Value,
                                     group = Interest,
                                     colour = Interest),
              lwd = plot_line_width) +
    labs(x = "Year", y = "Interest rate", title = "Interest rate shocks in model",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    scale_colour_manual(values = randompalette) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical")+
    legend_top_right_inside +
    guides(col = guide_legend(nrow = 4, 
                              byrow = FALSE,
                              title = "Interest rate"))

plot_interest_rates_shocks

```

As can be seen from part (a), the rates available to fixed rate borrowers have followed market rates downwards throughout the period, although this illustrates only those rates available, rather than those paid. Figure \ref{fig:interest-rate-composition-dk-simp} showing the amounts actually paid in the section above, however, illustrates that the amount paid has also declined at a similar pace, although with a marginal delay.

The interest rates in the model are split into fixed and flexible rates for the purpose of
testing the effects of a shock to interest rate on alternative compositions of mortgage debt.
The baseline value of interest rates remains just below 1.5\% on average for all debt.

The expected outcome is that where the proportion of fixed-interest outstanding debt is higher, the effects of a shock will be weaker, and vice versa. This of course can only have an impact in the case where mortgage debt is itself split into fixed- and flexible-rate debt.

The total level of outstanding $IBL$ for HH is split into fixed-interest ($IBL_{FI}$) and flexible-interest bearing liabilities ($IBL_{FL}$). The proportion of interest bearing assets held as $IBL_{FI}$ is $\alpha$.

\begin{equation}
IBL^H_{{FI}_t} = \alpha(IBL^H_t)
\end{equation}

and thus,

\begin{equation}
IBL^H_{{FL}_t} = (1-\alpha)(IBL^H_t)
\end{equation}

The level of $\alpha$ is calculated from data acquired from multiple data sources at Statistics Denmark, and varies over time. The split was first introduced in 1996, but initial volumes were low. As discussed in Section \ref{sec:fi-fl-rk-dk}, while the composition of this debt is significantly more complex than this, a strong argument can be made for an aggregation up to just these two categories. This split has no effect on the model prior to the shock in 2020, as the rate of interest on each is considered to be equal to the average rate used in the baseline scenario up to that point.

It is also possible to shock all other rates of return to a similar degree. Given the integration of financial markets, this would produce results in the model that are more realistic. Unfortunately, it would also conceal the effects that are purely due to dynamics linked to the interest cost of borrowing for households[^robustnessexperiments].

[^robustnessexperiments]: Several alternative formulations of the shock were tested, but the inclusion of changes to other rates of return require a number of additional assumptions. For example, an increase in domestic bond rates are only likely in Denmark if European interest rates also rise. Also, the speed and proportion to which rates pass through from official rates to each market are likely to differ across products, but also over time.

### Scenario 2 - A fall in house prices {#sec:fi-fl-sfc-scenarios-s2}
The second scenario is a fall in house prices. This is effected through a negative twenty per cent adjustment to the house price index ($-20\%$). This is a large change to house prices, but is equivalent to the stress test applied by the IMF [@sheehy2014]. At a national level, Figure \ref{fig:fl-fi-house-prices-national} illustrates that the average nominal house price index (HPI) for dwellings in Denmark has risen at a relatively steady pace since the GFC.

```{r fl-fi-house-prices-national,out.width="70%", fig.cap = "National House price index (HPI), 2006 = 100", fig.asp = 0.6}
Plot_DK_HPI <- ggplot() + 
    geom_line(data = HPI %>%
                             filter(Urbanisation=="All Denmark", Trans_type=="Purchases of dwellings") %>%
                             select(-Urbanisation) %>%
                             arrange(time),
               mapping = aes(x= time, 
                             y = value, 
                             group = Trans_type,
                             colour=Trans_type), 
               linetype=1) + 
    labs(x = "Date",
         y = "House Price Index:\n DK, 2006 = 100") +
    scale_y_continuous() +
      theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 3, 
                              byrow = FALSE,
                              title = "Property types"))
Plot_DK_HPI

```

This follows a collapse of house prices during the GFC, where prices of Danish dwellings fell approximately 20\% from the peak in 2006 to the trough in 2011. This average was not uniform across property types or regions. As shown in Figure \ref{fig:fl-fi-house-prices-regional}, the prices of owner occupied flats in the Capital and North Denmark Regions have risen at roughly the same pace as prior to the GFC. This is not predictive of a correction or price collapse, but does suggest a possible housing price bubble in those markets. All other regions, appear to have only just recovered to pre-crisis prices[^propertypriceportion].

[^propertypriceportion]: The capital region holds a disproportionately large share of real estate assets by value, and thus the impact of property prices there carry a greater weight for an average for the country as a whole.

```{r fl-fi-house-prices-regional, fig.cap = "House price index (HPI), 2006 = 100", out.width = "95%"}
Plot_DK_property_sales_indexes_regional_quarterly <- 
    ggplot() + 
    geom_line(data = property_prices_regional_quarterly %>%
                  filter(Region!="All Denmark") %>%
                  arrange(Date) %>%
                  select(-Data_type),
              mapping = aes(x= rev(Date), 
                          y = Price, 
                          group = Prop_type,
                          colour = Prop_type),
              linetype=1) + 
    labs(x = "Date",
         y = "HPI (2006 = 100)",
         caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
    scale_y_continuous() +
    geom_hline(yintercept = 0) +
    facet_grid(~Region) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 3, 
                              byrow = FALSE,
                              title = "Property types"))
Plot_DK_property_sales_indexes_regional_quarterly
```

A more serious concern for potential borrowers is that several markets, particularly those for weekend cottages (otherwise known as summer houses) have not recovered in the period following the GFC. Thus, any property purchased between 2005 and the collapse in 2007 would have a high probability of falling into negative equity[^lowerltvrisk]. 

[^lowerltvrisk]: Although the risk that the LTV ratio rises above 1 is lower for cottages, since the cap on bond financing has until very recently been significantly lower than for primary residences (60\% as opposed to 80\%).

In this model, households are only permitted to make productive investment in
housing, which, as in @Zezza2008, @fontana2013securitization and @beckta2015modelling, is considered only as a primary market. The major difference here is that households are assumed to produce the houses, whereas firms are housing producers for all three of the above-mentioned studies. The secondary market for houses is assumed to affect prices, but not the demand for additional housing investment. Demand for housing investment is determined by by a Tobin's-Q-like function, partially driven by changes in disposable income and previous period housing investment, and partially driven by a relative shift in sales price (${P^H_{t-i}}$) and construction cost (${P^i_{t-i}}$) indices.

Real investment in fixed assets (dwellings), in Equation \ref{eq:realhousinginvestment_intext}, is estimated as a log-linear function that depends on conditions in previous periods. This assumes that the decision to invest in houses occurs based on recent developments, but that actual changes in investment in fixed assets takes some time to materialise. It thus takes one period before the effects of the house price shock can be observed.

\begin{equation}
ln(i^H_t) = \beta _i + \beta _i ln(i^H_{t-i}) + \beta _i ln \Bigg( \frac{P^H_{t-i}}{P^i_{t-i}}\Bigg) + \beta _iln(yd^H_{t-i})
\label{eq:realhousinginvestment_intext}
\end{equation}

The shock imposed on the model is to the numerator of the Tobin's Q ratio[^lagsinvestment]. The imposed decline in house prices affects sales prices negatively, relative to the cost of production, and thus has a contractionary effect on the Tobin's q ratio, $\Bigg(\frac{P^H_{t-i}}{P^i_{t-i}}\Bigg)$, and thus on HH real investment ($i^H_t$). The shock is implemented as a permanent decline in prices, and thus changes the value of the ratio for all periods following the shock. Growth in house prices continues according to the same trajectory as in the baseline in order to make for a more effective comparison.

[^lagsinvestment]: In the present structure of the model, investment is regressed against real investment of the previous period $i^H_{t-1}$; real disposable income $y^H_{d}$, and the same at $t-2$ ($y^H_{d_{t-2}}$); the Tobin's Q ratio at level terms $\Bigg( \frac{P^H_{t}}{P^i_{t}}\Bigg)$, and with a one period lag $\Bigg( \frac{P^H_{t-1}}{P^i_{t-1}}\Bigg)$; a constant; and, a trend component.

The nominal level of investment in housing can be calculated by inflating the real investment in housing
series ($i^H_t$) by the investment price index ($P^i_t$, which is sourced from Statistics Denmark):

\begin{equation}
I^H_t = i^H_t(P^i_t)
\end{equation}

The nominal stock of housing ($K^H$), as with other assets to come, follows the simple
process of previous stock ($K^H_{t-1}$), plus acquisition (in this case investment in new houses), less depreciation ($D^H_t$) plus capital gains ($K^H_{CG_t}$).

\begin{equation}
K^H_t = K^H_{t-1} + I^H_t - D^H_t + K^H_{CG_t}
\label{eq:nominalhoushingcapital1}
\end{equation}

Capital gains on houses, in turn, can be calculated in an *ex post* manner as:
\begin{equation}
K^H_{CG} = \Delta P^H_t (K^H_{t-1})
\end{equation}

Which is simply the change in the price of houses applied to the level of stock at
the end of the preceding period.

The change in house prices ($\Delta P^H_t$) leading into the current period is then by definition the same ratio proportion of capital gains to previous housing capital.

\begin{equation}
\Delta P^H_t = \frac{KH_{CG}}{K^H_{t-1}}
\label{eq:changehouseprice_intext}
\end{equation}

Nominal housing capital held by HH at the end of the current period
can be expressed as the price adjusted stock at the end of the previous
period, plus net investment and depreciation. Equation \ref{eq:nominalhoushingcapital2}
is effectively a restatement of Equation \ref{eq:nominalhoushingcapital1}, but
with greater emphasis on the variable shocked in the analysis.

\begin{equation}
K^H_t = K^H_{t-1}(1 + \Delta P^H_t) + I^H_t- D^H_t
\label{eq:nominalhoushingcapital2}
\end{equation}

The deflated real capital index can then be found, as in Equation (\ref{eq:realhoushingcapital_intext}) by dividing the series by the investment (housing) price index, from Equation (\ref{eq:changehouseprice_intext}).

\begin{equation}
k^H_t = \frac{K^H_t}{P^i_t}
\label{eq:realhoushingcapital_intext}
\end{equation}

Housing capital then forms part of HH net wealth, which feeds back into consumption decisions in subsequent periods. A decline in net wealth in period $t$ leads to a decline in consumption in period $t+1$.

The effects of changes in net wealth ($NW$), are then felt directly in the level of HH consumption, but with a lag on one period (as can be seen in Equation (\ref{eq:hh_consumption}) in the appendix). Although a fall in house prices does not affect household disposable income to a substantial degree is contributes to a decline in overall economic activity, and therefore reduces the demand for labour in subsequent periods. This ultimately does affect household income but the effect is not as immediate as was the case for the interest-rate shock.

### Scenario 3 - Combination of Scenarios 1 and 2 {#sec:fi-fl-sfc-scenarios-s3}
The third scenario consecutively applies the shocks from Scenarios 1 and 2. First the interest rate increase in 2020, and then the decline in property prices in 2022. This combination sets up the comparison to be introduced in Scenario 4 below.

### Scenario 4 - Comparison for Scenario 3, proportion of fixed-interest debt 80\% {#sec:fi-fl-sfc-scenarios-s4}
The final alteration to the model is an increase in the proportion of mortgage debt held as fixed debt ($\alpha$) from the 2016 level of 33.42\% up to 80\% in 2017. This shift allows us to test the hypothetical difference of the impact of a shock to interest rates in an artificial scenario, where the proportion of flexible debt amounts to only 20\% of outstanding household mortgage liabilities.

## Simulations {#sec:fi-fl-sfc-simulations}

This section explains the transmission of the two shocks in the scenarios described above. First, the components of the economy that are most dramatically affected are identified, and thereafter the key transmission channels that cause these effects are briefly discussed.

The key take-aways from this section are that shock 1 and 2 both propagate through the economy as described above, and that Scenario 3 results in greater volatility in the responses of the economy than Scenario 4. This has implications for the stability of the balance sheets of each sector and for the economy as a whole.

The effects of each shock are summarised in tables in Section \ref{sec:fi-fl-sfc-Ap-A-scenario-summaries} for each of the above-mentioned scenarios[^summarytableinfo]. This approach allows a quick summary of the impacts of a shock. It shows all affected variables, and thus provides a snapshot of how broadly the shock propagates. One drawback is that it is a cross section in time, and thus is not able to show the progression of feedback effects over time. These tables are both used as a guide to the most important transmissions, and as a consistency check, to ensure that the model behaves within reason.

[^summarytableinfo]: Those tables are organised, firstly, according to whether the affected variable is a stock, flow, parameter, rate, or index of some kind; and secondly, in order of largest variation from the baseline scenario (as a proportion of the baseline). Transactions in and revaluations in stocks, which occur on an annual basis, are considered flow variables. To capture accumulation effects, tables are provided at the end of period 2021 ($t+1$) for Scenarios 1 and at the end of periods 2022 ($t$) and 2025 ($t+3$) for Scenarios 2, 3 and 4.

The model responds largely as expected to the first shock, with the exception of the rather extreme response of the financial sector. This is because FC transactions in net interest bearing assets ($NIBTR^F$) absorbs all financial transactions of the other sectors - or, stated differently, accumulates all financial imbalances. The second shock, to property prices, has a more interesting result with regard HH savings and will be discussed in more detail in the HH section below. 

As noted above, each of the sectors has a buffer flow that summarises the collective effect of each shock, and each of the shocks are quite extreme in nature. It is therefore unsurprising that the effect on the passive elements is somewhat exaggerated. Even though shocks of the same magnitude have occurred in the past, they are not common events and have only been used here to enhance the potential risks associated with the different debt structures.

### General economy

The first shock (to interest rates) has a delayed effect that is first visible in the shift from period 2020 to period 2021; as can be seen for Scenarios 1, 3 and 4. The second shock (to property prices) takes effect immediately in 2022, and can therefore be seen to take effect from period 2021 to period 2022 for Scenarios 2, 3 and 4. At a broader economic level, the strongest impact on the major components of GDP from the first shock are a decline in gross fixed capital formation ($I$) of `r Scenario_1_perc_2021_baseline_economic_intext$I`\% and in imports ($M$) of `r Scenario_1_perc_2021_baseline_economic_intext$M`\% (and as a result, net exports rise by just over `r Scenario_1_perc_2021_baseline_economic_intext$NX`\%). Figure \ref{fig:fl-fi-sfc-plot-gdp-indicators_s1_s2} shows how $C$, $I$, $G$, $X$ and $M$ would evolve relative to the baseline, for scenarios 1 and 2, and Figure \ref{fig:fl-fi-sfc-plot-gdp-indicators_s3_s4} that shows the same for Scenarios 3 and 4.

The shock to interest rates only impacts the model at $t+1$ and so there is no change from the baseline in year 2020, whereas the impact of a property price shock takes immediate effect in 2022. Exports remain relatively unchanged under both shocks, only marginally affected due to a shift in domestic prices. $Y$, or GDP, is more affected by the shock to interest rates in Scenario 1 than by property prices in Scenario 2, largely as a result of the limited impact of the property price shock on $C$ and $M$. The rapid rise in interest costs clearly result in a decline in all demand components except for $G$, which is exogenous and therefore remains completely unchanged in all scenarios.

```{r fl-fi-sfc-plot-gdp-indicators-s1-s2, out.width='50%', fig.cap='National income indicators - Scenarios 1 and 2', fig.show='hold'}

plot_gdp_indicators_S1 <- ggplot() +
    shock_1_colours +
    shock_1_legend +
    geom_line(mapping = aes(x = year(Date),
                                     y = Value,
                                     group = Variable,
                                     colour = Variable),
              data = model_data_scenario_diff_perc %>%
                filter(Variable %in% c("Y", "I", "G", "M", "X"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 1",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("C"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 1",
                        Sector == "HH",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("UR"),
                        Price_type == "",
                        Scenario == "Scenario 1",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)),
              lwd = plot_line_width) +
    labs(x = "Year", y = "Pct from baseline", title="Scenario 1",
    caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
    scale_colour_manual(values = randompalette) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical")+
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 4, byrow = FALSE))

plot_gdp_indicators_S1

plot_gdp_indicators_S2 <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                                     y = Value,
                                     group = Variable,
                                     colour = Variable),
              data = model_data_scenario_diff_perc %>%
                filter(Variable %in% c("Y", "I", "G", "M", "X"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 2",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("C"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 2",
                        Sector == "HH",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("UR"),
                        Price_type == "",
                        Scenario == "Scenario 2",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)),
              lwd = plot_line_width) +
    labs(x = "Year", y = "Pct from baseline", title="Scenario 2",
    caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
    scale_colour_manual(values = randompalette) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical")+
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 4, byrow = FALSE))


plot_gdp_indicators_S2

```

As described above, Scenarios 3 and 4 illustrate the compound effect of the two shocks under two different household debt positions. In Scenarios 1 to 3, proportion of fixed-interest debt ($\alpha$) is 38.91\%, in Scenario 4, $\alpha$ is set to 80\%. The primary impact of this shift is a reduction in the sensitivity of household disposable income to a dramatic rise in interest rates.

As expected, the effects of the combination of the two shocks are significantly dampened when $\alpha$ is higher. This is clear from the scales in Figure \ref{fig:fl-fi-sfc-plot-gdp-indicators_s3_s4}, where on the left for Scenario 3, investment drops just below -6\% compared with -5.5\% on the right for Scenario 4. This pattern repeats itself throughout this results section.

```{r fl-fi-sfc-plot-gdp-indicators-s3-s4, out.width='50%', fig.cap='National income indicators - Scenarios 3 and 4', fig.show='hold'}

plot_gdp_indicators_S3 <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                                     y = Value,
                                     group = Variable,
                                     colour = Variable),
              data = model_data_scenario_diff_perc %>%
                filter(Variable %in% c("Y", "I", "G", "M", "X"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 3",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("C"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 3",
                        Sector == "HH",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("UR"),
                        Price_type == "",
                        Scenario == "Scenario 3",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)),
              lwd = plot_line_width) +
    labs(x = "Year", y = "Pct from baseline", title = "Scenario 3",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    scale_colour_manual(values = randompalette) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical")+
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 4, byrow = FALSE))


plot_gdp_indicators_S4 <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                                     y = Value,
                                     group = Variable,
                                     colour = Variable),
              data = model_data_scenario_diff_perc %>%
                filter(Variable %in% c("Y", "I", "G", "M", "X"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 4",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("C"),
                        Price_type == "Real prices",
                        Scenario == "Scenario 4",
                        Sector == "HH",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("UR"),
                        Price_type == "",
                        Scenario == "Scenario 4",
                        Sector == "",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)),
              lwd = plot_line_width) +
    labs(x = "Year", y = "Pct from baseline", title = "Scenario 4",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    scale_colour_manual(values = randompalette) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical")+
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 4, byrow = FALSE))


plot_gdp_indicators_S3
plot_gdp_indicators_S4

```

GDP is also somewhat better protected from the shock in the latter case. The unemployment rate ($UR$) increase is a compound effect of the two shocks, and is also significantly higher in Scenario 3 than in Scenario 4. The number of persons employed are determined by the NFC, and is a function of the level of $Y$ in the previous period and changes in the size of the labour force. Exogenous growth in the size of the labour force combined with a decline in economic activity, drive the proportion of unemployed persons upwards. This also results in a rise in the level of social benefits drawn by HH from GOV, but this will be discussed in the sections for each sector below.

In many of the charts that follow, all scenarios are displayed for each of the variables. This allows for a comparison of the impact of the shocks. The baseline scenario is illustrated by a solid black line, Scenario 1 by a light-grey, dashed line. Scenario 2 by a medium-dark-grey, dashed line. Scenario 3 by the dark-grey short-dashed line and Scenario 4 by the red short-dashed line. 

For each sector we will highlight the components that move most dramatically for shocks 1 and 2, and thereafter will focus on the comparative difference of these effects in Scenarios 3 and 4. This highlights the major transmissions for each shock in each sector. It also allows us to compare the impact of a hypothetical change in the allocation of debt between fixed- and flexible-interest rate products. Essentially we are able to show the impact of financial innovations, within the bounds of the assumptions discussed above.

A summary of the impact of the shocks, as captured by the net financing requirements (Net lending, $NL$) of each sector for each year following the shocks, can be seen in Figure \ref{fig:fl-fi-sfc-plot-nl-S1-S4}. 


```{r fl-fi-sfc-plot-nl-S1-S4, fig.cap = "Net lending",out.width="95%"}

plot_savings_s1_s2 <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("NL"),
                                Price_type %in% c(""),
                                Sector != "",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_savings_s1_s2
```

Base purely on $NL$, as shown in Figure \ref{fig:fl-fi-sfc-plot-nl-S1-S4}, it would appear that HH are net borrowers (have negative $NL$) as a result of the interest rate rise, as might be expected, but rather counter-intuitively[^intuition] move into a strong net lending position following the property price collapse in 2022. ROW moves into positive $NL$ in all scenarios, as does FC, with the exception of Scenario 2, which leaves FC $NL$ unchanged. The scale of the changes in FC's $NL$ are a cause for concern, and will be addressed in the FC section below. NFC and GOV move into negative $NL$ in all circumstances, but NFC has much more erratic movements.

[^intuition]: This result is perfectly logical in the context of the model, but at first glance appears to be illogical. 

For all sectors, Scenario 4 is again similar to Scenario 3, but with significantly less dramatic effects. The next section will help to highlight a problem with a focus purely on $NL$. In summary, such a focus may not be indicative of the actual economic consequences of these shocks for each sector.

For each sector the analysis includes a brief summary the most affected components from each shock, plus a graphical analysis of the most important transmission channels. For Scenario 1, these can be seen in Tables \ref{tab:most-affected-scenario-1-perc-2020-economy} to \ref{tab:most-affected-scenario-1-perc-2020-ROW} for ($t + 1$) 2021, and Tables \ref{tab:most-affected-scenario-1-perc-2023-economy} to \ref{tab:most-affected-scenario-1-perc-2023-ROW} for ($t+3$), which is 2023. 

For Scenario 2, they can be seen in Tables \ref{tab:most-affected-scenario-2-perc-economy} to \ref{tab:most-affected-scenario-2-perc-ROW} for 2022, and Tables \ref{tab:most-affected-scenario-2-perc-2025-economy} to \ref{tab:most-affected-scenario-2-perc-2025-ROW} for ($t+3$), which is 2025. Similar tables can be seen for Scenarios 3 and 4 from Table \ref{tab:most-affected-Scenario-3-perc-economy} to Table \ref{tab:most-affected-Scenario-4-2025-perc-ROW}, where the effects are summarised for the years 2021, which allows for a comparison of the first shock, and 2025, which captures the difference in the compound effect of both shocks.

### Effects for the HH sector

For HH, in 2021, the most obvious effect of the first shock is the increase in interest paid on mortgage debt (or property income paid) of `r Scenario_1_perc_2021_baseline_HH_intext$PIP_IBL_HH`\%. The immediate reduction in transactions for new interest-bearing assets ($\downarrow IBATR^H$) and liabilities ($\downarrow IBLTR^H$) by `r Scenario_1_perc_2021_baseline_HH_intext$IBA_HH_Transactions`\% and `r Scenario_1_perc_2021_baseline_HH_intext$IBL_HH_Transactions`\% respectively, and transactions in equity assets ($\downarrow EQATR^H$) fall by `r Scenario_1_perc_2021_baseline_HH_intext$EQA_HH_Transactions`\%. These are dramatic proportional shifts, largely due to the very low base of the baseline figures. These changes are not only driven by portfolio allocation decisions but also by changes in the real economy, as aggregate demand is reduced due tot he change in interest rates. 

HH investment (gross fixed capital formation, $\downarrow I^H$, which is only houses in this model) falls by `r Scenario_1_perc_2021_baseline_HH_intext$INV_HH`\% and savings by `r Scenario_1_perc_2021_baseline_HH_intext$S_HH`\% (thus the decline in $\downarrow NL$ of around `r Scenario_1_perc_2021_baseline_HH_intext$NL_HH`\%). This follows a decline in disposable income of `r Scenario_1_perc_2021_baseline_HH_intext$Y_D_HH`\% and consequently in consumption of about `r Scenario_1_perc_2021_baseline_HH_intext$C_HH`\%. In terms of stocks, households immediately reduce holdings of IBL by `r Scenario_1_perc_2021_baseline_HH_intext$IBL_HH`\% and IBA by `r Scenario_1_perc_2021_baseline_HH_intext$IBA_HH`\%.

The residual financial flow for HH is transactions in interest bearing assets, $IBATR^H_t$, which are assumed to be deposits. It is directly affected by changes in the level of net lending ($NL^H$), changes in transactions in IBL ($IBLTR^H_t$), transactions in equities ($EQATR^H_t$) and net transactions in pension assets ($PENATR^H_t$). The link between new debt $IBL^H$ and new deposits $IBA^H$ is analogous to the PK theory of endogenous money supply since an increase in debt is associated with an increase in deposits. This is represented in Equation \ref{eq:ibatr_hh_intext}.

\begin{equation}
IBATR^H_t = NL^H + IBLTR^H_t - EQATR^H_t - PENATR^H_t
\label{eq:ibatr_hh_intext}
\end{equation}

The progression of each of these transaction flows is presented in Figure \ref{fig:fl-fi-sfc-plot-hh-indicators-ibatr} below. The decline in $\downarrow IBATR^H$ of `r Scenario_1_perc_2021_baseline_HH_intext$IBA_HH_Transactions`\% is easily discernible. The reader should note that the scale on each plot differs, and the change to $PENATR^H$ is largely irrelevant at less than 1\%, and the declines in $IBLTR^H$, $EQATR^H$ and $IBATR^H$ are of far greater interest. This is appropriate, as each item should be read independently.

Following the dark-grey dotted line describes Scenario 1, where, in all but pension asset transactions, the initial decline is dramatic, but in subsequent years there is a fairly rapid recovery. $IBATR^H$ is represented in the top centre panel, and is the sum of the remaining four items. In Scenarios 1,3 and 4, the interest rate shock results in significant negative savings, but with the introduction of the property price collapse in 2022, for Scenarios 2 to 4, NL swings positive. This is explored further below.

Comparing Scenarios 3 (dark-grey short-dashed line) and 4 (red short-dashed line) reveals that the effect of the combination of the two shocks is 50\% smaller for Scenario 4 after the interest rate shock (shock 1), and roughly 10\% to 20\% smaller for the property shock (shock 2).

```{r fl-fi-sfc-plot-hh-indicators-ibatr, fig.cap = "Households: Transactions in assets", out.width="95%"}

plot_hh_indicators_IBA <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("IBA", "IBL", "EQA", "PENA"),
                                Price_type %in% c(""),
                                Sector == "HH",
                                Transaction_type == "Transactions",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("NL"),
                        Price_type == "",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3",
                                        "Scenario 4"),
                        Sector == "HH",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    geom_hline(yintercept = 0) +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_hh_indicators_IBA
```

The level of net lending $NL^H_t$ is essentially driven by changes in savings ($S^H_t$) and investment levels ($I^H_t$). The changes in net purchases and sales of fixed assets ($NP^H$) and net capital transfers ($KTR^H$) are exogenous, and so do not differ from the baseline (this is repeated for all sectors). The level of net lending for HH is calculated as follows.

\begin{equation}
NL^H_t = S^H_t - I^H_t - NP^H_t + KTR^H_t
\end{equation}

The $I^H$ and $S^H$ components of $NL$ can be seen in Figure \ref{fig:fl-fi-sfc-plot-hh-indicators-nl}. $I^H$ (INV in the plot) recovers in the second period after the shock but then declines again in the fourth. $S^H$ and $NL$ fall by about around 10\% in Scenarios 1 and 3, but only by about half of that for Scenario 4. $I^H$ (which is entirely in houses) declines even more dramatically in Scenarios 2  with the collapse in house prices, and this is compounded with the fall of shock 1 in Scenarios 3 and 4. There is a decline of over 30\% from baseline investment by 2023 when the level of ARM (flexible-rate mortgages) is allowed to remain high in Scenario 3.

```{r fl-fi-sfc-plot-hh-indicators-nl, fig.cap = "Household Net Lending components", out.width = "95%"}

plot_hh_indicators_NL <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("NL", "S", "INV"),
                                Price_type %in% c(""),
                                Sector == "HH",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_hh_indicators_NL
```

Savings ($S^H$) are almost entirely determined by the level of disposable income of HH, and since the tax proportion is held constant, it is the income portion that drives most of the changes. While savings recover in the periods after the shock, investment activity declines further, which is the main driver behind the correction of $NL$. Thus, it is unfortunately a decline in economic activity that allows for the financial recovery. The decline in $I^H$ also means that capital formation fails to offset depreciation, and thus, HH capital levels decline.

Equation (\ref{eq:Yht-text}) describes the incomes and expenditures of HH that ultimately determine the gross income for the sector ($Y^H_t$). The primary sources of which are wages ($WB^H$, W in the plot below), profits ($B2$, which is exogenous), property income (or returns on financial capital, which stems from interest bearing assets, $IBA^H$, pensions, $PENA^H$, and equities, $EQA^H$), and social transfers ($STR^H$, STRA in the plot below).

\begin{equation}
\begin{split}
Y^H_t = & WB^H_t + B2^H_{t} + r^H_{A_{t-1}}(IBA^H_{t-1})\\
        & - r^H_{L(FI)_{t-1}}(IBL(FI)^H_{t-1})\\
        & - r^H_{L(FL)_{t-1}}(IBL(FL)^H_{t-1})\\
        & + \chi _t(EQA^H_{t-1}) + \psi _t(PENA^H_{t-1}) + STR^H_t + \epsilon ^H
\label{eq:Yht-text}
\end{split}
\end{equation}

Interest rates are represented by $r^H$, and the "A" ("L") subscript referring to the assets (liabilities), and ($\chi _t$) and ($\psi _t$) are the rates of return on equities and pensions. As part of the key change in this model, the level of interest paid on $IBL$ in this model is split between fixed and flexible rate mortgages into $r^H_{L(FI)_{t-1}}(IBL(FI)^H_{t-1})$ (PIP-IBL-Fixed, in the plot below) and $r^H_{L(FL)_{t-1}}(IBL(FL)^H_{t-1})$  (PIP-IBL-Flexible, in the plot below). A similar split is present in the financial corporate sector (FC) below.

The $\epsilon ^H$ refers to adjustments made to ensure stock and flow consistency in the level of property income received or paid during the periods where data was available[^adjustmentterm-intext].

[^adjustmentterm-intext]: This convention is used for all sectors. The returns on financial assets are estimated with varying degrees of accuracy for each of the sectors. In order to ensure that the model is consistent in all periods, any difference between the estimated returns and actual returns (on a net basis for each asset class) are added to the adjustment term. These errors in estimation are minimised in the estimation specification for each asset class individually.

Figure \ref{fig:fl-fi-sfc-plot-hh-indicators-y} displays the endogenous components of HH income. Property income received on financial assets, are labelled PIR-EQA for $EQA^H$, PIR-IBA for $IBA^H$, PIR-PENA for $PENA^H$. PIP-IBL is the sum of interest paid on $IBL(FI)^H$ and $IBL(FL)^H$, which is all interest paid on mortgage debt. Also included in the figure are consumption ($C^H$) and income tax ($T^H$, TAX in the plot below).

```{r fl-fi-sfc-plot-hh-indicators-y, fig.cap = "Household income components", out.width="95%"}
plot_hh_indicators_Y <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("Y", "W", "STRA", 
                                                "PIR-EQA", "PIR-PENA", "PIR-IBA", 
                                                "PIP-IBL", "TAX", "C"),
                                Interest_type == "",
                                Price_type %in% c(""),
                                Sector == "HH",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date) %>%
                        rbind(model_data_scenario_diff_perc %>%
                                filter(Variable %in% c("PIP-IBL"),
                                      Price_type %in% c(""),
                                      Interest_type != "",
                                      Transaction_type == "",
                                      Scenario %in% c("Baseline", 
                                                      "Scenario 1", 
                                                      "Scenario 2",
                                                      "Scenario 3",
                                                      "Scenario 4"),
                                      Sector == "HH",
                                      Date > min_date & Date < max_date) %>%
                                mutate(Variable = paste0(Variable, "-", Interest_type)) %>%
                                group_by(Date)),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_hh_indicators_Y
```

The sum of all changes in the model accumulate in the level of $Y^H$ in the bottom right hand panel of Figure \ref{fig:fl-fi-sfc-plot-hh-indicators-y}, Scenario 2 has almost zero impact on $Y^H$, while Scenarios 1, 3 and 4, which include the interest rate change, all result in a significant net decline. PIP-IBL, in the panel to the right of consumption ($C$) in the top left corner, is the total interest paid on debt by HH, and highlights the most dramatic change. It also illustrates the key difference introduced in Scenario 4, which is a reduction in the sensitivity of HH income to changes in interest rates relative to Scenario 3.

The largest contributors to HH income are wages ($W^H$) and social transfers ($STR^H$, STRA in the plot above). Since 2007, approximately 35\% to 37\% of social transfers represent a tax funded pension income, and most of the remainder covers medical and disability support[^STRinDK]. To give a sense of scale, Figure \ref{fig:fl-fi-sfc-plot-hh-indicators-npir} shows the actual values of the major contributors, where NPIR is a net sum of all property income received and paid, and remains positive, but falls by roughly 50\% due to the rise in interest costs on mortgages[^debtspliteffect].

[^debtspliteffect]: The impact of the shift in $\alpha$ can be seen in the two panels to the top right. PIP-IBL-Fixed, and PIP-IBL-Flexible are drastically different in Scenario 4 to all other Scenarios. This is because Scenarios 1 to 3 all keep the baseline allocations of debt between fixed and flexible. The difference from baseline illustrated in Figure \ref{fig:fl-fi-sfc-plot-hh-indicators-y} above are predominantly due to the change in $\alpha$ in 2017 - hence the separation prior to the first shock in 2020.

[^STRinDK]: Based on data from Statistics Denmark, since 2007, approximately 35\% - 37\% of all social benefits
were for old age payments. A further 20\% - 22.3\% are attributed to medical benefits, an almost
constant 14.4\% to disability and 10\% - 13.2\% to family and child benefits. Unemployment (app. 5\%),
social exclusion (app. 5\%), housing (app. 2\%) and survivorship (app. 1\%) benefits making up the balance. The bulk of these transfers can be thought of as supplementary income, rather than unemployment support.

Wages ($W$), taxes ($T^H$, TAX) and consumption ($C$) all decline with $Y^H$.

```{r fl-fi-sfc-plot-hh-indicators-npir, fig.cap = "Household savings components", out.width="95%"}
plot_hh_indicators_npir <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                         filter(Variable %in% c("NPIR", "STRA", "Y-D", "TAX", "C"),
                                Interest_type == "",
                                Price_type %in% c(""),
                                Sector == "HH",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_hh_indicators_npir
```

From this it is possible to see that the rise in $STR^H$ is not sufficient to offset the fall in property income. Scenario 2 is the obvious exception, where income rises marginally. Disposable income ($Y_d$, shown as Y-D above) declines in Scenarios 1 and 3, but in Scenario 4 only stagnates before trending upwards again. The trend in consumption follows the shift in $Y_d$. The effects of the shocks on the HH financial balance sheet can be seen in Figure \ref{fig:fl-fi-sfc-plot-hh-bs}. 

```{r fl-fi-sfc-plot-hh-bs, fig.cap = "Household balance sheet", out.width="95%"}
plot_hh_balancesheet <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("IBA", "PENA", "EQA", "K"),
                                Interest_type == "",
                                Price_type %in% c(""),
                                Sector == "HH",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date) %>%
                        rbind(model_data_scenario_diff_perc %>%
                                filter(Variable %in% c("IBL"),
                                      Price_type %in% c(""),
                                      Interest_type != "",
                                      Transaction_type == "",
                                      Scenario %in% c("Baseline", 
                                                      "Scenario 1", 
                                                      "Scenario 2",
                                                      "Scenario 3",
                                                      "Scenario 4"),
                                      Sector == "HH",
                                      Date > min_date & Date < max_date) %>%
                                mutate(Variable = paste0(Variable, "-", Interest_type)) %>%
                                group_by(Date)),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "horizontal") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_hh_balancesheet
```

The decline in $PENA$ are negligible relative to the baseline, but the decline in capital ($K^H$) that occurs due to the shock to housing prices, has a significant impact on both consumption and investment in subsequent periods. The consequence of the rise in interest rates, and decline in housing investment can be seen in the panel for $K$ above, where Scenario 1 shows a gradual decline relative to the baseline. The impact of a shock to housing prices, however, has a far more dramatic impact in 2022. 

In the scenario three, three years after the compounding of the property price decline, net HH wealth falls by 3.34\%, but this understates the impact on the HH, since, as mentioned in the introduction, net measurements fail to take into account the impact on gross balances. In gross terms, stock of interest bearing liabilities falls by 10.6\%, HH wealth in financial assets falls by 3.55\% while stock of capital held in houses falls by 12.76\%. These are substantial declines in the total level of wealth, but probably overstates the effect on property, since although property prices are allowed rise gradually, the recovery is more gradual that was observed for the Danish economy. The contraction in liabilites is also substantially higher than the modest effect observed over the GFC. One major difference, however, is that HH benefitted from global suppression of interest rates, which would be quite the opposite if interest rates were to rise. 

In summary, on the basis of the model, an interest rate hike and a collapse in property prices would both force the HH balance sheet to contract. The main transmission channel that this would occur through is a direct reduction in disposable income due to debt costs, or the credit channel. It also shows that if it were possible to instigate a change in the composition of debt from flexible- towards fixed-interest products, the lower sensitivity of fixed-rate debt products might protect HH from the majority of these impacts.



### Effects for the NFC sector

The changes in Scenario 1 for NFC are rather limited at first, as can be seen in Table \ref{tab:most-affected-scenario-1-perc-2020-NFC}, but by 2023, as shown in Table \ref{tab:most-affected-scenario-1-perc-2023-NFC}, the effects of the shocks have spread far enough that changes in real economic activity have an impact on the level of employment and output.

In 2021 $NIBTR^N$ falls by `r Scenario_1_perc_2021_baseline_NFC_intext$NIB_NFC_Transactions`\%, which is equal to the fall in $NL$. $S^N$ falls by `r Scenario_1_perc_2021_baseline_NFC_intext$S_NFC`\%, $T^N$ by `r Scenario_1_perc_2021_baseline_NFC_intext$TAX_NFC`\%
and profits ($B2^N$) by `r Scenario_1_perc_2021_baseline_NFC_intext$B2_NFC`\%.

By 2023 the real economy effects feed into NFC, and $NIBTR^N$ has fallen by `r Scenario_1_perc_2023_baseline_NFC_intext$NIB_NFC_Transactions`\%, which is equal to the fall in $NL$. $I^N$ has fallen by `r Scenario_1_perc_2023_baseline_NFC_intext$INV_NFC`\%, and  $S^N$ by `r Scenario_1_perc_2023_baseline_NFC_intext$S_NFC`\%. $T^N$ by `r Scenario_1_perc_2023_baseline_NFC_intext$TAX_NFC`\% and profits ($B2^N$) by `r Scenario_1_perc_2023_baseline_NFC_intext$B2_NFC`\%. The net flow of all property income is `r Scenario_1_perc_2023_baseline_NFC_intext$NPIR_NFC`\% lower and the stock of $NIB^N$ is `r Scenario_1_perc_2023_baseline_NFC_intext$NIB_NFC`\% lower than baseline. There is also a `r Scenario_1_perc_2023_baseline_NFC_intext$K_NFC`\% fall in total capital of NFC.

NFC's residual financial flow is $NIBTR^N$, and the contributors to it are net lending ($NL^N$) and net equity transactions ($NEQTR^N$). Unlike the household sector, the financial activity of the NFC is not modelled directly, and $NEQTR^N$ are therefore exogenously determined for periods where data is available, and revert exogenously to zero for all periods of estimation. $NIBTR^N$ therefore depend only on $NL$.

\begin{equation}
NIBTR^N_t = NL^N_t - NEQTR^N_t
\end{equation}

Net lending again depends on Savings and investment,

\begin{equation}
NL^N_t = S^N_t - I^N_t- NP^N_t + KTR^N
\end{equation}

Investment is estimated in real terms, and is positively dependent on real gross income ($y_{t-i}$), and negatively dependent on the real level of capital ($k^N_{t-i}$), each with a variable number of lags in the estimate[^investmentlagsnfc]. In this context, the proportion, $\Bigg( \frac{y_{t-i}}{k^N_{t-i}} \Bigg)$, represents capacity utilisation. 

[^investmentlagsnfc]: In this versions of the model, $k^N_{t-i}$ and $y_{t-i}$ are both estimated at $t-1$, together with a significant dummy variable for 2009. 

\begin{equation}
ln(i^N_t) = \beta _i + ln\beta _i \Bigg( \frac{y_{t-i}}{k^N_{t-i}}\Bigg)
\end{equation}

```{r fl-fi-sfc-plot-nfc-indicators-nl, fig.cap = "NFC Net Lending components"}
plot_nfc_indicators_NL <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("NL", "S", "INV"),
                                Price_type %in% c(""),
                                Sector == "NFC",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_nfc_indicators_NL
```

The major determinants of investment are therefore the major determinants of GDP, together with previous capital accumulation in NFC (previous capital, plus investment less depreciation). As can be seen in Figure \ref{fig:fl-fi-sfc-plot-nfc-indicators-nl}, $I^N$ (INV in the plot) is fist affected by Scenario 1 (interest rates) in 2022, this the change in NL observable is 2021 is purely due to the decline in savings. Although the shapes of the panels in Figure \ref{fig:fl-fi-sfc-plot-nfc-indicators-nl} are very similar, the scales are quite different. The actual underlying values of each category are also significantly different. Plotted as actual values in Figure \ref{fig:fl-fi-sfc-plot-nfc-indicators-nl-actuals}, the changes would be almost indiscernible from the baseline.

```{r fl-fi-sfc-plot-nfc-indicators-nl-actuals, fig.cap = "NFC Net Lending components"}

plot_nfc_indicators_NL <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                         filter(Variable %in% c("NL", "S", "INV"),
                                Price_type %in% c(""),
                                Sector == "NFC",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable) +
    scale_colour_manual(values = blackpalette_five) +
    scale_linetype_manual(values = plt_line_types_5) +
    scale_y_continuous(labels = scales::comma_format()) +
    geom_hline(yintercept = 0) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_nfc_indicators_NL
```

NFC savings ($S^N_t$), can be calculated as the net sum primary and secondary income and expenditures.

\begin{equation}
\begin{split}
S^N_t = & Y_t - WB^N_t + (B2^N_{t} - B2_{t}) + r^N_{t-1}(NIB^N_{t-1})\\
        & + \chi _t (NEQ^N_{t-1}) - T^N_t + STR^N_t + \epsilon ^N
\end{split}
\end{equation}

$NPIR-NEQ$ and $STRA$ are exogenous, and revert to zero values after the last period of available data, 2017.

```{r fl-fi-sfc-plot-nfc-indicators-saving, fig.cap = "NFC Savings components", fig.asp = 0.6}

plot_nfc_indicators_savings <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("S", "B2", "W", "NPIR-NIB", "TAX"),
                                Price_type %in% c(""),
                                Sector == "NFC",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                                rbind(model_data_scenario_diff_perc %>%
                                        filter(Variable %in% c("Y"),
                                              Price_type == "Real prices",
                                              Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                              Sector == "",
                                              Date > min_date & Date < max_date)) %>%
                                group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_nfc_indicators_savings
```


### Effects for the GOV sector

For Scenario 1, in 2021 $NIBTR^G$ is `r Scenario_1_perc_2021_baseline_GOV_intext$NIB_GOV_Transactions` \% lower than the baseline. The source of this decline can be traced through the plots below. Figure \ref{fig:fl-fi-sfc-plot-GOV-indicators-nl} shows the decline in net lending and savings. 

Contributing to the decline in $NL^G$ is a decline of `r Scenario_1_perc_2021_baseline_GOV_intext$S_GOV`\% in $S^G$. The main contributor to which is a fall in $T^G$ of `r Scenario_1_perc_2021_baseline_GOV_intext$TAX_GOV`\%. The net issue of $IBL$ results in a fall in $NIB^G$ of `r Scenario_1_perc_2021_baseline_GOV_intext$NIB_GOV`\% and for net wealth to decline by `r Scenario_1_perc_2021_baseline_GOV_intext$NW_GOV`\%.

By 2023 the first shock has spread through the economy and $NL$ is `r Scenario_1_perc_2023_baseline_GOV_intext$NL_GOV`\% below the baseline levels. The delayed effect of the change in interest rates is by that stage in effect, and results in a decline in net property income of `r Scenario_1_perc_2023_baseline_GOV_intext$NPIR_GOV`\%. This contributes to a reduced level of $S^G$ of `r Scenario_1_perc_2023_baseline_GOV_intext$S_GOV`\% below. The major contributor is a `r Scenario_1_perc_2023_baseline_GOV_intext$TAX_GOV`\% lower level of tax revenue. 

Social transfers for each sector, $STRA^G$ in the case of GOV, are a net value of receipts less payments. $STRA^G$ declines by `r Scenario_1_perc_2023_baseline_GOV_intext$STRA_GOV`\%, indicating that the level of payments has increased relative to receipts. This contributes further to the negative balance in GOV. The decline in $NIBTR^G$ above accumulates in $NIB^G$ that is `r Scenario_1_perc_2023_baseline_GOV_intext$NIB_GOV`\% lower than the baseline, and net wealth, $NW^G$, that is `r Scenario_1_perc_2023_baseline_GOV_intext$NW_GOV`\% lower.

Shock 2 in 2022, the property price decline, has very little impact on GOV, with only a marginal decline in $S^G$, flowing from limited impacts to the underlying components. $NL^G$ falls by only `r Scenario_2_perc_2022_baseline_GOV_intext$NL_GOV`\%. This since tax revenues are only marginally affected when HH disposable income remains fairly constant, and the ultimate effect on $NIB^G$ is only `r Scenario_2_perc_2022_baseline_GOV_intext$NIB_GOV`\%. In reality this could have been substantially worse if the property price collapse resulted in non-performing loans and GOV was required to step in, as was the case for the banking crisis in Sweden in 1993. [@englund1999]

By 2025, the effects remain modest, with $NL^G$ only `r Scenario_2_perc_2025_baseline_GOV_intext$NL_GOV`\% down from the baseline level, and $NW^G$ only `r Scenario_2_perc_2025_baseline_GOV_intext$NW_GOV`\% lower.

The largest changes in Scenario 1 for GOV in 2021 are in the residual financial flow for GOV, transactions in net interest bearing assets ($NIBTR^G$). These changes come almost entirely from changes in $NL$, another term for which would be a government deficit or surplus, for negative and positive $NL$ respectively. GOV issues debt ($NIBTR^G$) to cover the deficit. These assets are accumulated by FC (below), together with property income flows according to the return on these assets ($r_N$). As can be seen from Equation (\ref{eq:nibtrg_intext}) below, 

\begin{equation}
NIBTR^G_t = NL^G_t
\label{eq:nibtrg_intext}
\end{equation}

Government investment ($I^G$), (and, as with NFC) $NP^G$ and $KTR^G$ are exogenous, so in Equation (\ref{eq:NL_G_intext}) below, it is only changes in savings ($S^G$) that are influential after the shocks in each scenario.

\begin{equation}
NL^G_t = S^G_t - I^G_t - NP^G_t + KTR^G_t
\label{eq:NL_G_intext}
\end{equation}

```{r fl-fi-sfc-plot-GOV-indicators-nl, fig.cap = "GOV Net Lending components", out.width="95%"}

plot_GOV_indicators_NL <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("NL", "S"),
                                Price_type %in% c(""),
                                Sector == "GOV",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_GOV_indicators_NL
```

Equation (\ref{eq:savings_G_intext}) highlights the core components of GOV income. Of these $B2^G$+ net property income received, ($r_{N_{t-1}}(NIB^G_{t-1})$, and NPIR in the plot below) and tax $T^G$ are the incomes received by GOV. Social transfers ($STR^G$, STRA in the plot below) and GOV expenditure ($G$). The exogenous component from the incomes is $B2$, and from expenditure $G$. 

\begin{equation}
S^G_t= B2^G_t + r_{N_{t-1}}(NIB^G_{t-1}) + T^G_t+ STR^G_t - G_t + \epsilon ^G
\label{eq:savings_G_intext}
\end{equation}

```{r fl-fi-sfc-plot-GOV-indicators-savings, fig.cap = "GOV Savings components", out.width="95%"}

plot_GOV_indicators_savings <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                         filter(Variable %in% c("NPIR", "TAX", "STRA"),
                                Price_type %in% c(""),
                                Sector == "GOV",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_GOV_indicators_savings
```

Considering Scenarios 3 and 4, the difference in the impact of shocks is about half as strong for Scenario 4, where $\alpha$ is at 80\%. Scenarios 1 and 3 however result in stronger effects. The impacts to GOV are directly a result of the deterioration in HH cash flows and needs for social support. While $STR^G$ is the expenditure of GOV that flows to HH, based on total net benefit and contribution flows. Rising $STR^G$ expenses are exacerbated by a fall in revenues in the form of both net property income received (NPIR) and taxation $T^G$ (TAX in the plot above.)

### Effects for the ROW sector

The ROW sector is primarily driven by exports, which are exogenous, and imports, which are endogenous to changes in the level of household income. The sharp decline in household income causes an immediate improvement in the current account balance, which is reflected as a negative NL balance for ROW[^whynegativerow]. 

[^whynegativerow]: The flows for ROW are recorded from the perspective of ROW. Thus, if ROW net-lends, it is the same as to say that Denmark net borrows. A positive current account for Denmark is therefore the equivalent of a net borrowing (or, negative net lending) position for ROW.

For shock 1, in 2021, ROW is driven into a further deficit to Denmark, with a decline of `r Scenario_1_perc_2021_baseline_ROW_intext$NIB_ROW_Transactions`\% in  $NIBTR^W$, which captures the `r Scenario_1_perc_2021_baseline_ROW_intext$NL_ROW`\% decline in $NL^W$ and $S^W$. This has a negative effect of `r Scenario_1_perc_2021_baseline_ROW_intext$NW_ROW`\% on the level of net wealth ($NW^W$) held by ROW in Denmark. 

The deficit in $NL^W$ continues to grow, and by 2023 is `r Scenario_1_perc_2021_baseline_ROW_intext$NL_ROW`\% lower than the baseline value. The net flow of property income on all financial assets is lower by `r Scenario_1_perc_2021_baseline_ROW_intext$NPIR_ROW`\%, which reflects a `r Scenario_1_perc_2021_baseline_ROW_intext$NIB_ROW`\% fall in the stock of $NIB^W$. From a balance sheet perspective, there is a decline of `r Scenario_1_perc_2021_baseline_ROW_intext$NW_ROW`\% in net wealth ($NW^W$).

The second shock, to property prices has less of an impact on ROW, with $NIBTR^W$ still lower, but in 2022, this is only by `r Scenario_2_perc_2022_baseline_ROW_intext$NIB_ROW_Transactions`\%. This is again driven by an equal decline in $S^W$, which leads to an equal decline in $NL^W$. The fall in $NIBTR^W$ is reflected as a decline in $NIB^W$ by `r Scenario_2_perc_2022_baseline_ROW_intext$NIB_ROW`\%.

By 2025, the shock has spread through the economy, and the impact on $S^W$, $NL^W$ and $NIBTR^W$ is lower again at `r Scenario_2_perc_2025_baseline_ROW_intext$NL_ROW`\% less than the baseline value. The changes in interest earning assets reduce the level of property income from $NIB^W$ by `r Scenario_2_perc_2025_baseline_ROW_intext$NPIR_NIB_ROW`\%, and from all financial assets by `r Scenario_2_perc_2025_baseline_ROW_intext$NPIR_ROW`\%. The level of $NIB^W$ continues to fall further into deficit by `r Scenario_2_perc_2025_baseline_ROW_intext$NIB_ROW`\% relative to the baseline. After the three year period of accumulative effects, $NW^W$ would be `r Scenario_2_perc_2025_baseline_ROW_intext$NW_ROW`\% lower.

The transmission of these shocks, working backwards from the accumulative effect on transactions in $NIB^W$, begins with Equation (\ref{eq:NIBTR_row_intext}). 

\begin{equation}
NIBTR^W_t = NL^W_t - NEQTR^W_t - NPENTR^W_t
\label{eq:NIBTR_row_intext}
\end{equation}

Equation (\ref{eq:NIBTR_row_intext}) describes the source of changes in $NIBTR^W$, where $NEQTR^W$ and $NPENTR^W$ are exogenous in the model. This leaves only $NL$ as a possible source of change. Unlike the domestic sectors, ROW is assumed not invest in the domestic economy, which means that the net lending function is somewhat simpler, with only savings as the possible source of change.

```{r fl-fi-sfc-plot-row-indicators-nibtr, out.width='70%', fig.cap='ROW: NIBTR: Transactions in assets and net lending', fig.show='hold'}

plot_row_indicators_NIBTR <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("NIB"),
                                Price_type %in% c(""),
                                Sector == "ROW",
                                Transaction_type == "Transactions",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         mutate(Variable = paste0(Variable, "-", Transaction_type)) %>%
                         group_by(Date) %>%
                rbind(model_data_scenario_diff_perc %>%
                        filter(Variable %in% c("NL"),
                        Price_type == "",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3",
                                        "Scenario 4"),
                        Sector == "ROW",
                        Date > min_date & Date < max_date) %>%
                        group_by(Date)),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    geom_hline(yintercept = 0) +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_row_indicators_NIBTR
```

Equation (\ref{eq:NL_row_intext}) highlights the components of $NL$, and much like the previous sectors, only $S^W$ is endogenous in the model.

\begin{equation}
NL^W_t = S^W_t - NP^W_t + KTR^W
\label{eq:NL_row_intext}
\end{equation}

It is therefore only savings that drives changes in $NL$. The total level of $NL$ is then, as mentioned earlier, equivalent to the current account balances - although what is positive in the current account must be negative in the ROW $NL$ account.

\begin{equation}
CAB_t = -NL^W_t
\label{eq:CAB_row_intext}
\end{equation}

Savings are described by Equation (\ref{eq:Savings_row_intext}).

\begin{equation}
\begin{split}
S^W_t = & M_t - X_t+\chi _t(NEQ^W_{t-1}) + \psi _t(NPEN^W{t-1}) + r_{N_{t-1}}(NIB^W_{t-1})\\
        & + WB^W_t - T^W_t +STR^W_t +\epsilon ^W
\label{eq:Savings_row_intext}
\end{split}
\end{equation}

ROW is assumed to be largely independent of developments in the domestic economy, and thus $WB^W$, $\chi _t(NEQ^W_{t-1})$, $\psi _t(NPEN^W{t-1})$, $STR^W$, and $T^W$ are considered to be exogenous. This is with the exception that the rates of return on each of the asset classes is assumed to be the same as those available domestically. The reason for this is that Denmark is a AAA rated country and maintains a fixed exchange rate regime with the EU, and arbitrage keeps rates of return very close to those available in neighbouring Europe.

```{r fl-fi-sfc-plot-row-indicators-savings, fig.cap = "ROW Savings components", out.width="95%"}

plot_row_indicators_savings <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("NPIR", "NPIR-NIB"),
                                Price_type %in% c(""),
                                Sector == "ROW",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date) %>%
                rbind(model_data_scenario_diff_perc %>%
                         filter(Variable %in% c("X", "M"),
                                Price_type %in% c(""),
                                Sector == "",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date)),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_row_indicators_savings
```

Imports ($M$) from the model are a revenue for ROW and exports ($X$) an expenditure. The return on net interest bearing stocks, $r_{N_{t-1}}(NIB^W_{t-1})$, (NPIR-NIB in the plot above) depends on whether $NIB^W$ is positive or negative.

Imports are estimated in real terms in the log-linear form in Equation (\ref{eq:imports_intext}), and depend on the level of domestic demand in the previous period, and a relative price index between domestic and foreign goods from the previous period $\Bigg( \frac{P^y_{t-1}}{P^m_{t-1}} \Bigg)$.

\begin{equation}
ln(m_t) = \beta _i + \beta _iln \Bigg( \frac{P^y_{t-1}}{P^m_{t-1}} \Bigg) + \beta _iln(c_{t-1} + i_{t-1} + x_{t-1})
\label{eq:imports_intext}
\end{equation}

As noted by @byrialsenraza2019empirical, the "export function is based on the
Armington (1969) model where the market share of the Danish exports is explained by
relative prices."

This relation is captured below as annual Danish exports relative to a weighted index
of all trading partners ($m^W_t$), which should be determined by domestic prices
(the export price index, $P^x_t$) relative to foreign prices (the import price
index, $P^m_t$), but moderated by price elasticity ($\beta$).

\begin{equation}
\frac{x_t}{m^W_t} = \Bigg( \frac{P^x_t}{P^m_t}\Bigg)^ \beta
\end{equation}

Exports thus stay relatively stable in the model, and are only affected by minor changes in the relative price ratio. The lower right panel in Figure \ref{fig:fl-fi-sfc-plot-row-indicators-savings} above is a little deceptive, as the scale is very small. The most important change for ROW is a strong decline in Danish imports, which is primarily driven by the fall in HH disposable income

### Effects for the FC sector

FC absorbs all of the imbalances in the other four sectors, and the relatively extreme shock to interest rates culminates in large changes to each. Transactions in net interest bearing assets, $NIBTR^F$, are simply an inversion of the accumulation of $NIBTR$ in three of the four sectors (GOV, NFC and ROW), and $IBLTR^{F\sim H}$ is a reflection of household accumulation of deposits, $IBATR^H$.

\begin{equation}
NIBTR^F_t = -(NIBTR^N_t + NIBTR^G_t + NIBTR^W_t )
\label{eq:nibtr_f_intext}
\end{equation}

The second, and rather indirect accumulation is that of equities to offset any equity investment by HH. The full explanation is available in the appendix, in Section \ref{sec:fi-fl-sfc-model-eq-f}. An abbreviated summary is that all other components of Equation (\ref{eq:neqtr_fc_intext}) are accounted for by accounting identities between FC and the other sectors, and the value of $EQATR^H$ is carried into FC via $IBLTR^{F\sim H}$. Once all other terms are netted out, the $NEQTR^F$ value is equivalent to $EQATR^H$. This equivalence is the redundant equation in the model, and is not specified in order to avoid over-identification.

\begin{equation}
NEQTR^F_t = NL^F_t + IBLTR^{F\sim H}_t + PENLTR^F_t - IBATR^{F\sim H}_t - NIBTR^F_t
\label{eq:neqtr_fc_intext}
\end{equation}

Because $NIBTR^F$ captures the net flows of all other sectors, it also represents any excess or shortfall (i.e. net lending) experienced by FC. This is because all flows of all other sectors with each other will already be captured and netted out by the sum of their $NIBTR$ in Equation (\ref{eq:nibtr_f_intext}) above. The only unaccounted for flow is the net value of FC flows, which is captured in $NL^F$. Again, $NP^F$, $I^F$[^fcinvest] and $KTR^F$ are exogenous.

[^fcinvest]: FC investment is assumed to grow at a constant 2\% per annum.

\begin{equation}
NL^F_t = S^F_t - I^F_t - NP^F_t + KTR^F_t
\end{equation}

Rather than show the percentage changes, Figure \ref{fig:fl-fi-sfc-plot-fc-indicators-nl} shows the actual increase in FC NL and savings as a result of the shocks in each scenario. As can be seen, the impact of the second shock is almost negligible. Scenarios 1 and 3 are almost identical, and Scenario 2 remains very close to the baseline level. It is thus the interest rate change that has the dominating effect on FC's flows and thus balance sheet. It should be unsurprising therefore that there is a substantial difference between Scenarios 3 and 4. In Scenario 4, where a greater portion of HH debt is *less* sensitive to changes in interest rates, the transfer of wealth from HH to FC is substantially reduced.

```{r fl-fi-sfc-plot-fc-indicators-nl, fig.cap = "FC Net Lending components", out.width="95%"}

plot_fc_indicators_NL <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                         filter(Variable %in% c("NL", "S"),
                                Price_type %in% c(""),
                                Sector == "FC",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    geom_hline(yintercept = 0) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fc_indicators_NL
```

From a very low base, $NL^F$ rises by `r Scenario_1_perc_2021_baseline_FC_intext$NL_FC`\%, or is roughly five and a half times larger. The shifts in the values of the underlying FC components are sensibly also substantial. Transactions in most assets are net positive, and in liabilities negative - both relative to the baseline and in absolute terms.

The exception is a decline in loan assets as HH deleverage in 2021 by `r Scenario_1_perc_2021_baseline_FC_intext$IBL_FC_HH`\%. Apart from this single entry, HH borrowing is positive in all periods. Relative to the baseline after the first shock, $IBLTR^{F\sim H}$ is down by `r Scenario_1_perc_2021_baseline_FC_intext$IBL_FC_HH_Transactions`\%, and $IBATR^{F\sim H}$ is down by `r Scenario_1_perc_2021_baseline_FC_intext$IBA_FC_HH_Transactions`\%. FC is a net issuer of equity and interest bearing assets, with transactions in equity, $NEQTR^F$, up `r Scenario_1_perc_2021_baseline_FC_intext$NEQ_FC_Transactions`\%, and in $NIB$ up `r Scenario_1_perc_2021_baseline_FC_intext$NIB_FC_Transactions`\%. FC thus begins to accumulate assets rapidly.

In terms of property income flows, the rise in interest rates in this example is only allowed to affect the asset returns of FC, and thus the net increase is more extreme than if we adjusted all rates of return. The total net property income received by FC, $NPIR^F$, is `r Scenario_1_perc_2021_baseline_FC_intext$NPIR_FC`\% higher. This comes from the increase in fixed and flexible rate interest receipts, which rise by `r Scenario_1_perc_2021_baseline_FC_intext$PIR_IBA_FC_HH_Fixed`\%, and `r Scenario_1_perc_2021_baseline_FC_intext$PIR_IBA_FC_HH_Flexible`\% respectively.

As noted above, FC accumulates assets rapidly. $NEQ^F$ rises by `r Scenario_1_perc_2021_baseline_FC_intext$NEQ_FC`\% and $NIB^F$ by `r Scenario_1_perc_2021_baseline_FC_intext$NIB_FC`\%. The fall in $IBA^{F\sim H}$ by `r Scenario_1_perc_2021_baseline_FC_intext$IBA_FC_HH`\% and in $IBL^{F\sim H}$ by `r Scenario_1_perc_2021_baseline_FC_intext$IBL_FC_HH`\% almost offset each other entirely, and the final impact on net wealth of FC is an increase of `r Scenario_1_perc_2021_baseline_FC_intext$NW_FC`\%.

Equation (\ref{eq:S_fc_intext}) highlights the income and expenditure components that contribute to FC savings, and Figure \ref{fig:fl-fi-sfc-plot-fc-indicators-saving} illustrates these components in nominal values. 

\begin{equation}
\begin{split}
    S^F_t = & B2^F_t \\
            & + r^F_{A(FI)_{t-1}}(IBA^{F\sim H}_{A(FI)_{t-1}}) + r^F_{A(FL)_{t-1}}(IBA^{F\sim H}_{A(FL)_{t-1}}) \\
            & - r^F_{L_{t-1}}(IBL^{F\sim H}_{L_{t-1}}) + r_{N_{t-1}}(NIB^F_{t-1}) \\
            & + \chi _t(NEQ^F_{t-1}) -\psi _t(PENL^F_{t-1}) - T^F_t + STR^F_t - CPEN^F_t + \epsilon ^F
\end{split}
\label{eq:S_fc_intext}
\end{equation}

From Equation (\ref{eq:S_fc_intext}), $B2^F$ and $T^F$ are exogenous, and the change in FC output, $Y^F$, is less than -1\%. Nominal values are illustrated here in order to give better context to the changes implied by the shocks. The percentage changes that are discussed above for Scenario 1 do not appear to be as unrealistic when viewed in these terms.

```{r fl-fi-sfc-plot-fc-indicators-saving, fig.cap = "FC Savings components", fig.asp = 0.9}

plot_fc_indicators_savings <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                                filter(Variable %in% c("PIR-IBA"),
                                       Interest_type %in% c("Fixed", "Flexible"),
                                       Price_type == "",
                                       Scenario %in% c("Baseline", 
                                                        "Scenario 1", 
                                                        "Scenario 2",
                                                        "Scenario 3",
                                                        "Scenario 4"),
                                       Sector == "FC",
                                       Date > min_date & Date < max_date) %>%
                                mutate(Variable = paste0(Variable, "-", Interest_type)) %>%
                                rbind(model_data_actuals %>%
                                     filter(Variable %in% c("S", "NPIR-NIB", 
                                                            "NPIR-NEQ", "PIP-PENL", "PIP-IBL",
                                                            "NPIR"),
                                            Price_type %in% c(""),
                                            Interest_type == "",
                                            Sector == "FC",
                                            Transaction_type == "",
                                            Scenario %in% c("Baseline", 
                                                            "Scenario 1", 
                                                            "Scenario 2",
                                                            "Scenario 3",
                                                            "Scenario 4"),
                                            Date > min_date & Date < max_date)) %>%
                                rbind(model_data_actuals %>%
                                        filter(Variable %in% c("Y"),
                                              Price_type == "Real prices",
                                              Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                              Sector == "",
                                              Date > min_date & Date < max_date)) %>%
                                        group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Pct from baseline",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    geom_hline(yintercept = 0) +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "horizontal") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fc_indicators_savings
```

The panel titled net property income (NPIR) in the plot above is a sum of all property income flows, and is similar to Equation (\ref{eq:S_fc_intext}) above for $S^F$, but with all other terms removed. The total impact on property income helps to identify the source of changes in FC savings. NPIR is calculated as follows.

\begin{equation}
\begin{split}
    NPIR^F_t = & + r^F_{A(FI)_{t-1}}(IBA^{F\sim H}_{A(FI)_{t-1}}) + r^F_{A(FL)_{t-1}}(IBA^{F\sim H}_{A(FL)_{t-1}}) \\
               & + r_{N_{t-1}}(NIB^F_{t-1}) + \chi _t(NEQ^F_{t-1})  \\
               & -\psi _t(PENL^F_{t-1}) - r^F_{L_{t-1}}(IBL^{F\sim H}_{L_{t-1}})
\end{split}
\label{eq:NPIR_fc_intext}
\end{equation}

The bulk of FC flows are property income paid (PIP), property income received (PIR), or NPIR. The representations in Figure \ref{fig:fl-fi-sfc-plot-fc-indicators-saving} above are categories of these property income flows. NPIR-NEQ for $\chi _t(NEQ^F_{t-1})$ (on equities), NPIR-NIB for $r_{N_{t-1}}(NIB^F_{t-1})$ (on net interest bearing assets with all sectors other than HH), PIR-IBA-Fixed for $r^F_{A(FI)_{t-1}}(IBA^{F\sim H}_{A(FI)_{t-1}})$ (on fixed-rate HH debt), PIR-IBA-Flexible for $r^F_{A(FL)_{t-1}}(IBA^{F\sim H}_{A(FL)_{t-1}})$ (on flexible-rate HH debt), PIP-IBL for $r^F_{L_{t-1}}(IBL^{F\sim H}_{L_{t-1}})$ (on deposit liabilities).

The shock to interest rates in Scenarios 1, 3 and 4 all result in positive NPIR for FC. The substantially lower level of NPIR in Scenario 4 (the red line) can be traced back to PIR-IBA-Fixed and PIR-IBA-Flexible. The sum of the total revenue generated by the rise in interest rates is the summarised in NPIR. The steady decline of net return on equities, NPIR-NEQ, is due to the systematic issuance of equity to HH as HH demands equity. This demand is retarded slightly in all scenarios. Equity investment by HH is dependent on previous returns, previous returns on house investment and previous changes in the quantity of loans acquired. For  both shock 1 and 2, it is due to the reduction in $IBLTR^H$ and for shock 2 it is also driven by a fall in returns on houses.

The effect on FC savings, $S^F$, is to triple the value in Scenarios 1 and 3, and double the value in Scenario 4. 

```{r fl-fi-sfc-plot-FC-bs, fig.cap = "FC balance sheet", out.width="95%"}
plot_FC_balancesheet <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                         filter(Variable %in% c("IBL", "IBA", "PENL", "NIB", "NEQ"),
                                Interest_type == "",
                                Price_type %in% c(""),
                                Sector == "FC",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > min_date & Date < max_date) %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "DKK Millions",
       caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_FC_balancesheet
```


<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->

## Discussion {#sec:fi-fl-sfc-discussion}

As noted in Section \ref{sec:fi-fl-rk-dk}, many of the innovations that occurred around the world during the past decades also occurred in the Danish mortgage lending system. In addition, since the GFC, interest rates have reduced to and remained at historically low levels. These conditions provided the platform for rapid expansion of household mortgage debt leading up to the crisis, and to continued expansion of that debt in more recent years. This has coincided with the rapid recovery and inflation of asset prices. Property prices are discussed in Section \ref{sec:fi-fl-sfc-scenarios-s2} above, and as can be seen from panel (a) in Figure \ref{fig:fl-fi-sfc-plot-dk-equity-int}, Danish equity prices (the yellow line) have risen over 230\% from 2010 to 2018, with only one other European country (Latvia, the blue line) with a higher increase in its equity price index.

The main effects of the innovations that occurred were a reduction in initial payments for borrowers, a decline in the level of payments towards the outstanding principal debt (and thus a decline in the level of equity accumulation) and a significant shift of risk from investors to lenders. Danish HH responded rapidly to the innovations, and the composition of debt changed from 100\% fixed interest debt, in 2000 to less than 30\% by 2012, as can be seen in panel (b) of Figure \ref{fig:fl-fi-sfc-plot-dk-equity-int}[^earlymoveinalpha].

[^earlymoveinalpha]: The gradual shift out of fixed interest bonds prior to 2003 is due to the introduction of index-linked bonds, which made up a relatively small share of less than 10\% the market, and this share reduced rapidly after 2003. There has also been a gradual move back towards more fixed-interest rate products since 2012.

```{r fl-fi-sfc-plot-dk-equity-int, fig.cap = "Share prices and mortgage composition", out.width="95%"}
DK_share_prices <- ggplot() +
    geom_line(data = OECD_SP_all_long %>%
                mutate(Country = geo) %>%
                select(-geo),
                     mapping = aes(x = factor(obsTime),
                                   y = Values,
                                   colour = Country,
                                   group = Country),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Share price index, 2010=100",
         title="European share price indices",
       caption = "Source: OECD") +
    scale_y_continuous(labels = scales::comma_format()) +
  scale_color_manual(values = c("grey","grey","grey","grey","grey",
                   "#ffc100","#691e36","grey","grey","grey",
                   "grey","grey","grey","#497840","grey",
                   "grey","#443eff","grey","#0bb3b0","grey",
                   "grey","grey","grey","grey","grey",
                   "grey","grey","grey")) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 3, byrow = FALSE))
DK_share_prices

plot_alpha <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                         filter(Variable %in% c("ALPHA"),
                                Price_type %in% c(""),
                                Sector == "",
                                Transaction_type == "",
                                Scenario %in% c("Baseline", 
                                                "Scenario 1", 
                                                "Scenario 2",
                                                "Scenario 3",
                                                "Scenario 4"),
                                Date > "1995-01-01" & Date < "2026-01-01") %>%
                         group_by(Date),
                     mapping = aes(x = year(Date),
                                   y = Value,
                                   group = Scenario,
                                   colour = Scenario,
                                   lty = Scenario),
                lwd = plot_line_width) +
    labs(x = "Year", 
         y = "Alpha, Percentage of debt\n as fixed-interest products",
         title = "Fixed-interest share of debt",
       caption = "Source: Statistics Denmark and present model forecast") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    geom_hline(yintercept = 0) +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_alpha

```

The major benefits of fixed interest products include stability of expenditures, insulation against unforseen interest rate hikes, and the possibility to refinance at various favourable instances (stemming from the buy-back, and prepayment rights assigned to borrowers [@Skinhoj2019]). Flexible interest rate products on the other hand, provide low initial cost of borrowing, but transfer interest rate risk to the borrower. Revisions to the coupon rate on the counter-balancing bonds also create a significant opportunity cost for ARM borrowers if rates rise. This is opportunity cost is enhanced if it is a distressed borrower, or the borrower faces negative shocks, such as a loss of income or an injury. A fixed rate borrower (even without amortization) would be able to accept a lower sale value for their property, since the bond that represents the outstanding debt would reprice downwards as interest rates rise. In the case of an interest rate increase, flexible rate borrowers face the same possibility of unfavourable property market conditions, but the price of bonds outstanding will remain relatively constant, due to the re-setting of the short-term fixation of coupon payments. Flexible rate borrowers, and borrowers with interest-only periods thus face a much higher risk of falling into negative equity if house prices fall.

Many of these dynamics are captured in the model presented in this article, as are several economic relationships between the real and financial sides of the economy. These connections make it possible to show some of the expected "real" economic feedback effects of each shock. Although it is a highly simplified version of the Danish mortgage market, it is still able to provide a realistic scale for the core transmission channels for each of the shocks, and due to the simple structure of the model, it was relatively easy to incorporate a split in the composition of debt of HH.

One of the goals at the outset was to test the sensitivity of HH balance sheets for different compositions of debt. Two shocks were introduced across four scenarios. The primary effect of the first shock, an increase in interest rates by 2\% in 2020, was an immediate reduction in HH income. The primary effect of the second shock, a decline in property prices by 20\% in 2022, was to reduce the level of HH capital and the attractiveness of housing as an investment alternative. These two shocks were then compounded in Scenarios 3 and 4, but in Scenario 4 the level of debt held in fixed-interest products ($\alpha$) was increased from around 37\% to 80\%, as shown in panel (b) of Figure \ref{fig:fl-fi-sfc-plot-dk-equity-int} above.

The model behaved as expected, and in Scenario 3, with the higher proportion of ARMs, HH are exposed to significantly greater income volatility than in Scenario 4, a result that is corroborated by @DanmarksNationalbank2016a and @Skinhoj2019. This transmits to both the real and financial sides of the economy, with lower economic output and higher unemployment as a result of the increased sensitivity. The results in Section \ref{sec:fi-fl-sfc-simulations} above suggest that for a significant rise in interest rates, or a collapse in property prices, HH would be in a more favourable financial position as a sector if the proportion of mortgage debt held in fixed-interest products ($\alpha$) was higher. This suggests that policies with a focus on increasing the coverage of fixed-interest-rate products in the mortgage financing system would result in a more resilient HH, and economy as a whole.

The specific movements of variables, however, should be interpreted with caution, as the shocks in this model are not designed to provide a comprehensive economic response within the model structure. Especially since it is only the rates that affect the cost of borrowing that are adjusted in shock 1.

In terms of the transmission channels in the model, HH is a key driver. The primary transmission channel in the interest rate shock is the credit channel, and it is clearly more impactful where interest rates are more sensitive. In a more realistic setting, the rise in interest rates would also affect HH incomes positively. In Denmark, pension funds hold a large portion of the outstanding covered covered bonds on behalf of households, and fees of the mortgage lending companies are generally a fixed rate. This would mean that increased mortgage costs should translate directly to increased pension incomes. HH pension assets are also substantially larger than HH debt, which means that if an interest rate hike resulted in a rise of the rates of return on most asset classes, then HH could experience a net gain. One argument against this is that pension assets are not directly accessible, and therefore would not contribute to short term disposable income of HH. HH in this case do not have discretion over the consumption of all wealth, and therefore those parts that are inaccessible should be excluded.

The current form of the model is also important to consider. Presently, HH consume out of wealth, and there is a positive return on $IBA$, which are assumed to be deposits. If we adjust the rate of return on $IBA$ ($r^H_N$) upwards, it would change relative rates of return available for HH investment allocation, and would lead to a rapid accumulation of $IBA$. It would also drive a large positive effect on HH income, which would conceal the negative effects to disposable income that are displayed in the current form. This would, at least in the short run, not be in line with realistic expectations regarding accessible disposable income of HH.

Even if other asset class returns are adjusted to mitigate the fall in HH disposable income, investment will necessarily be lower as the cost of borrowing rises. In the case of an interest rate rise, aggregate demand and output would still decline, pushing unemployment upwards and providing downward pressure on the wage rate. after several years, the relative improvement in competitiveness in export prices would have a positive influence on exports and negative on imports. Ultimately this would strengthen the current account balance, but at the expense of higher unemployment in the domestic economy. The positive feedback of rising imports on wage income and output would depend on the elasticities of wages to changes in output, and imports and exports to relative price changes. The effect of a fall in house prices on housing investment would also remain in the short-term, as it is dependent on previous returns.

Another transmission channel that would be concealed is the negative pressure that a fall in demand has on the tax base, and therefore on GOV revenues. In the analysis above, it is clear that the fall in overall demand would lead to a fall in employment, a fall in tax revenues and therefore a large negative shift in the GOV net financing requirement. If the Danish GOV enforces a balanced budget, there would need to be a reduction in GOV spending, and the vast majority of this spending is split between a tax funded pension scheme, healthcare, disability support, family and child support. A reduction in any of these categories would result in a further reduction of output and ultimately in HH income.

Even with the simplifications, it should be safe to conclude that larger portions of debt in fixed-interest products would result in much lower volatility of HH disposable income. The use of a more comprehensive model, rather than a simple test of income volatility, allows us to observe the expected accumulation effects of the two shocks for different levels of $\alpha$. The exogeneity of asset prices and rates of return are potential drawbacks, however, it is not obvious that creating endogenous links between financial markets, assets and rates of return (i.e. a more integrated financial sector) would be an improvement on the current model structure. At present, the most immediate transmission channels for each of the shocks are transparent, and because of the empirical nature of the model, it is possible to get an accurate scale of the initial effects of the shocks, without the complication of complex interdependencies between markets. There is a clear trade-off between complexity with greater accuracy, and better interpretability with greater transparency.

The more complete macroeconomic SFC model presented above requires attention to the gross levels of economic stocks and flows, and thus makes it possible to identify that the rise in HH $NL$ following the second shock (the fall in property prices) was not due to positive changes in HH. Contrarily, HH experienced a decline in investment demand, together with rising unemployment. The model presented here helps to prevent such misinterpretations, and to provide a more complete picture of the possible impact of shocks[^additionalcontribution].

[^additionalcontribution]: In addition to the alterations made, the output of the model is presented in an alternative format. The tables in the appendix provide an exhaustive list of all elements applicable to each sector that are affected by each shock. This cross-section provides at least two things to the modeller. Firstly it identifies the components applicable to each sector that are most dramatically impacted. Secondly, the comprehensive list of affected components expand as a shock propagates through the economy and assists in the identification of timing errors in the model structure.

The model unfortunately does not presently incorporate some key issues from the mortgage system, including the effect of changes in loan-to-value (LTV) ratios, or second round credit risk effects that might occur due to loss of income due to unemployment. The inclusion of a measure of non-performing loans or some other measure of credit risk might be able to capture these effects. Perhaps the most relevant omission, for the present discussion, is the effect of refinancing behaviour on the composition of debt, although this is not a simple matter to include, as noted by @Skinhoj2019 [pp. 19], "The stochastic modelling of prepayment behaviour is a complex task and is outside the scope for most international investors." 

The possibility to explore a variety of modifications and alterations is also one of the major benefits that the baseline version of the model offers. It has made it possible to explore some of the complex economic feedback mechanisms described above. This version is also under continuous development by the MaMTEP group[^MaMTEPgroup], and as additional economic components are explored in greater detail it will be possible to include any alterations that strengthen the core structure. 

[^MaMTEPgroup]: The Macroeconomic Methodology, Theory and Economic Policy Research Group, Aalborg University.

<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->

## Conclusion {#sec:fi-fl-sfc-conclusion}

The Danish mortgage financing system has experienced several innovations in recent decades. Collectively these innovations have had a variety of benefits for borrowers, but these come with a transfer of responsibility and risk to the borrower. One of the most prominent innovations was the introduction of adjustable rate mortgages (ARMs) with periods of interest fixation of a variety of lengths.

Access to individual level administrative data-sets allowed for the construction of aggregate outstanding mortgage data from 2009 to 2017, and highlights the increased concentration of flexible-rate mortgage debt. By the end of 2017, after the introduction of ARM products, approximately 63\% of all mortgage debt outstanding was subject to an interest rate adjustment within 5 years. These products were collectively considered to be flexible-interest rate products in the analysis above, and the remaining debt considered to be fixed rate.

The model in this article was adapted from @byrialsenraza2019empirical to explore the effects of this shift on the stability of incomes and balance sheets of the Danish economy. The primary innovation in the model was to introduce the split in debt, and to test the effect of the changes on the overall sensitivity of incomes and balance sheets, with a particular focus on HH. There are some additional changes that could be incorporated in future versions of the model that might strengthen the outputs of the model. Firstly, additional data could be sourced to provide a further split in HH debt between mortgage institute, bank and consumer debt. Secondly, it might be possible to actively model the refinancing behaviour of Danish property buyers[^nodataavailable]. It might also be possible to include some measure of credit supply constraints, and or borrower risk, for example, non-performing loans. Further developments of the model could make this possible.

[^nodataavailable]: There is unfortunately no data available at an individual level that would be representative of a rising interest rate environment.

The core aim of the analysis was to test the sensitivity of HH and economic conditions of a potential shift in the composition of debt from ARM type products to fixed-interest products. This is an intuitively simple proposition, but the accurately scaled empirical model presented in this article provides a clear indication of the potential scale of these impacts. For a shift in the fixed proportion from 37\% up to 80\%, in the case of a 2\% point increase in interest rates and a 20\% decline in property prices, the difference in aggregate unemployment effects could be as much as 2\%. The effects discussed for each sector mirror this increase in sensitivity. Both in the initial effects and in terms of volatility in subsequent periods. 

The results thus provide evidence to support reports made by the IMF [@sheehy2014], the Danish national bank [@DanmarksNationalbank2016a] and the leading mortgage credit institution in Denmark, Nykredit Realkredit [@Skinhoj2019], that the increased concentration of household debt in ARM (flexible-rate) products has resulted in greater sensitivity (and thus less stability) of both HH and the Danish economy in general. This does not imply that the level of outstanding debt poses a systemic economic risk. Again in support of reports presented by the above institutions, it should be noted that simultaneous and sizable shocks to both the cost of borrowing and to property prices only resulted in modest effects on overall output, even where the shock is restricted to borrowing costs.

In contrast to suggestions regarding the systemic risk of household debt in itself, the analysis suggests that the potential risks related to the present high ratio of HH debt to disposable income in Denmark can be dramatically reduced through a migration of HH mortgage debt away from ARM type products towards fixed interest rate products. The all-time low levels of interest rates that are currently available also present an excellent opportunity to support this transition.

<!-- ################################ New Chapter ################################ -->
<!-- ################################ New Chapter ################################ -->


## Appendix {#sec:Appendix}

### Mortgage debt as a percentage of total loans to non-financial private sector (nominal, local currency) {#sec:fi-fl-sfc-Ap-A-MtoL}

```{r fl-fi-sfc-lt-debt, fig.cap = "Mortgage debt as percentage of total loans"}

plot_mort_debt_to_debt <- ggplot(data = historical_data %>%
                       filter(year > 1960) %>%
                       select(year, geo, tloans, tmort) %>%
                       group_by(year),
                   mapping = aes(x = year,
                                 y = tmort/tloans)) +
    labs(x = "Year", 
         y = "Mortgage debt to total loans to non-financial private sector",
        caption = "Source: Jordà, Schularick and Taylor (2017)") +
    facet_wrap(~geo, scales = "free") +
    geom_line(lwd = plot_line_width) +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "horizontal") +
    legend_bottom_right_inside
plot_mort_debt_to_debt

# ggsave(plot = plot_mort_debt_to_debt, filename = "./Data/sfc_fi_fl/Charts/mort_debt_to_debt.pdf",width = 10, height = 8)
#
# knitr::include_graphics("./Data/sfc_fi_fl/Charts/mort_debt_to_debt.pdf")
```


### Mortgage debt to GDP {#sec:fi-fl-sfc-Ap-A-MtoGDP}

```{r fl-fi-sfc-hh-debt, as.is = TRUE, fig.cap = "Mortgage debt to GDP"}
plot_hh_debt_to_debt <- ggplot(data = historical_data %>%
                       filter(year > 1960,
                              !geo %in% c("AU", "CA", "CH", "GB")) %>%
                       select(year, geo, tmort, gdp) %>%
                       group_by(year),
                   mapping = aes(x = year,
                                 y = tmort/gdp)) +
    labs(x = "Year", 
         y = "Mortgage debt to GDP",
        caption = "Source: Jordà, Schularick and Taylor (2017)") +
    facet_wrap(~geo, scales = "free") +
    geom_line(lwd = plot_line_width) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "horizontal")+
    legend_bottom_right_inside

plot_hh_debt_to_debt

# ggsave(plot = plot_hh_debt_to_debt, filename = "./Data/sfc_fi_fl/Charts/hh_debt_to_debt.pdf",width = 10, height = 8)
#
# knitr::include_graphics("./Data/sfc_fi_fl/Charts/hh_debt_to_debt.pdf")
```


### House Prices  {#sec:fi-fl-sfc-Ap-A-OECD-house-prices}

```{r oecd-house-price-table, as.is=TRUE}
OECD_proportion_shift %>%
          select(-Growth, -geo) %>%
          mutate(Value = paste0(str_pad(sprintf("%.2f", round(Values*100,digits=2)), 5, pad = "0"), "\\%")) %>%
          select(-Values) %>%
          spread(key = obsTime, value = Value) %>%
          arrange(desc(.[[4]])) %>%
  kbl(caption = "OECD House price index changes, Year on year") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


```{r oecd-house-prices, fig.cap="OECD house prices: Year-on-year changes"}
##################################################################################
# OECD house prices
##################################################################################

# plot_OECD_house_prices <- ggplot(data = OECD_house_prices %>%
#                                      filter(obsTime %in% (2000:2018),
#                                             geo %in% unique(historical_data$geo)),
#                                  mapping = aes(x = obsTime,
#                                                y = Values,
#                                                group = Country,
#                                                colour = Country)) +
#     labs(x = "Year", y = "Real house prices, Base = 2000") +
#     scale_colour_manual(values = distinctColorPalette(k = length(unique(OECD_house_prices$Country)),
#                                                       altCol = FALSE, runTsne = FALSE)) +
#     geom_line(lwd = plot_line_width) +
#     theme_minimal() +
#     theme(text = element_text(size = 10),
#           axis.text.x = element_text(angle=90, vjust=0.5), legend.position="bottom")
#
# plot_OECD_house_prices
library(randomcoloR)
plot_OECD_house_prices_prop_shift <- ggplot(data = OECD_proportion_shift %>%
                                     filter(geo %in% unique(historical_data$geo)),
                                 mapping = aes(x = obsTime,
                                               y = Values,
                                               group = geo,
                                               colour = geo),
                                 lwd = plot_line_width) +
    labs(x = "", 
         y = "Total YOY index change",
        caption = "Source: OECD data, data.oecd.org") +
    scale_colour_manual(values = distinctColorPalette(k = length(unique(OECD_house_prices$Country)),
                                                      altCol = FALSE, runTsne = FALSE)) +
    geom_line(lwd = plot_line_width) +
    facet_wrap(~Growth) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "horizontal")+
    legend_top_right_inside

plot_OECD_house_prices_prop_shift

```


```{r oecd-house-prices-facet, fig.cap="OECD house prices: Real price index"}
##################################################################################
# OECD house prices
##################################################################################

plot_OECD_house_prices <- ggplot(data = OECD_house_prices %>%
                                     filter(obsTime %in% (1990:2018),
                                            geo %in% unique(historical_data$geo)),
                                 mapping = aes(x = obsTime,
                                               y = Values)) +
    labs(x = "Year", y = "Real house prices, Base = 2000",
        caption = "Source: OECD data, data.oecd.org") +
    scale_colour_manual(values = distinctColorPalette(k = length(unique(OECD_house_prices$Country)),
                                                      altCol = FALSE, runTsne = FALSE)) +
    facet_wrap(~geo)+
    geom_line(lwd = plot_line_width) +
    geom_abline(intercept = 100, slope = 0, colour = "#6b6b6b") +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "horizontal")+
    legend_bottom_right_inside

plot_OECD_house_prices

```


### Simulation most affected variables in each shock {#sec:fi-fl-sfc-Ap-A-scenario-summaries}

#### Scenario 1: Percentage from baseline: An increase in 2020 interest rates, measured in 2021

```{r most-affected-scenario-1-perc-2020-economy}
Scenario_1_perc_2021_baseline_economic %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1, 2021: Economy wide") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10) %>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2020-HH}
Scenario_1_perc_2021_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value)%>%
    kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1, 2021: HH") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")

```

\vspace{1cm}
```{r most-affected-scenario-1-perc-2020-NFC}
Scenario_1_perc_2021_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value)%>%
    kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1, 2021: NFC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```



```{r most-affected-scenario-1-perc-2020-FC}
Scenario_1_perc_2021_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1, 2021: FC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2020-GOV}
Scenario_1_perc_2021_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1, 2021: GOV") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2020-ROW}
Scenario_1_perc_2021_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1, 2021: ROW") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```



#### Scenario 1: Percentage from baseline: An increase in 2020 interest rates, measured in 2023


```{r most-affected-scenario-1-perc-2023-economy}
Scenario_1_perc_2023_baseline_economic%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1: Economy wide, 2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2023-HH}
Scenario_1_perc_2023_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1: HH, 2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2023-NFC}
Scenario_1_perc_2023_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1: NFC, 2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2023-FC}
Scenario_1_perc_2023_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1: FC, 2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2023-GOV}
Scenario_1_perc_2023_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1: GOV, 2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-1-perc-2023-ROW}
Scenario_1_perc_2023_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 1: ROW, 2023") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```



#### Scenario 2: Percentage from baseline: Fall in 2022 property prices, measured in 2022

```{r most-affected-scenario-2-perc-economy}
Scenario_2_perc_2022_baseline_economic%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2022: Economy wide") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-HH}
Scenario_2_perc_2022_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2022: HH") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-NFC}
Scenario_2_perc_2022_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2022: NFC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-FC}
Scenario_2_perc_2022_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2022: FC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-GOV}
Scenario_2_perc_2022_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2022: GOV") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-ROW}
Scenario_2_perc_2022_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2022: ROW") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```



#### Scenario 2: Percentage from baseline: Fall in 2022 property prices, measured in 2025


```{r most-affected-scenario-2-perc-2025-economy}
Scenario_2_perc_2025_baseline_economic%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2025: Economy wide") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-2025-HH}
Scenario_2_perc_2025_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2025: HH") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-2025-NFC}
Scenario_2_perc_2025_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2025: NFC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-2025-FC}
Scenario_2_perc_2025_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2025: FC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-2025-GOV}
Scenario_2_perc_2025_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2025: GOV") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-scenario-2-perc-2025-ROW}
Scenario_2_perc_2025_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 2, 2025: ROW") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```



#### Scenario 3: Percentage from baseline: Combined scenario 1 and 2, measured in 2021

```{r most-affected-Scenario-3-perc-economy}
Scenario_3_perc_2021_baseline_economic%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2021: Economy wide") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-HH}
Scenario_3_perc_2021_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2021: HH") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-NFC}
Scenario_3_perc_2021_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2021: NFC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-FC}
Scenario_3_perc_2021_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2021: FC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-GOV}
Scenario_3_perc_2021_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2021: GOV") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-ROW}
Scenario_3_perc_2021_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2021: ROW") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```



#### Scenario 3: Percentage from baseline: Combined scenario 1 and 2, measured in 2025

```{r most-affected-Scenario-3-perc-economy-2025}
Scenario_3_perc_2025_baseline_economic%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2025: Economy wide") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-HH-2025}
Scenario_3_perc_2025_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2025: HH") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-NFC-2025}
Scenario_3_perc_2025_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2025: NFC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-FC-2025}
Scenario_3_perc_2025_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2025: FC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-GOV-2025}
Scenario_3_perc_2025_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2025: GOV") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-3-perc-ROW-2025}
Scenario_3_perc_2025_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 3, 2025: ROW") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


#### Scenario 4: Percentage from baseline: Scenario 3, plus $\alpha$ increased to 80\% in 2017, measured in 2021


```{r most-affected-Scenario-4-perc-economy}
Scenario_4_perc_2021_baseline_economic%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2021: Economy wide") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-perc-HH}
Scenario_4_perc_2021_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2021: HH") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-perc-NFC}
Scenario_4_perc_2021_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2021: NFC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-perc-FC}
Scenario_4_perc_2021_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2021: FC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-perc-GOV}
Scenario_4_perc_2021_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2021: GOV") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-perc-ROW}
Scenario_4_perc_2021_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2021: ROW") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```



#### Scenario 4: Percentage from baseline: Scenario 3, plus $\alpha$ increased to 80\% in 2017, measured in 2025


```{r most-affected-Scenario-4-2025-perc-economy}
Scenario_4_perc_2025_baseline_economic%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2025: Economy wide") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-2025-perc-HH}
Scenario_4_perc_2025_baseline_HH%>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2025: HH") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-2025-perc-NFC}
Scenario_4_perc_2025_baseline_NFC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2025: NFC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-2025-perc-FC}
Scenario_4_perc_2025_baseline_FC %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2025: FC") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-2025-perc-GOV}
Scenario_4_perc_2025_baseline_GOV %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2025: GOV") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


```{r most-affected-Scenario-4-2025-perc-ROW}
Scenario_4_perc_2025_baseline_ROW %>%
        mutate(Change = paste0(str_pad(sprintf("%.4f", round(Value*100,digits=4)), 7, pad = "0"), "\\%")) %>%
        select(-Value) %>%
  kbl(caption = "Most affected variables: Perc change from baseline: Scenario 4, 2025: ROW") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "70%", height = "200px")
```


### Additional illustrations of Scenarios

#### Summary flows: All sectors

```{r fl-fi-sfc-Savings-extra, as.is = TRUE, fig.cap = "Savings", out.width="95%"}
plot_savings_s1_s2 <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                            y = Value,
                            group = Scenario,
                            colour = Scenario,
                            lty = Scenario),
              data = model_data_actuals %>%
                filter(Variable == "S",
                        Price_type == "",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3", 
                                        "Scenario 4"),
                        Sector != "") %>%
                        filter(Date > min_date & Date < max_date) %>%
                        group_by(Date),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_savings_s1_s2

```


```{r fl-fi-sfc-Yd-extra, as.is = TRUE, fig.cap = "Net Lending", out.width="95%"}
plot_Yd_s1_s2 <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                            y = Value,
                            group = Scenario,
                            colour = Scenario,
                            lty = Scenario),
              data = model_data_actuals %>%
                filter(Variable == "NL",
                        Price_type == "",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3", 
                                        "Scenario 4"),
                        Sector != "") %>%
                        filter(Date > min_date & Date < max_date) %>%
                        group_by(Date),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_Yd_s1_s2

```


```{r fl-fi-sfc-INV-extra, as.is = TRUE, fig.cap = "Investment", out.width="95%"}
plot_INV_s1_s2 <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                            y = Value,
                            group = Scenario,
                            colour = Scenario,
                            lty = Scenario),
              data = model_data_actuals %>%
                filter(Variable == "INV",
                        Price_type == "",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3", 
                                        "Scenario 4"),
                        Sector != "") %>%
                        filter(Date > min_date & Date < max_date) %>%
                        group_by(Date),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_INV_s1_s2

```


#### Residual sector flows

```{r fl-fi-sfc-NIB-extra, fig.cap = "Net interest bearing asset transactions"}
plot_NIB_transactions <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                            y = Value,
                            group = Scenario,
                            colour = Scenario,
                            lty = Scenario),
              data = model_data_actuals %>%
                filter(Variable == "NIB",
                        Price_type == "",
                        Transaction_type == "Transactions",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3", 
                                        "Scenario 4"),
                        Sector != "") %>%
                        filter(Date > min_date & Date < max_date) %>%
                        group_by(Date),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_NIB_transactions

```

```{r fl-fi-sfc-passive-FC-HH, fig.cap = "Residual flows for FC and HH", out.width="50%"}

plot_NEQ_transactions_FC <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                            y = Value,
                            group = Scenario,
                            colour = Scenario,
                            lty = Scenario),
              data = model_data_actuals %>%
                filter(Variable == "NEQ",
                        Price_type == "",
                        Transaction_type == "Transactions",
                        Sector == "FC",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3", 
                                        "Scenario 4")) %>%
                        filter(Date > min_date & Date < max_date) %>%
                        group_by(Date),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions", title="FC: NEQ transactions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    geom_hline(yintercept = 0) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))


plot_IBA_transactions_HH <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(mapping = aes(x = year(Date),
                            y = Value,
                            group = Scenario,
                            colour = Scenario,
                            lty = Scenario),
              data = model_data_actuals %>%
                filter(Variable == "IBA",
                        Price_type == "",
                        Transaction_type == "Transactions",
                        Sector == "HH",
                        Scenario %in% c("Baseline", 
                                        "Scenario 1", 
                                        "Scenario 2",
                                        "Scenario 3", 
                                        "Scenario 4")) %>%
                        filter(Date > min_date & Date < max_date) %>%
                        group_by(Date),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions", title="HH: IBA transactions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    geom_hline(yintercept = 0) +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))

plot_NEQ_transactions_FC
plot_IBA_transactions_HH

```

#### NW: Nominal prices: All sectors

```{r fl-fi-sfc-plot-fnw, as.is = TRUE, fig.cap = "NW: Nominal prices: All sectors"}
plot_fnw <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    geom_line(data = model_data_actuals %>%
                       filter(Variable %in% c("NW"),
                              Price_type %in% c(""),
                              Scenario %in% c("Baseline", 
                                              "Scenario 1", 
                                              "Scenario 2",
                                              "Scenario 3", 
                                              "Scenario 4"),
                              Transaction_type == "",
                              Date > min_date & Date < max_date) %>%
                       group_by(Date),
                   mapping = aes(x = year(Date),
                                 y = Value,
                                 group = Scenario,
                                 colour = Scenario,
                                 lty = Scenario),
              lwd = plot_line_width) +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fnw
```

#### Capital Stock: Nominal prices: HH, NFC

```{r fl-fi-sfc-plot-k, as.is = TRUE, fig.cap = "Capital Stock: Nominal prices: HH, NFC", out.width="95%"}
plot_k <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                       filter(Variable %in% c("K"),
                              Price_type %in% c(""),
                              Scenario %in% c("Baseline",
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                              Transaction_type == "",
                              Sector %in% c("HH", "NFC"),
                              Date > min_date & Date < max_date) %>%
                       group_by(Date),
                   mapping = aes(x = year(Date),
                                 y = Value,
                                 group = Scenario,
                                 colour = Scenario,
                                 lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Sector, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_k
```


#### Financial transactions: Nominal prices: HH

```{r fl-fi-sfc-plot-fin-tr-HH, as.is = TRUE, fig.cap = "Financial transactions: Nominal prices: HH"}
plot_fin_tr_HH <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                       filter(Variable %in% c("EQA", "IBA", "NIB", "NEQ", "NPEN", "PENA"),
                              Price_type %in% c(""),
                              Scenario %in% c("Baseline",
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                              Sector == "HH",
                              Transaction_type == "Transactions",
                              Date > min_date & Date < max_date) %>%
                       group_by(Date),
                   mapping = aes(x = year(Date),
                                 y = Value,
                                 group = Scenario,
                                 colour = Scenario,
                                 lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    geom_hline(yintercept = 0) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fin_tr_HH
```

#### Financial transactions: Nominal prices: NFC

```{r fl-fi-sfc-plot-fin-tr-NFC, as.is = TRUE, fig.cap = "Financial transactions: Nominal prices: NFC"}
plot_fin_tr_NFC <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                       filter(Variable %in% c("EQA", "IBA", "NIB", "NEQ", "NPEN", "PENA"),
                              Price_type %in% c(""),
                              Scenario %in% c("Baseline",
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                              Sector == "NFC",
                              Transaction_type == "Transactions",
                              Date > min_date & Date < max_date) %>%
                       group_by(Date),
                   mapping = aes(x = year(Date),
                                 y = Value,
                                 group = Scenario,
                                 colour = Scenario,
                                 lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    geom_hline(yintercept = 0) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fin_tr_NFC
```


#### Financial transactions: Nominal prices: FC

```{r fl-fi-sfc-plot-fin-tr-FC, as.is = TRUE, fig.cap = "Financial transactions: Nominal prices: FC"}
plot_fin_tr_FC <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                       filter(Variable %in% c("EQL", "IBA", "NIB", "NEQ", "NPEN", "PENL", "IBL"),
                              Price_type %in% c(""),
                              Scenario %in% c("Baseline",
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                              Sector == "FC",
                              Transaction_type == "Transactions",
                              Date > min_date & Date < max_date) %>%
                       group_by(Date),
                   mapping = aes(x = year(Date),
                                 y = Value,
                                 group = Scenario,
                                 colour = Scenario,
                                 lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    geom_hline(yintercept = 0) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fin_tr_FC
```

#### Financial transactions: Nominal prices: GOV

```{r fl-fi-sfc-plot-fin-tr-GOV, as.is = TRUE, fig.cap = "Financial transactions: Nominal prices: GOV"}
plot_fin_tr_GOV <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                       filter(Variable %in% c("NIB", "NEQ", "NPEN", "PENA"),
                              Price_type %in% c(""),
                              Scenario %in% c("Baseline",
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                              Sector == "GOV",
                              Transaction_type == "Transactions",
                              Date > min_date & Date < max_date) %>%
                       group_by(Date),
                   mapping = aes(x = year(Date),
                                 y = Value,
                                 group = Scenario,
                                 colour = Scenario,
                                 lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    geom_hline(yintercept = 0) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fin_tr_GOV
```


#### Financial transactions: Nominal prices: ROW

```{r fl-fi-sfc-plot-fin-tr-ROW, as.is = TRUE, fig.cap = "Financial transactions: Nominal prices: ROW"}
plot_fin_tr_ROW <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                       filter(Variable %in% c("EQA", "IBA", "NIB", "NEQ", "NPEN", "PENA"),
                              Price_type %in% c(""),
                              Scenario %in% c("Baseline",
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                              Sector == "ROW",
                              Transaction_type == "Transactions",
                              Date > min_date & Date < max_date) %>%
                       group_by(Date),
                   mapping = aes(x = year(Date),
                                 y = Value,
                                 group = Scenario,
                                 colour = Scenario,
                                 lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "DKK Millions",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    geom_hline(yintercept = 0) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fin_tr_ROW
```

#### IBA and IBL: Stock: FC

```{r fl-fi-sfc-plot-a-l-f, as.is = TRUE, fig.cap = "IBA and IBL: Stock: FC", out.width="95%"}
plot_fin_a_l_f <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                             filter(Variable %in% c("IBA", "IBL"),
                                    Price_type %in% c(""),
                                    Scenario %in% c("Baseline", 
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                                    Transaction_type == "",
                                    Interest_type == "",
                                    Sector == "FC",
                                    Date > min_date & Date < max_date) %>%
                             group_by(Date),
                         mapping = aes(x = year(Date),
                                       y = Value,
                                       group = Scenario,
                                       colour = Scenario,
                                       lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "Pct from baseline",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Variable, scales = "free") +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_bottom_left_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fin_a_l_f
```


#### IBL: Fixed and Flexible: Stocks: HH

```{r fl-fi-sfc-plot-ibl-h, as.is = TRUE, fig.cap = "IBL: Fixed and Flexible: Stocks: HH", out.width="95%"}
plot_fin_ibl_h <- ggplot() +
    shock_1_colours +
    shock_2_colours +
    shock_2_legend +
    geom_line(data = model_data_actuals %>%
                             filter(Variable %in% c("EQA", "IBA", "IBL"),
                                    Price_type %in% c(""),
                                    Scenario %in% c("Baseline", 
                                              "Scenario 1", 
                                              "Scenario 2", 
                                              "Scenario 3", 
                                              "Scenario 4"),
                                    Transaction_type == "",
                                    Sector == "HH",
                                    Interest_type != "",
                                    Date > min_date & Date < max_date) %>%
                             group_by(Date),
                         mapping = aes(x = year(Date),
                                       y = Value,
                                       group = Scenario,
                                       colour = Scenario,
                                       lty = Scenario),
              lwd = plot_line_width) +
    labs(x = "Year", y = "Pct from baseline",
        caption = "Source: Data: Eurostat, AMECO, OECD and present model forecast") +
    facet_wrap(~Interest_type) +
    scale_colour_manual(values = blackpalette_five) +
    scale_y_continuous(labels = scales::comma_format()) +
    scale_linetype_manual(values = plt_line_types_5) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_right_inside +
    guides(col = guide_legend(nrow = 5, byrow = FALSE))
plot_fin_ibl_h
```


### Lists of variables from scenarios {#sec:list-of-variables-shocks}

```{r variable-names-table_shocks, as.is=TRUE}
variable_key %>%
        select(Variable, Type, Description) %>%
        distinct() %>%
        mutate(Variable = str_replace_all(Variable, pattern = "_", ",")) %>%
        arrange(Variable, Type, Description) %>%
  kbl(caption = "List of variables in scenario tables") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "99%", height = "200px")
```

## Complete set of model equations {#sec:fi-fl-sfc-full-model}

### Non-Financial Corporate Sector {#sec:fi-fl-sfc-model-eq-nf}

The following appendix is adapted from @byrialsenraza2019empirical, except otherwise indicated.
It is included here for completeness in the explanation of the structure of
the model. As in their model, the non-financial corporate sector (NFC) is responsible for all production,
where total nominal production is represented as:

\begin{equation}
Y_t = C_t + I_t + G_t + X_t - M_t
\label{eq:ynominal}
\end{equation}

This can be rewritten in terms of sales, or rather, from an income perspective:

\begin{equation}
S_t = C_t + I_t + G_t + X_t
\label{eq:nfcsales}
\end{equation}

The production equation from Equation (\ref{eq:ynominal}) can be deflated to real prices;

\begin{equation}
y_t = c_t + i_t + g_t + x_t - m_t
\end{equation}

Where the GDP deflator can be represented as:

\begin{equation}
P^y_t = \frac{Y_t}{y_t}
\end{equation}

Outflows for NFC include taxes paid to GOV, wages ($WB$) paid to domestic and foreign households, and profits ($B2$[^GOS]).

[^GOS]: Profits here refer to the gross operating surplus for the sector, ESA non financial transactions item $B2$.

\begin{equation}
WB^N_t = W_t(N^N_t)
\end{equation}

The nominal wage bill is calculated as the wage rate ($W_t$) times the
level of employment ($NN_t$), where $NN_t$ includes all domestic employment
of citizens plus the net employment of foreigners in Denmark and Danish citizens abroad.

Taxes paid by NFC are predominantly production based and are therefore
calculated as a proportion of total production in each period ($Y_t$).

\begin{equation}
T^N_t = \beta _3(Y_t)
\end{equation}

It is assumed that firms target a fairly stable level of mark-up on production,
and thus $B2$ is calculated as an estimated proportion of $Y_t$.

\begin{equation}
B2_t = \beta Y_t
\end{equation}

The stock of NFC fixed capital, ($K^N_t$), is diverse, and is calculated via the
standard accounting method, allowing for capital accumulation via investment ($I^N_t$),
depreciation ($D^N_t$) and capital gains ($K^N_{CG_t}$).

\begin{equation}
K^N_t = K^N_{t-1} + I^N_t - D^N_t + K^N_{CG_t}
\end{equation}

Depreciation of capital is assumed to apply to stock held at the end of the previous
period.

\begin{equation}
D^N_t = \delta (K^N_{t-1})
\end{equation}

The capital deflator ($P^i_t$) can then be used to calculate the real
value of the stock of capital in each period.

\begin{equation}
k^N_t = \frac{K^N_t}{P^i_t}
\label{eq:realcap}
\end{equation}

Investment is estimated in real terms as a function of capacity utilisation.

\begin{equation}
ln(i^N_t) = \beta _i + ln\beta _i. \Bigg( \frac{y_{t-i}}{k^N_{t-i}}\Bigg)
\end{equation}

<!-- \label{eq:ynominal} -->
<!-- Equation (\ref{eq:ynominal}) -->

It can then be inflated to current prices using the same capital price deflator as in Equation (\ref{eq:realcap}), $P^i_t$.

\begin{equation}
I^N_t = i^N_t(P^i_t)
\end{equation}

NFC savings ($S^N_t$), not to be confused with sales ($S_t$) in Equation (\ref{eq:nfcsales}),
can be calculated as the net sum primary and secondary income and expenditures.

\begin{equation}
\begin{split}
S^N_t = & Y_t - WB^N_t + (B2^N_{t} - B2_{t}) + r^N_{t-1}(NIB^N_{t-1})\\
        & + \chi _t (NEQ^N_{t-1}) - T^N_t + STR^N_t + \epsilon ^N
\end{split}
\end{equation}

Net lending ($NL^N$) takes into account the additional sources of change
originating from fixed asset adjustments. In particular, $NP$ is the net
sale and acquisition of non-financial assets, savings and investment reflect
*ex post* portfolio decisions, and finally $KTR^N$ represents any additional
capital transfers. [^netlendingidentity] NFC is also assumed to receive all
income from production in the economy, and thus the level of operating surplus must
be adjusted to take into account that of all other sectors, thus NFC retains
($B2^N_{t} - B2_{t}$) gross operating surplus. The $\epsilon ^N$ refers to adjustments made to ensure stock and flow consistency in the level of property income received or paid during the periods where data was available[^adjustmentterm].

[^netlendingidentity]: This structure follows for each of the sectors, with the exception of the rest of the world sector (ROW), where ownership of fixed assets is not included, and therefore, by definition, neither is investment. $NP$ is determined exogenously, and is for the most part of negligible size.

[^adjustmentterm]: This convention is used for all sectors. The returns on financial assets are estimated with varying degrees of accuracy for each of the sectors. In order to ensure that the model is consistent in all periods, any difference between the estimated returns and actual returns (on a net basis for each asset class) are added to the adjustment term. These errors in estimation are minimised in the estimation specification for each asset class individually.

\begin{equation}
NL^N_t = S^N_t - I^N_t- NP^N_t + KTR^N
\end{equation}

The calculation of stocks for each of the classes held by NFC are in equations (\ref{eq:nfc-neq})
and (\ref{eq:nfc-nib}).

Net equities:

\begin{equation}
NEQ^N_t = NEQ^N_{t-1} + NEQTR^N_t + NEQ^N_{CG_t}
\label{eq:nfc-neq}
\end{equation}

Net interest bearing stocks:

\begin{equation}
NIB^N_t = NIB^N_{t-1} + NIBTR^N_t + NIB^N_{CG_t}
\label{eq:nfc-nib}
\end{equation}

Net interest bearing assets, like several others in this model, are determined
by a combination of previous stocks ($NIB^N_{t-1}$), transactions ($NIBTR^N_t$)
and capital gains ($NIB^N_{CG_t}$). The transactions component of interest
bearing assets for NFC is determined passively. It is calculated as the remainder
of Savings, after capital transfers, and after portfolio allocation towards
equities. Transactions in equities ($NEQTR^N$) are thus the active component of the composition
of the NFC balance sheet portfolio.

\begin{equation}
NIBTR^N_t = NL^N_t - NEQTR^N_t
\end{equation}

Since NFC only holds these two financial assets in the model, the sum constitutes the
financial net wealth ($FNW^N$) of NFC.

\begin{equation}
FNW^N_t = NIB^N_t + NEQ^N_t
\end{equation}

This is different to the total net wealth ($NW^N$), which also includes the fixed capital
($K^N$) owned by NFC.

\begin{equation}
NW^N_t = FNW^N_t + K^N
\end{equation}

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

### Household Sector {#sec:fi-fl-sfc-model-eq-hh}

The household sector (HH) is the primary focus of this model, in particular the interest bearing
liabilities of the household sector, and the drivers thereof. It is therefore the sector with
most endogenous components. Equation (\ref{eq:Yht}) describes the incomes and expenditures
of HH. The primary sources of which are wages ($WB^H$), profits ($B2$), property income
(or returns on financial capital, which stems from interest bearing assets, $IBA^H$,
pensions, $PENA^H$, and equities, $EQA^H$), and social transfers($STR^H$).

\begin{equation}
\begin{split}
Y^H_t = & WB^H_t + B2^H_{t} + r^H_{A_{t-1}}(IBA^H_{t-1})\\
        & - r^H_{L(FI)_{t-1}}(IBL(FI)^H_{t-1})\\
        & - r^H_{L(FL)_{t-1}}(IBL(FL)^H_{t-1})\\
        & + \chi _t(EQA^H_{t-1}) + \psi _t(PENA^H_{t-1}) + STR^H_t + \epsilon ^H
\label{eq:Yht}
\end{split}
\end{equation}

Interest rates are represented by $r^H$, and the "A" ("L") subscript referring to the assets (liabilities), and ($\chi _t$) and ($\psi _t$) are the rates of return on equities and pensions. As part of the key change in this model, the level of interest paid on $IBL$ in this model is split between fixed and flexible rate mortgages into $r^H_{L(FI)_{t-1}}(IBL(FI)^H_{t-1})$ and $r^H_{L(FL)_{t-1}}(IBL(FL)^H_{t-1})$. A similar split is present in the financial corporate sector (FC) below.

Social transfers received by the households in the above equations is the sum of social contribution ($SCON^H$) paid by the households, social benefits ($SBEN^H_t$), and other transfers ($OTR^H$) received by the households:
Social transfers:

\begin{equation}
STR^H_t = SBEN^H_t + OTR^H_t - SCON^H
\end{equation}

Total taxes paid by households are a relatively constant proportion of income over time,
and are deducted from total income to give disposable income:

\begin{equation}
YD^H_t = Y^H_t - T^H_t
\end{equation}

The total value of tax payment by households is assumed to be a constant portion ($\beta _i$)
of household primary and secondary income.

\begin{equation}
T^H_t = \beta _i (Y^H_t)
\end{equation}

The level of social contributions are a proportion of disposable income, adjusted over time.

\begin{equation}
SCON^H_t = \beta _7(YD^H_{t-i})
\end{equation}

The largest components of $SBEN^H$ are pension and medical payments. @byrialsenraza2019empirical,
modelled changes in benefits against changes in the the wage rate and
the level of unemployment. Although not directly related to the main components of
benefits, they appear to be good proxies for changes in pension distributions, which
in some cases may be based on emoluments.

\begin{equation}
ln(SBEN^H_t) = \beta _i + \beta _i ln(U^N_t) + \beta _i ln(W^H_{t-i})
\label{eq:socialbenefits}
\end{equation}

Since 2007, approximately 35\% - 37\% of all social benefits
were for old age payments. A further 20\% - 22.3\% are attributed to medical benefits, an almost
constant 14.4\% to disability and 10\% - 13.2\% to family and child benefits. Unemployment (app. 5\%),
social exclusion (app. 5\%), housing (app. 2\%) and survivorship (app. 1\%) benefits making up the balance.

```{r sben-all-dk, fig.cap="Social benefits by category", fig.show="hold"}
Totals_plot_pct <- ggplot(data = Benefits %>%
                             filter(FORANSTALT %in% c(Totals$V1),
                                    YDELSESTYPE == "Total social expenditures") %>%
                             select(-YDELSESTYPE) %>%
                             spread(., key = FORANSTALT, value = INDHOLD) %>%
                             mutate_at(vars(-TID, -Cat_Schemes_total), ~ (.x %>% (function(x) {x/Cat_Schemes_total}))) %>%
                             select(-Cat_Schemes_total) %>%
                             gather(., -TID, key = Category, value = value) %>%
                             mutate(Category = str_replace_all(Category, pattern ="_", " "),) %>%
                             mutate(Category = str_to_sentence(Category, locale = "en")) %>%
                             group_by(TID),
                         mapping = aes(x = as.factor(TID),
                                       y = value,
                                       group = Category,
                                       fill = Category,
                                       colour = Category)) +
    labs(x = "Year", 
         y = "Per cent total SBEN",
        caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
    geom_line(lwd = plot_line_width) +
    scale_y_continuous(labels = pct_scale_settings) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
        legend.box = "vertical") +
    legend_top_left_inside +
    guides(col = guide_legend(nrow = 9, byrow = FALSE))
Totals_plot_pct
```

The old age category, as can be seen from Figure \ref{fig:old-age-public-spend},
is then dominated by tax funded pension payouts (app. 50\% in 2017),
old age accommodation and care (app. 15\%) and civil (app. 11\%) and other pension
schemes (app. 12\%), with the declining anticipated pension allocations (app. 5.2\% in 2017)
and growing labour market supplementary pension benefits (ATP[^atppension]) (app. 5.8\%) making up the
balance. The full amount therefore could be considered as pension income, but since these
pension benefits are funded predominantly by tax, rather than from assets, they are best
kept separate from the capital income on pension assets described in Equation (\ref{eq:Yht})
above. This is perhaps with the exception of labour market supplementary pension benefits, which are
payouts from a pooled investment portfolio.

[^atppension]: ATP is an anagram for *Arbejdsmarkedets Tillægspension*, which translates directly to
*labour market supplementary pension*.

```{r old-age-public-spend, fig.cap="Old age social benefits", fig.show="hold"}
Old_age_plot_pct <- ggplot() +
    geom_line(mapping = aes(x = as.factor(TID),
                            y = Percent_of_category,
                            group = Category,
                            colour = Category),
              data = Benefits %>%
                filter(FORANSTALT %in% FORANSTALT_OLD_AGE$V1,
                        YDELSESTYPE == "Total social expenditures") %>%
                        select(-YDELSESTYPE) %>%
                        spread(., key = FORANSTALT, value = INDHOLD) %>%
                        mutate_at(vars(-TID, -Cat_3_OLD_AGE), ~ (.x %>% (function(x) {x/Cat_3_OLD_AGE}))) %>%
                        select(-Cat_3_OLD_AGE) %>%
                        gather(., -TID, key = Category, value = Percent_of_category)%>%
                        mutate(Category = str_replace_all(Category, pattern ="_", " "),) %>%
                        group_by(TID)) +
    labs(x = "Year", y = "Per cent old age SBEN",
        caption = "Source: Statistics Denmark (Danmarks Statistik), own calculations") +
    geom_line(lwd = plot_line_width) +
    scale_y_continuous(labels = pct_scale_settings) +
    theme_srv_extra +
    theme(legend.direction = "vertical",
          legend.box = "vertical") +
    legend_top_left_inside +
    guides(col = guide_legend(nrow = 6, byrow = FALSE))
Old_age_plot_pct
```

This is not merely a question of semantics, as the old age component is also an element
of wage negotiations for the working population. A large part of social contributions ($SCON^H$)
are also contributions towards the labour market pension fund.[^danishpensionsystem]
$SBEN^H$ is, perhaps understandably, the second largest component of HH disposable income in Denmark.
As can be seen in Figure \ref{fig:sben-all-dk}, this can quickly be understood to be driven
primarily by healthcare and pensions, but in a more general sense, by components of the strong
Danish welfare system. Labour market pension payouts are expected to fall (rise), as are unemployment
benefit payouts, as economic conditions improve (deteriorate). Unemployment, as an indicator of economic
distress, appears to be a good proxy for expected changes in benefit payouts relative to total HH
disposable income. Equation (\ref{eq:socialbenefits}) captures this effect, together with the
effect of changes in the wage rate. The latter because unemployment benefits and several pension
benefits are adjusted according to changes in industry wage rates, as noted by @byrialsenraza2018
and -@byrialsenraza2019empirical.

[^danishpensionsystem]: The Danish pension system is beyond the scope of this discussion,
but a brief summary may be useful here. As described by @andersen2016dps [pp. 2], the
system is relatively complex three pillar system, with the most recent comprehensive
reform taking place in 1964. The three pillars are:
1.) A state pension (with several minor schemes),
2.) Semi-mandatory occupational pensions (or labour market pensions), and
3.) Personal pension savings.
The state pension and other peripheral benefits (such as old age accommodation support,
heating support etc) is tax funded and essentially a flat rate benefit for all citizens,
while the second and third pillars are savings based, and thus have been slower to mature.
There have been a range of relatively minor adjustments to the state pension system over
the past few decades, some of which are adjustments according to what other benefits or
income the person has (partially means tested). The conditions of the occupational pension
system, much like much of the labour market working conditions agreements, are determined
via collective agreement. While there are no legislated wage or pension requirements - for
example there is no minimum wage in Denmark - the coverage of collective bargaining
agreements is almost universal. [@andersen2016dps]

Real disposable income, as will be the case for several other variables in this model, can be
calculated by dividing household disposable income by a consumption price index ($P^c$).

\begin{equation}
yd^H_t = \frac{YD^H_t}{P^c_t}
\end{equation}

Consumption, like NFC investment, is estimated in real terms in a standard Keynesian form, and
log-linearised for stationarity. Consumption is taken to be determined by a combination of
real disposable income and household wealth of the preceding period. Although not explicitly
modelled, current consumption thus is assumed to be based purely on expectations developed
in the previous period.

\begin{equation}
ln(c_t) = \beta _0 + \beta _iln(yd^H_{t-i}) + \beta _iln(nw^H_{t-1})
\label{eq:hh_consumption}
\end{equation}

Nominal consumption can be calculated using the consumption price index to inflate the series.

\begin{equation}
C_t = c_t(P^c_t)
\end{equation}

$P^c$, the consumption price index is endogenous to changes in the wage rate and
the import price index from the previous period. In some way reflecting a delayed adjustment
in (or, sticky) prices, and the importance of international prices for smaller open economies,
such as Denmark.

\begin{equation}
ln(P^c_t) = \beta _0 + \beta _iln(W_{t-i}) + \beta _iln(P^m_{t-i})
\end{equation}

The following equations are related to household interactions with capital an investment
markets.

In this model, households are only permitted to make productive investment in
housing, which, in this model, is considered only as a
primary market, following @Zezza2008, @fontana2013securitization and @beckta2015modelling.
The secondary market for houses is assumed to affect prices, but not the demand
for additional housing investment. Demand for housing investment is determined by
by a Tobin's-Q-like function, partially driven by changes in disposable income and
previous period housing investment, and partially driven by a relative shift in
sales price (${P^H_{t-i}}$) and construction cost (${P^i_{t-i}}$) indices.

Real investment in fixed assets (dwellings):

\begin{equation}
ln(i^H_t) = \beta _i + \beta _i ln(i^H_{t-i}) + \beta _i ln \Bigg( \frac{P^H_{t-i}}{P^i_{t-i}}\Bigg) + \beta _iln(yd^H_{t-i})
\label{eq:housing-hh}
\end{equation}

As noted by @byrialsenraza2019empirical [pp. 20], "The intuition behind the above equation is straight forward, i.e., an increase in the house prices motivates the households to invest more in the construction of new houses, while an increase in the construction costs would lower housing investment."

A shift downwards in house prices would conversely reduce overall returns on houses relative to
construction costs, and thus result in a decline in the demand for housing investment.
This would result, all else equal, in an increase in savings and a consequent rise in the demand
for alternative outlets. Limited below to the purchase of financial assets[^housing_price_drivers].

[^housing_price_drivers]: @andre2016household, in a recent OECD working paper argue that while there is an
obvious connection between the availability of credit and house prices, the extent to which
house prices are affected by changes in mortgage lending is affected by a wide range of
factors, including sentiment, employment conditions, legislative changes, and a range of cyclical
economic factors. @kohlscheen2018residential also note the co-movement of residential property
prices and credit as a prominent feature of models of financial cycles, although their focus is
on commonalities in financial, demographic and real economy factors. Their
[@kohlscheen2018residential, pp. 2] findings suggest that the primary drivers are
"real house prices, nominal interest rates, demographic factors, and the state of housing supply".
The present model captures all but demographic factors in the determination of residential (HH)
investment. They also find strong asymmetries in the effects of interest rates between boom and
bust cycles, and with rising interest rates rather than falling. This is supported by @scanlon2008's
findings that household mortgage lending is highly sensitive to short-term budget
implications of interest and capital repayment costs.

The nominal level can be calculated by inflating the real investment in housing
series ($i^H_t$) by the investment price index ($P^i_t$):

\begin{equation}
I^H_t = i^H_t(P^i_t)
\end{equation}

The nominal stock of housing ($K^H$), as with other assets to come, follows the simple
process of previous stock, plus acquisition (in this case investment in new houses),
less depreciation (or disposal) plus capital gains.

\begin{equation}
K^H_t = K^H_{t-1} + I^H_t - D^H_t + K^H_{CG_t}
\end{equation}

Capital gains on houses, in turn, are calculated as:

\begin{equation}
KH_{CG} = \Delta P^H_t (K^H_{t-1})
\end{equation}

Which is simply the change in the price of houses applied to the level of stock at
the end of the preceding period.
The change in house prices leading into the current period is then by definition the same
ratio proportion of capital gains to previous housing capital.

\begin{equation}
\Delta P^H_t = \frac{KH_{CG}}{K^H_{t-1}}
\label{eq:changehouseprice}
\end{equation}

Nominal housing capital held by HH at the end of the current period
can be expressed as the price adjusted stock at the end of the previous
period, plus net investment and depreciation.

\begin{equation}
K^H_t = K^H_{t-1}(1 + \Delta P^H_t) + I^H_t- D^H_t
\end{equation}

The deflated real capital index can then be found by dividing the series by the
investment (housing) price index, as in Equation (\ref{eq:changehouseprice}) above.

\begin{equation}
k^H_t = \frac{K^H_t}{P^i_t}
\end{equation}

The level of savings is then calculated as a residual disposable income after
consumption and net pension adjustments - the ESA 2010 [@ESA2010] definition
of which is net of contributions, disbursements and returns of pension funds.

\begin{equation}
S^H_t = YD^H_t - C^H_t + CPEN^H_t
\end{equation}

Net lending can then be calculated savings plus additional consideration for the
net acquisition and disposal of fixed assets ($NP$) and capital transfers ($KTR$)
less investment (assumed here to be solely in houses).

\begin{equation}
NL^H_t = S^H_t - I^H_t - NP^H_t + KTR^H_t
\end{equation}

HH must also fund real activities and allocate any excess funds in the financial markets.
As noted above, HH is the sector with most endogenous components in this model. It is
also the sector, together with the financial corporate sector (FC) that has the most complex financial accounts.
As noted by @byrialsenraza2019empirical, financial market changes in this model are
driven primarily by the demand for credit and assets. As they explained, transmission
is from flows to stocks. The behaviour is primarily modelled in transaction decisions,
and stocks are then calculated as the sum of these together with capital gains.

The net effect of annual changes in the financial position of HH is captured by
financial net lending. This is the sum of changes in financial assets less the
sum of changes in financial liabilities:

\begin{equation}
FNL^H_t = FATR^H_t - FLTR^H_t
\end{equation}

Household financial assets are held in interest bearing assets ($IBA$), equities[^eqahh] ($EQA$) and
pensions ($PENA$). Transactions in each of these sum to make up the total
transactions in financial assets.

[^eqahh]: The equity component in the balance sheets of the other sectors in this model
is limited to a net equity position. It is assumed here that HH do not issue equities.

\begin{equation}
FATR^H_t = IBATR^H_t + EQATR^H_t + PENATR^H_t
\end{equation}

Transactions in equities are determined by a Tobin allocation matrix, thus enforcing a
budget constraint on HH, where the investment decision of the sector is determined at
least in part by relative rates of return. One exception is pension allocations, where a
fairly constant portion of HH income is allocated to pension investments, irrespective of
the rate of return. This leaves equities and interest bearing assets.

Demand for equities is negatively affected by increases in the returns available on interest
bearing assets in the previous period ($\beta$ on $r^H_{A_{t-1}}$), positively related to
returns on equities ($\chi$), and positively related to increases in the extension of
credit ($\beta$ on $IBLTR^H$).

\begin{equation}
EQATR^H_t = \beta _i + \beta _i(\chi _t) + \beta _i(r^H_{A_{t-1}}) + \beta _i(IBLTR^H_t )
\end{equation}

The link with $IBL$ is associated with the investment incentive for more sophisticated
investors, where low interest rate debt can be used to arbitrage higher returns on
equities.

Pension transactions, in addition to the fixed proportion that is reflected
as a constant in the equation below, are positively affected by returns on pensions ($\psi$)
and the wage bill ($WB$). Pensions transactions can thus be affected directly by the
wage rate, or the level of employment (and thus negatively by a rise in unemployment).

\begin{equation}
PENATR^H_t = \beta _i + \beta _i(\psi _t) + \beta _iWB^H_t
\end{equation}

The demand for credit by households is where the current model differs most from
@byrialsenraza2019empirical. The total demand for new credit is captured
in the level of transactions ($IBLTR^H$). This is positively related to the level of demand for (new) housing ($I^H$), negatively to the level of debt in the previous period, positively to the total level of transactions in equities (for the same investment reason described above), and negatively related to the interest cost on loans ($r^H_{L_{t-1}}$) in the previous period.

\begin{equation}
IBLTR^H_t = \beta _i(I^H_{t-i}) + \beta _i(IBL^H_{t-i}) + \beta _i(FATR^H_t) + \beta _i(r^H_{L_{t-1}})
\end{equation}

The primary change to the model is the introduction of adjustable rate mortgage products in a
fairly generic form, where the total level of outstanding $IBL$ is split into
fixed-interest ($IBL_{FI}$) and flexible-interest bearing liabilities ($IBL_{FL}$). The proportion
of interest bearing assets held as $IBL_{FI}$ is $\alpha$.

\begin{equation}
IBL^H_{FI_t} = \alpha(IBL^H_t)
\end{equation}

and thus,

\begin{equation}
IBL^H_{FL_t} = (1-\alpha)(IBL^H_t)
\end{equation}

The level of $\alpha$ is taken from Statistics Denmark, and varies over time. The split is introduced in 2003, when the option was made available to HH. The composition of this debt is significantly more complex, as discussed in Section \ref{sec:fi-fl-rk-dk}
above. This complexity can be simplified using a combination of interest rates and sensitivity or adjustment weights. At an aggregate level, the degree to which flexible rate mortgages adjust to changes in official rates can be estimated for each aggregate group of mortgage products. This is done for two broad groups in for this model, fixed[^fixedgroup] and flexible[^flexiblegroup]. The effect is calculated as a percentage pass-through of official rate changes. Unfortunately it is not possible to compare rising and falling pass-through rates to existing mortgage holders prior to 2009. For the 2009 to 2017 period, however, fixed and flexible average interest rate payments, relative to outstanding nominal capital (cash) amounts, appears to have followed a very stable spread of approximately 2\%. This is fairly easy to explain in a falling rates environment as borrowers take advantage of the option to refinance debt.

[^fixedgroup]: Group 1, called "fixed-interest" includes:

[^flexiblegroup]: Group 2, called "flexible-interest" includes:

The composition of debt and the expected pass-through rate have a combined effect on
the sensitivity of HH balance sheets and incomes to a shock to either interest rates or
property prices. This simple modification is able to capture the two most dramatics
innovations in the Danish mortgage debt system: the introduction of ARMs and of
delayed amortization (or interest-only period, IO loans) loans.

The incentive to borrow for the purchase of a house, as in Equation (\ref{eq:housing-hh}) above, is
partially driven by interest rates. The available interest rate is then adjusted according to
the weighted average interest rate observed for each of the two groups (flexible and fixed).
The second is the introduction of interest-only periods, as explained in Section \ref{sec:fi-fl-sfc-lit},
the effect of which is to reduce the initial cost of borrowing. Thus as the amount paid on mortgages
per family falls, the incentive to borrow rises.

An alternative is to calculate the interest rate as the total payments made by the
household towards debt, inclusive of amortization payments, as a percentage of total
debt remaining. This alternative is not employed here, but is planned for future research.
Although this would not normally be captured in the interest rate, it
is possible to artificially lower the rate of interest on the flexible rate group in
order to capture this incentive. This is similar for debt with longer term structures,
where monthly costs would reflect the reduced portion allocated to amortization.

Unfortunately, the additional risks factors related to products
with full-term interest-only, or perpetual-interest-only loans would not
be possible to capture in this framework.

The only interest bearing asset held by households in the model is deposits,
which are calculated as the residual effect of transactions in the other assets.
debt and net lending contributing positively, and outflows for equities or pension
investment contributing negatively.

\begin{equation}
IBATR^H_t = NL^H + IBLTR^H_t - EQATR^H_t - PENATR^H_t
\label{eq:ibatr_hh}
\end{equation}

The current stock of each asset is then the sum of the stock from the preceding period,
plus any transactions (positive or negative), plus any capital gains (or losses). The same
is true for all assets and liabilities.

\begin{equation}
IBA^H_t = IBA^H_{t-1} + IBATR^H_t + IBA^H_{CG_t}
\end{equation}

Equities:

\begin{equation}
EQA^H_t = EQA^H_{t-1} + EQATR^H_t + EQA^H_{CG_t}
\end{equation}

Pensions:

\begin{equation}
PENA^H_t = PENA^H_{t-1} + PENATR^H_t + PENA^H_{CG_t}
\end{equation}

Interest bearing liabilities:

\begin{equation}
IBL^H_t = IBL^H_{t-1} + IBLTR^H_t + IBL^H_{CG_t}
\end{equation}

The sum of financial assess (liabilities) provides the total financial assets (liabilities).

\begin{equation}
FA^H_t = IBA^H_t + EQA^H_t + PENA^H_t
\end{equation}

Since the only financial liability for households in this model interest bearing, it makes up the total.

\begin{equation}
FL^H = IBL^H_t
\end{equation}

Net financial wealth is the difference between total assets and liabilities.

\begin{equation}
FNW^H_t = FA^H_t - FL^H_t
\end{equation}

The inclusion of fixed assets provides the total net wealth for each sector, which both in this model and in reality are dominated
by dwellings for the household sector.

\begin{equation}
NW^H_t = FNW^H_t + K^H_t
\end{equation}

This can be deflated to provide wealth at constant prices, where real financial net wealth:

\begin{equation}
fnw^H_t = \frac{FNW^H_t}{P^c_t}
\end{equation}

And, where real wealth, are the result of deflation by the consumption prices index $P^c_t$

\begin{equation}
nw^H_t = \frac{NW^H_t}{P^c_t}
\end{equation}

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

### Financial Corporate Sector {#sec:fi-fl-sfc-model-eq-f}

The financial sector acts as the provider, and thus counterpart of newly created
credit in this model. The financial corporate sector (FC) is comprised of banks,
insurance and pension companies, as well as several services related to the financial
markets. Property income made up just below 75\% of FC inflows, and approximately the same
proportion of outflows in 1995, and falling to just above 50\% in 2017 - with positive
flows higher than negative flows, reflecting the rental income spread extracted by the
sector.

Savings, according to the national accounts can be expressed as the sum of the net
capital income, gross operating surplus ($B2^F_t$) (received), social transfers
($STR^F$) minus taxes paid to the government ($T^F$), and the changes in pension entitlements
($CPEN^F$) paid to the households.

This model adjusts the inflow to FC to take into account the split in debt in the household
sector between flexible and fixed, where the average interest rate on each category is applied
to the outstanding level of fixed or flexible debt respectively.

\begin{equation}
\begin{split}
    S^F_t = & B2^F_t \\
            & + r^F_{A(FI)_{t-1}}(IBA^{F\sim H}_{A(FI)_{t-1}}) + r^F_{A(FL)_{t-1}}(IBA^{F\sim H}_{A(FL)_{t-1}}) \\
            & - r^F_{L_{t-1}}(IBL^{F\sim H}_{L_{t-1}}) + r_{N_{t-1}}(NIB^F_{t-1}) \\
            & + \chi _t(NEQ^F_{t-1}) -\psi _t(PENL^F_{t-1}) - T^F_t + STR^F_t - CPEN^F_t + \epsilon ^F
\end{split}
\end{equation}

Where, $r^F_{A_{t-1}}$, and $r^F_{L_{t-1}}$ are average interest rates on
assets and liabilities where the household sector is the counterpart, this is
noted using the superscript on, for example, interest bearing assets, $IBA^{F\sim H}$,
to indicate that these assets are held by FC and that the counterpart is HH.
$r_{N_{t-1}}$ is a generic rate of return applied toall other interest bearing
assets and liabilities in the form of a net interest bearing ($NIB$) position.

Fixed assets are again determined as the stock of the preceding period,
less depreciation, plus additional investment and capital gains.

\begin{equation}
K^F_t = K^F_{t-1} + I^F_t - D^F_t + K^F_{CG_{t-1}}
\end{equation}

Net lending can be then be expressed as the net savings after taking investment
net sales and acquisitions of fixed property and any capital transfers into account.

\begin{equation}
NL^F_t = S^F_t - I^F_t - NP^F_t + KTR^F_t
\end{equation}

The financial equivalent, financial net lending, takes into account any
transactions in the financial assets and liabilities held by the sector.
Again the superscript denotes the sector, and for $IBA$ and $IBL$, the counterpart
sector.

\begin{equation}
FNL^F_t = IBATR^{F\sim H}_t + NIBTR^F_t + NEQTR^F_t - IBLTR^{F\sim H}_t - PENLTR^F
\end{equation}

In the cases of both $IBATR$ and $IBLTR$, the counterpart sector is HH,
and the values for these flows are by definition equal

\begin{equation}
IBATR^{F\sim H}_t = IBLTR^H_t
\end{equation}

\begin{equation}
IBLTR^{F\sim H}_t = IBATR^H_t
\end{equation}

FC is thus passive to the demands and capacity of HH to borrow in each of these cases.
All other interest bearing transactions are also determined passively from the
transactions in other sectors - where again, the net positions determine the
adjustment required by FC.

\begin{equation}
NIBTR^F_t = -(NIBTR^N_t + NIBTR^G_t+ NIBTR^W_t )
\end{equation}

Again the superscripts on each variable refer to the originating sector,
where $G$ refers to government, $N$ to NFC, $W$ to ROW.

As in the household sector, financial stocks are determined as the closing
value from the preceding period, plus net transactions, plus (less) any capital
gains (losses). This is repeated for the other asset classes.

\begin{equation}
IBA^{F\sim H}_t = IBA^{F\sim H}_{t-1} + IBATR^{F\sim H}_t + IBA^{F\sim H}_{CG_t}
\end{equation}

Although in this model $IBA^{F\sim H}$ is split into fixed $IBA_{FI}^{F\sim H}$ and
flexible $IBA_{FL}^{F\sim H}$ rate products, the accumulation of stocks is calculated
in advance of the split. This ensures stock-flow consistency in a simple fashion, and
still allows the change in property income and expenditure to influence accumulation
over time.

$IBL$ on the other hand is simply the counterpart of the accumulation of
deposits by households.

\begin{equation}
IBL^{F\sim H}_t = IBL^{F\sim H}_{t-1} + IBLTR^{F\sim H}_t + IBL^{F\sim H}_{CG_t}
\end{equation}

The calculation of the stock at the end of the current period follows the simple
standard structure.

\begin{equation}
NIB^F_t = NIB^F_{t-1} + NIBTR^F_t + NIB^F_{CG_t}
\end{equation}

Pension assets include a domestic and relatively small and exogenous international
component, which accumulates to offshore denominated assets.

\begin{equation}
PENLTR^F_t = PENATR^H_t + NPENTR^W
\end{equation}

The equity asset transactions for FC are the residual flow, in that equity
transactions are not modelled directly, but contributes positively or negatively
depending on the relative sizes of $NL^F$, and the transactions in other assets.
FC is fully passive in this regard as all other financial asset and liability components
are equally passive to the behaviours generated in other sectors, as discussed above.

To explain the source of the changes in the value of net equity transactions in FC, we need to refer back to HH. Equation (\ref{eq:ibatr_hh_fc}) is a repeat of Equation (\ref{eq:ibatr_hh}) in the HH section, and is shown here to identify the closure of the model.

\begin{equation}
IBATR^H_t = NL^H + IBLTR^H_t - EQATR^H_t - PENATR^H_t
\label{eq:ibatr_hh_fc}
\end{equation} 

$IBLTR^H_t$, $EQATR^H$ and $PENATR^H$ are all estimated directly, and $NL^H$ is endogenous to the changes in HH income and expenditures. The only component that is not specified as for closure in any other sector is the level of $EQATR^H_t$

The full effect of $IBATR^H$ is also absorbed directly into FC via $IBLTR^{F\sim H}$, which is specified as equal to $IBATR^H$, which includes the value of $EQATR^H$, as captured by Equation (\ref{eq:ibltr_fc}).

\begin{equation}
IBLTR^{F\sim H}_t = IBATR^H_t
\label{eq:ibltr_fc}
\end{equation}

$IBLTR^H$, $PENATR^H$ and $IBATR^H$ are all directly offset in the FC via identities for $IBLTR$, $PENATR$ and $IBATR$, all of which are captured in Equation (\ref{eq:neqtr_fc}). The only financial transaction component that is unaccounted for in the equation is $EQATR^H_t$.

\begin{equation}
NEQTR^F_t = NL^F_t + IBLTR^{F\sim H}_t + PENLTR^F_t - IBATR^{F\sim H}_t - NIBTR^F_t
\label{eq:neqtr_fc}
\end{equation}

Since $NL^F$ is equal to $NIBTR^F$, $NEQTR^F$ is necessarily equal to $EQATR^H$. This is the redundant equation, which, if specified, would cause the model to be over-specified.

Calculating the accumulation of net equity by FC, like $NIB^F$, follows the simple standard method.

\begin{equation}
NEQ^F_t = NEQ^F_{t-1} + NEQTR^F_t + NEQ^F_{CG_t}
\end{equation}

Again, financial net wealth can be calculated as financial assets less liabilities.

\begin{equation}
FNW^F_t = NIB^F_t + NEQ^F_t + IBA^{F\sim H}_t - IBL^{F\sim H}_t - PENL^F_t
\end{equation}

And total net wealth can again be calculated with the inclusion of fixed assets.
FC fixed assets are minor relative to financial assets, with a total of
6\% of GDP in 1995, and falling to 4\% of GDP in 2017.

If desired, these can both be calculated in real terms using the consumption
price index, but the repetition is excluded here for brevity.

\begin{equation}
NW^F_t = FNW^F_t + K^F
\end{equation}


<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

### Government Sector {#sec:fi-fl-sfc-model-eq-GOV}

Denmark has a strong welfare system and as a result, a relatively large public sector (GOV.
Government consumption, made up largely of wages to public sector employees, made up
between 25\% and 30\% of GDP, and social transfers (made up largely of pension and
medical expenditures) contributed a further 15\% to 20\% of GDP between
1995 and 2017. The total expenditure of GOV varied between 58\% and 48\% of
GDP between 1995 and 2017, ending on 50.4\%. Thus, roughly half of total GDP can be attributed
to government expenditures.

The bulk of these expenditures are financed by taxation, although a
relatively small of GOV income is generated from semi-private
enterprises (between 2\% and 3\% of GDP, and roughly 5\% of total
positive GOV flows).

The taxes of all other sectors are combined to calculate total tax revenues.

\begin{equation}
T^G_t = T^N_t + T^H_t + T^F_t + T^W_t
\end{equation}

Social transfers are also combined for all other sectors. The largest
of which are to households via old age and medical categories. Old age
transfers predominantly comprise tax funded pension payments, with the exception
of ATP, a supplementary labour pension, funded by an investment portfolio.

\begin{equation}
STR^G_t = -(STR^H_t + STR^N_t + STR^F_t + STR^W_t )
\end{equation}

Savings can then be calculated from government spending, which as
in @byrialsenraza2019empirical, remains exogenous in this model,
gross operating surplus, interest on net interest bearing stocks,
taxes and social transfers.

\begin{equation}
S^G_t= B2^G_t + r_{N_{t-1}}(NIB^G_{t-1}) + T^G_t+ STR^G_t - G_t + \epsilon ^G
\end{equation}

Government (or public) investment was between 2.6\% and 3.5\% of GDP between
1995 and 2017, and contributes to government capital stock in the same way
as for the other sectors. The on-going stock of capital is then calculated as per the
sections above.

\begin{equation}
K^G_t= K^G_{t-1} + I^G_t- D^G_t+ K^G_{CG_t}
\end{equation}

Net lending is also calculated in the same manner as previously.

\begin{equation}
NL^G_t = S^G_t - I^G_t - NP^G_t + KTR^G_t
\end{equation}

All financial flows in GOV are passively balanced by transactions in the level of net
interest bearing stocks. The assumption here is that any deficit or surplus will be
reflected in a change in these stocks. A deficit will be financed by the issue of debt
and a surplus will finance the redemption thereof.
$NIBTR^G_t$ is thus the barometer of public sector finance effects of any shock.

\begin{equation}
FNL^G_t= NIBTR^G_t
\end{equation}

The financing requirements of government are thus fully captured in $NIBTR^G_t$,
the trigger for any need to finance a deficit or invest surplus funds is the
net financing requirement generated in the real sector, net lending ($NL$).

\begin{equation}
NIBTR^G_t = NL^G_t
\end{equation}

The change in the stock of $NIB$ follows the same pattern as other financial assets
in the previous sectors.

\begin{equation}
NIB^G_t = NIB^G_{t-1} + NIBTR^G_t + NIB_{CG_t}
\end{equation}

This concludes the behavioural equations of GOV.

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

### The rest of the world {#sec:fi-fl-sfc-model-eq-row}

The foreign sector, like GOV, remains unchanged from @byrialsenraza2019empirical.
The model reflects that the Danish economy is small and open, and thus is exposed to
relative price differentials with trading partners. In this model the gap in price
differences is reduced to zero after the date at which the first shock is introduced -
this is a marginal difference from @byrialsenraza2019empirical, but one worth noting.

Because it affects the levels of import and export growth relative to @byrialsenraza2019empirical's
baseline model, there is also an impact on the speed of accumulation of foreign assets.
This is artificially accelerated in their model in order to capture the growth of
foreign sector assets. Although unrealistic in the long run, the mechanism
acts as a buffer in that it eliminates the risk that a shock to interest rates
will unnecessarily complicate relative prices, and that Denmark continues to
maintain a positive trade balance (as appears to be realistic from data).

Imports are estimated in real terms in the log-linear form below.

\begin{equation}
ln(m_t) = \beta _i + \beta _iln \Bigg( \frac{P^y_{t-1}}{P^m_{t-1}} \Bigg) + \beta _iln(c_{t-1} + i_{t-1} + x_{t-1})
\end{equation}

As noted by @byrialsenraza2019empirical [pp. 27], the "export function is based on the
Armington (1969) model where the market share of the Danish exports is explained by
relative prices."

This relation is captured below as annual Danish exports relative to a weighted index
of all trading partners ($m^W_t$), which should be determined by domestic prices
(the export price index, $P^x_t$) relative to foreign prices (the import price
index, $P^m_t$), but moderated by price elasticity ($\beta$).

\begin{equation}
\frac{x_t}{m^W_t} = \Bigg( \frac{P^x_t}{P^m_t}\Bigg)^ \beta
\end{equation}

Some simple algebra allows this relation to be written in log linear form, with
exports as the dependent component.

\begin{equation}
ln(x_t) = \beta _{35} + \beta _{36}ln \Bigg(\frac{P^x_{t-1}}{P^m_{t-1}}\Bigg)  + \beta _{38}ln(m^W_t)
\end{equation}

Both imports and exports can be inflated using their relevant price indices to
for current prices.

\begin{equation}
M_t = m_t(P^m_t )
\end{equation}


\begin{equation}
X_t = x_t(P^x_t)
\end{equation}


In this model, actual prices of imports are expressed as the number one (1),
and export prices are estimated as a function of import prices and unit labour costs.
According to @byrialsenraza2019empirical, this is due to the fact that a large portion
of imports to Denmark are intermediate goods. @Kristoffersen2016 investigated the
effect of effective nominal exchange rate pass-through, and found that while domestic
consumer prices were slow to adjust, the relationship between nominal exchange adjustments
and import prices was stronger but weakening over time[^exchange-pass-through].
The influence on export prices depends more dramatically, however, on the
composition of exports in terms of intermediate imports. @Bo2018 discuss the
complexities in identifying the ultimate trading partners, and suggest the trade
in value added (TiVA) method[^trade-measures], but also point to the source of
value added in Danish exports, where approximately 58\% of export value is generated
outside of the country[^exportvalueadded]. As such, the model allows external price
adjustments to inform part of export prices.

[^exchange-pass-through]: They attribute the decline in
pass-through of exchange movements to the growing relative importance of
the Euro-zone, with which Denmark maintains a fixed exchange rate, together with
increased invoicing in Euros and enhanced global adherence to inflation targeting
monetary policy.

[^trade-measures]: They discuss the alternative interpretations of international trade
in goods, balance of payments in goods, international trade in services, balance
of payments in goods and services, balance of payments in direct exports and trade in
value added by final destination. The relative importance of various trading partners
shifts according to the choice of measure, but Germany, the USA, the UK, Sweden, China,
Norway, France and the Netherlands comprise just over 50\% off all export. Germany the
largest share at 11.1\%.

[^exportvalueadded]: Germany (11.1\%), Norway (10.1\%), US (9.5\%), Russia (8.7\%),
the United Kingdom (7.9\%), Sweden (6.4\%) China (4.3\%), and all others (42\%)

\begin{equation}
ln(P^x_t) = \beta _{39} + \beta _{40}ln(P^m_t) + \beta _{41}ln(ULC_{t-1})
\end{equation}

The savings of the foreign sector (rest of the world, ROW) are expressed from the perspective
of ROW. Thus imports from the model are a revenue for ROW and exports an expenditure.
Net pension flows are either positive or negative, depending on levels of contribution
and disbursements. Interest on $NIB$ and returns on $NEQ$ depend on whether the net stock is positive or
negative, wages and social transfers received are positive, and taxes paid are an expenditure.

\begin{equation}
\begin{split}
S^W_t = & M_t - X_t+\chi _t(NEQ^W_{t-1}) + \psi _t(NPEN^W{t-1})+r_{N_{t-1}}(NIB^W_{t-1}) \\
        & + WB^W_t - T^W_t +STR^W_t +\epsilon ^W
\end{split}
\end{equation}

The rates of return on equities ($\chi _t$) and on pension assets ($\psi _t$) are assumed to be the same as for domestic assets. Danish pension funds invest a large proportion of assets outside of the country, largely as a result of the limited size of the Danish financial markets. As with the previous sectors, net lending can be calculated by taking net acquisitions and disposals of fixed assets, and capital transfers into account. The only difference here being that ROW is assumed not to make investment in Denmark.

\begin{equation}
NL^W_t = S^W_t - NP^W_t + KTR^W
\end{equation}

Net lending is taken to reflect the current account balance for each period.

\begin{equation}
CAB_t = -NL^W_t
\end{equation}

The financial net lending account is again the sum of transactions in net
financial stocks.

\begin{equation}
FNL^W_t = NIBTR^W_t + NEQTR^W_t + NPENTR^W_t
\end{equation}

The present stock of each asset class is again determined by the simple method of
preceding period stock, plus net transactions and capital gains (or less losses).

\begin{equation}
NIB^W_t = NIB^W_{t-1} + NIBTR^W_t + NIB^W_{CG_t}
\end{equation}

\begin{equation}
NEQ^W_t = NEQ^W_{t-1} + NEQTR^W_t + NEQ^W_{CG_t}
\end{equation}

\begin{equation}
NPEN^W_t = NPEN^W_{t-1} + NPENTR^W_t + NPEN^W_{CG_t}
\end{equation}

The residual asset class for ROW is net interest bearing assets,
largely because national liability positions are predominantly
held as international debt.

\begin{equation}
NIBTR^W_t = NL^W_t - NEQTR^W_t - NPENTR^W_t
\end{equation}

Net financial wealth can then be calculated as in the previous
sectors, as the sum of net assets.

\begin{equation}
FNW^W_t = NIB^W_t + NEQ^W_t + NPEN^W
\end{equation}

Since ROW does not own fixed assets, as per the system of
national accounts, net wealth would be identical to financial
net wealth, and is therefore excluded here.

<!-- =================================New Section================================= -->
<!-- =================================New Section================================= -->

### The labour market {#sec:fi-fl-sfc-model-eq-labour}

The final market that must clear in the model is the labour market.
The size of the labour market is determined by the level of demand in
the model, reflecting the Post Keynesian structure. GDP at factor costs
(taken to be total labour costs plus gross operating surplus - profit - for the nation) is
then used to calculate the adjusted wage share, from which the unit labour cost ($ULC$)
is calculated.

\begin{equation}
Y^F_t = WB^N_t + B2_t
\end{equation}

The adjusted wage share can then be calculated as the wage bill relative to $Y^F_t$.

\begin{equation}
WS_t = \frac{WB^N_t}{Y^F_t}
\end{equation}

Finally, $ULC$ is calculated as the ratio between the wage component and total factor costs.

\begin{equation}
ULC_t = \frac{WS_t(Y_t)}{Y^F_t}
\end{equation}

Employment is then determined by the number of persons that are part of the labour force,
but are not employed. Or, the difference between the total labour force ($LF$) and the
number of persons that are employed ($N$).

\begin{equation}
UN_t = LF_t - N_t
\end{equation}

$UN$ as a proportion of $LF$ provides the rate of unemployment.

\begin{equation}
UR_t = \frac{UN_t}{LF_t}
\end{equation}

Employment ($N$) is estimated using actual population data and lagged
real GDP.

\begin{equation}
ln(N_t) = \beta _i + \beta _iln(y_{t-1}) + \beta _iln(LF_t)
\end{equation}

A combination of domestically and foreign employed persons provides the total level
of employment ($N^N_t$)

\begin{equation}
N^N_t = N_t + N^W_t
\end{equation}

Returning to the income of HH, wages ($WB^H$) for domestic employees are a product
of locally employed persons and the local wage rate, which is in-turn estimated
as a negative relation with the rate of unemployment.

\begin{equation}
WB^H_t = W_t(N_t)
\end{equation}

\begin{equation}
W_t = \beta _0 + \beta _iUR_{t-i}
\end{equation}

This reflects falling bargaining power in unions as unemployment rises, but also
the relative over-supply of labour.

The number of foreign employed persons is then calculated as the average wage rate
into the total foreign wage bill.

\begin{equation}
N^W_t = \frac{WB^W_t}{W_t}
\end{equation}

### Lists of variables from the model {#sec:list-of-variables}

```{r variable-names-table_model, as.is=TRUE}
List_of_variables_to_print %>%
  kbl(caption = "List of model variables from equations") %>%
  kable_styling(bootstrap_options = c("striped", "hover"),
                font_size = 10)%>%
  scroll_box(width = "99%", height = "200px")
```
